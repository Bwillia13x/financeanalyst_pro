#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running comprehensive pre-commit quality checks..."
echo "=================================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    printf "${BLUE}[INFO]${NC} %s\n" "$1"
}

print_success() {
    printf "${GREEN}[SUCCESS]${NC} %s\n" "$1"
}

print_error() {
    printf "${RED}[ERROR]${NC} %s\n" "$1"
}

print_warning() {
    printf "${YELLOW}[WARNING]${NC} %s\n" "$1"
}

# Run ESLint - Frontend
print_status "ğŸ“ Checking frontend code quality with ESLint..."
npm run lint
if [ $? -ne 0 ]; then
    print_error "Frontend ESLint failed! Please fix all linting errors before committing."
    print_error "Run 'npm run lint' to see detailed errors."
    print_error "Run 'npm run lint:fix' to auto-fix issues where possible."
    exit 1
fi
print_success "Frontend ESLint passed!"

# Run ESLint - Backend
print_status "ğŸ”§ Checking backend code quality with ESLint..."
cd backend && npm run lint
if [ $? -ne 0 ]; then
    print_error "Backend ESLint failed! Please fix all linting errors before committing."
    print_error "Run 'cd backend && npm run lint' to see detailed errors."
    exit 1
fi
cd ..
print_success "Backend ESLint passed!"

# Run Prettier check
print_status "ğŸ¨ Checking code formatting..."
npm run format:check
if [ $? -ne 0 ]; then
    print_error "Code formatting check failed! Please run 'npm run format' to fix formatting issues."
    exit 1
fi
print_success "Code formatting check passed!"

# Run security audit
print_status "ğŸ”’ Running security audit..."
npm audit --audit-level=moderate
if [ $? -ne 0 ]; then
    print_error "Security vulnerabilities found! Please resolve before committing."
    print_error "Run 'npm audit fix' to attempt automatic fixes."
    exit 1
fi
print_success "Security audit passed!"

echo "=================================================="
print_success "ğŸ‰ All pre-commit quality checks passed!"
print_success "Your code is ready for commit! ğŸš€"
