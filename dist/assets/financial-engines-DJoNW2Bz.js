const e={ERROR:0,WARN:1,INFO:2,DEBUG:3,TRACE:4},t={logLevel:e.INFO,enableMetrics:!0,enablePerformanceTracking:!0,enableErrorTracking:!0,maxLogHistory:1e3,metricsRetentionPeriod:864e5},a=new class{constructor(e={}){this.config={...t,...e},this.logs=[],this.metrics=new Map,this.performanceData=new Map,this.errorCounts=new Map,this.startTime=Date.now()}log(t,a,r={}){if((e[t.toUpperCase()]||e.INFO)<=this.config.logLevel){const e={timestamp:(new Date).toISOString(),level:t.toUpperCase(),message:a,metadata:r,id:this.generateLogId()};this.logs.push(e),this.trimLogs(),this.outputToConsole(e)}}logApiRequest(e,t,a={}){const r=this.generateRequestId(),n=Date.now();return this.log("INFO","ðŸš€ API Request Started",{requestId:r,service:e,endpoint:t,params:this.sanitizeParams(a),startTime:n}),this.performanceData.set(r,{service:e,endpoint:t,startTime:n,params:this.sanitizeParams(a)}),r}logApiResponse(e,t,a=null,r=null){const n=this.performanceData.get(e);if(!n)return void this.log("WARN","No performance data found for request",{requestId:e});const i=Date.now()-n.startTime,{service:s,endpoint:o}=n;t?(this.log("INFO","âœ… API Request Completed",{requestId:e,service:s,endpoint:o,duration:i,responseSize:this.getResponseSize(a),success:!0}),this.recordMetric(s,"success",1)):(this.log("ERROR","âŒ API Request Failed",{requestId:e,service:s,endpoint:o,duration:i,error:r?{message:r.message,code:r.code,status:r.response?.status,statusText:r.response?.statusText}:null,success:!1}),this.recordMetric(s,"error",1),this.recordError(s,r)),this.recordMetric(s,"duration",i),this.recordMetric(s,"requests",1),this.performanceData.delete(e)}logRateLimit(e,t,a=null){this.log("WARN","â±ï¸ Rate Limit Hit",{service:e,waitTime:t,remainingRequests:a,action:"throttling"}),this.recordMetric(e,"rateLimitHits",1)}logCircuitBreaker(e,t,a,r={}){const n={OPEN:"ðŸš¨",HALF_OPEN:"ðŸ”„",CLOSED:"âœ…"}[t]||"ðŸ”§";this.log("WARN",`${n} Circuit Breaker ${a}`,{service:e,state:t,action:a,...r}),this.recordMetric(e,`circuitBreaker_${t.toLowerCase()}`,1)}logCache(e,t,a={}){const r={hit:"ðŸŽ¯",miss:"âŒ",set:"ðŸ’¾",clear:"ðŸ—‘ï¸"}[e]||"ðŸ“¦";this.log("DEBUG",`${r} Cache ${e.toUpperCase()}`,{operation:e,key:this.sanitizeCacheKey(t),...a}),this.recordMetric("cache",e,1)}recordMetric(e,t,a){if(!this.config.enableMetrics)return;const r=`${e}.${t}`,n=Date.now();this.metrics.has(r)||this.metrics.set(r,{values:[],total:0,count:0,min:1/0,max:-1/0,avg:0});const i=this.metrics.get(r);i.values.push({value:a,timestamp:n}),i.total+=a,i.count+=1,i.min=Math.min(i.min,a),i.max=Math.max(i.max,a),i.avg=i.total/i.count,this.cleanOldMetrics(r)}recordError(e,t){if(!this.config.enableErrorTracking||!t)return;const a=`${e}.${t.message}`,r=this.errorCounts.get(a)||0;this.errorCounts.set(a,r+1)}getMetrics(){const e={uptime:Date.now()-this.startTime,totalLogs:this.logs.length,services:{},cache:{},errors:{}};for(const[t,a]of this.metrics.entries()){const[r,n]=t.split(".");"cache"===r?e.cache[n]={total:a.total,count:a.count,avg:a.avg}:(e.services[r]||(e.services[r]={}),e.services[r][n]={total:a.total,count:a.count,min:a.min===1/0?0:a.min,max:a.max===-1/0?0:a.max,avg:a.avg})}for(const[t,a]of this.errorCounts.entries()){const[r,...n]=t.split("."),i=n.join(".");e.errors[r]||(e.errors[r]={}),e.errors[r][i]=a}return e}getRecentLogs(e=100,t=null){let a=[...this.logs];return t&&(a=a.filter(e=>e.level===t.toUpperCase())),a.slice(-e).reverse()}clear(){this.logs=[],this.metrics.clear(),this.performanceData.clear(),this.errorCounts.clear(),this.startTime=Date.now()}generateLogId(){return`log_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateRequestId(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}sanitizeParams(e){const t={...e};return t.apikey&&(t.apikey="***"),t.api_key&&(t.api_key="***"),t.token&&(t.token="***"),t}sanitizeCacheKey(e){return e.length>50?`${e.substring(0,47)}...`:e}getResponseSize(e){if(!e)return 0;try{return JSON.stringify(e).length}catch{return 0}}trimLogs(){this.logs.length>this.config.maxLogHistory&&(this.logs=this.logs.slice(-this.config.maxLogHistory))}cleanOldMetrics(e){const t=this.metrics.get(e),a=Date.now()-this.config.metricsRetentionPeriod;t.values=t.values.filter(e=>e.timestamp>a)}outputToConsole(e){const{level:t,message:a,metadata:r}=e;new Date(e.timestamp).toLocaleTimeString()}},r=new class{constructor(){this.modelCache=new Map,this.assumptions=this.getDefaultAssumptions()}getDefaultAssumptions(){return{dcf:{projectionYears:5,terminalGrowthRate:.025,riskFreeRate:.045,marketPremium:.065,taxRate:.21,capexAsPercentOfRevenue:.03,nwcAsPercentOfRevenue:.05,depreciationAsPercentOfRevenue:.025,normalizedMarginTarget:null,cyclicalAdjustment:!1,industryBeta:1,sizeAdjustment:0,countryRiskPremium:0,liquidityDiscount:0},lbo:{holdingPeriod:5,debtMultiples:{senior:4,subordinated:1.5,total:5.5},interestRates:{senior:.055,subordinated:.095},managementFeeRate:.02,carriedInterestRate:.2,ebitdaGrowthRate:.05,debtPaydownRate:.5},monte_carlo:{iterations:1e4,confidenceIntervals:[.05,.25,.5,.75,.95],correlationMatrix:null}}}buildDCFModel(e,t={}){const{symbol:a,companyName:r,assumptions:n={}}=e,i={...this.assumptions.dcf,...n},s=this.calculateDCFScenario(e,i,"Base Case"),o={};if(!1!==t.bull){const t={...i,revenueGrowthRate:1.3*(i.revenueGrowthRate||.1),terminalGrowthRate:Math.min(1.2*i.terminalGrowthRate,.04),wacc:.9*(i.wacc||.1)};o.bull=this.calculateDCFScenario(e,t,"Bull Case")}if(!1!==t.bear){const t={...i,revenueGrowthRate:.7*(i.revenueGrowthRate||.1),terminalGrowthRate:Math.max(.8*i.terminalGrowthRate,.015),wacc:1.1*(i.wacc||.1)};o.bear=this.calculateDCFScenario(e,t,"Bear Case")}const l=this.performDCFSensitivityAnalysis(e,i);return{symbol:a,companyName:r,modelType:"DCF",timestamp:(new Date).toISOString(),baseCase:s,scenarios:o,sensitivityAnalysis:l,assumptions:i,summary:this.generateDCFSummary(s,o,e.currentPrice)}}calculateWACC(e,t){const{marketCap:a=0,totalDebt:r=0,cash:n=0,beta:i=1,riskFreeRate:s=t.riskFreeRate||.045,marketPremium:o=t.marketPremium||.065,taxRate:l=t.taxRate||.21,costOfDebt:c=t.costOfDebt||.055}=e,u=s+i*o,h=Math.max(0,r-n),m=a+h;if(0===m)return u;const d=a/m*u+h/m*c*(1-l);return Math.max(.02,Math.min(.25,d))}calculateDCFScenario(e,t,a){const{currentRevenue:r,currentPrice:n,sharesOutstanding:i,totalDebt:s=0,cash:o=0}=e;let l=t.wacc;!l&&t.discountRate?l=t.discountRate:l||(l=this.calculateWACC(e,t)),(isNaN(l)||l<=0)&&(l=.1);const c=this.projectRevenues(r,t.revenueGrowthRate||.1,t.projectionYears),u=this.projectOperatingMetrics(c,t),h=this.calculateFreeCashFlows(u,t),m=h[h.length-1]?.unleveredFCF||0,d=this.calculateTerminalValue(m,t.terminalGrowthRate,l),p=h.map(e=>e.unleveredFCF),g=this.calculatePresentValue(p,l),M=this.calculatePresentValue([d],l,t.projectionYears),R=g+M,f=R-s+o,v=i>0?f/i:0;return{scenarioName:a,revenueProjections:c,operatingProjections:u,fcfProjections:h,terminalValue:d,pvOfCashFlows:g,pvOfTerminalValue:M,enterpriseValue:R,equityValue:f,pricePerShare:v,currentPrice:n,upside:n?(v-n)/n*100:null,wacc:l,terminalGrowthRate:t.terminalGrowthRate,impliedMultiples:this.calculateImpliedMultiples(R,u,h,r)}}projectRevenues(e,t,a){const r=[];let n=e;for(let i=0;i<a;i++){const e=Array.isArray(t)?t[i]||t[t.length-1]:t*Math.pow(.95,i);n*=1+e,r.push({year:i+1,revenue:n,growthRate:e})}return r}projectOperatingMetrics(e,t){return e.map((e,a)=>{const r=t.ebitdaMargin||.2,n=e.revenue*r,i=e.revenue*t.depreciationAsPercentOfRevenue,s=n-i,o=s*t.taxRate,l=s-o;return{...e,ebitda:n,ebitdaMargin:r,depreciation:i,ebit:s,taxes:o,nopat:l}})}calculateFreeCashFlows(e,t){return e.map((a,r)=>{const n=a.revenue*(t.maintenanceCapexRate||.015),i=r>0?(a.revenue-e[r-1].revenue)*(t.growthCapexRate||.8):0,s=n+i,o=this.calculateWorkingCapitalChange(a,e[r-1],t),l=a.revenue*(t.stockBasedCompRate||.005),c=a.revenue*(t.otherNonCashRate||.001),u=a.depreciation+l+c,h=a.nopat+u-s-o;return{year:r+1,nopat:a.nopat,depreciation:a.depreciation,stockBasedComp:l,otherNonCash:c,totalNonCash:u,maintenanceCapex:n,growthCapex:i,totalCapex:s,nwcChange:o,unleveredFCF:h,fcfMargin:a.revenue>0?h/a.revenue:0}})}calculateWorkingCapitalChange(e,t,a){if(!t)return e.revenue*a.nwcAsPercentOfRevenue;const r=a.receivablesDays||45,n=a.inventoryDays||30,i=a.payablesDays||35;return e.revenue*r/365+e.revenue*n/365*(a.cogsPct||.6)-e.revenue*i/365*(a.cogsPct||.6)-(t.revenue*r/365+t.revenue*n/365*(a.cogsPct||.6)-t.revenue*i/365*(a.cogsPct||.6))}calculateTerminalValue(e,t,a,r={}){if(a<=t)throw new Error(`Discount rate (${(100*a).toFixed(2)}%) must be greater than terminal growth rate (${(100*t).toFixed(2)}%)`);const{method:n="gordon",exitMultiple:i=null}=r;switch(n){case"gordon":default:return e*(1+t)/(a-t);case"exit_multiple":return i&&e>0?e*i:e*(1+t)/(a-t);case"fade_to_growth":const n=r.fadeYears||5,s=r.longTermGrowth||.025;let o=0;for(let r=1;r<=n;r++){const i=t*Math.pow((n-r+1)/n,2)+s*Math.pow(r/n,2);o+=e*Math.pow(1+i,r)/Math.pow(1+a,r)}return o+=e*Math.pow(1+s,n)/(a-s)/Math.pow(1+a,n),o}}calculatePresentValue(e,t,a=0){return e.reduce((e,r,n)=>{const i=a+n+1;return e+r/Math.pow(1+t,i)},0)}calculateImpliedMultiples(e,t,a=[],r=0){const n=t[0]?.ebitda||0,i=t[1]?.ebitda||0,s=t[0]?.ebit||0,o=t[1]?.ebit||0,l=t[1]?.revenue||0,c=a[0]?.unleveredFCF||0,u=a[1]?.unleveredFCF||0;return{evToCurrentRevenue:r?e/r:null,evToForwardRevenue:l?e/l:null,evToCurrentEbitda:n?e/n:null,evToForwardEbitda:i?e/i:null,evToCurrentEbit:s?e/s:null,evToForwardEbit:o?e/o:null,evToCurrentFCF:c?e/c:null,evToForwardFCF:u?e/u:null,pegRatio:this.calculatePEGRatio(t,e)}}calculatePEGRatio(e,t){if(e.length<2)return null;const a=e[0]?.nopat||0,r=e[e.length-1]?.nopat||0;if(a<=0||r<=0)return null;const n=Math.pow(r/a,1/(e.length-1))-1;return n>0?t/a/(100*n):null}performDCFSensitivityAnalysis(e,t){const a={};return Object.entries({revenueGrowthRate:[-.02,-.01,0,.01,.02],wacc:[-.005,-.0025,0,.0025,.005],terminalGrowthRate:[-.005,-.0025,0,.0025,.005],ebitdaMargin:[-.02,-.01,0,.01,.02]}).forEach(([r,n])=>{a[r]=n.map(a=>{const n={...t,[r]:(t[r]||0)+a};try{const t=this.calculateDCFScenario(e,n,`${r}_${a}`);return{variation:a,pricePerShare:t.pricePerShare,upside:t.upside}}catch(i){return{variation:a,pricePerShare:null,upside:null,error:i.message}}})}),a}generateDCFSummary(e,t,a){const r=[e,...Object.values(t)].map(e=>e.pricePerShare).filter(e=>null!==e);return{priceRange:{min:Math.min(...r),max:Math.max(...r),average:r.reduce((e,t)=>e+t,0)/r.length},recommendation:this.generateRecommendation(e,a),keyMetrics:{baseCase:{pricePerShare:e.pricePerShare,upside:e.upside,enterpriseValue:e.enterpriseValue},currentPrice:a,impliedReturn:e.upside}}}generateRecommendation(e,t){if(!t||!e.pricePerShare)return{rating:"INSUFFICIENT_DATA",confidence:0};const a=e.upside;let r,n;return a>20?(r="STRONG_BUY",n=Math.min(95,70+1.25*(a-20))):a>10?(r="BUY",n=Math.min(85,60+2*(a-10))):a>-10?(r="HOLD",n=Math.min(75,50+2.5*Math.abs(a))):a>-20?(r="SELL",n=Math.min(85,60+2*Math.abs(a+10))):(r="STRONG_SELL",n=Math.min(95,70+1.25*Math.abs(a+20))),{rating:r,confidence:Math.round(n),upside:a,reasoning:this.generateRecommendationReasoning(r,a)}}generateRecommendationReasoning(e,t){const a=Math.abs(t);switch(e){case"STRONG_BUY":return`Strong upside potential of ${t.toFixed(1)}% suggests significant undervaluation based on DCF analysis.`;case"BUY":return`Moderate upside of ${t.toFixed(1)}% indicates the stock is undervalued relative to intrinsic value.`;case"HOLD":return`Fair valuation with ${t>=0?"limited upside":"modest downside"} of ${a.toFixed(1)}%.`;case"SELL":return`Downside risk of ${a.toFixed(1)}% suggests the stock is overvalued based on fundamental analysis.`;case"STRONG_SELL":return`Significant downside of ${a.toFixed(1)}% indicates substantial overvaluation.`;default:return"Insufficient data for reliable recommendation."}}},n=new class{constructor(){this.modelCache=new Map,this.assumptions=this.getDefaultAssumptions()}getDefaultAssumptions(){return{transaction:{holdingPeriod:5,managementRollover:.1,transactionFees:.02,financingFees:.015},debt:{seniorDebtMultiple:4,subordinatedDebtMultiple:1.5,totalDebtMultiple:5.5,seniorInterestRate:.055,subordinatedInterestRate:.095,mandatoryPaydown:.05,cashSweep:.5},operating:{ebitdaGrowthRate:.05,capexAsPercentOfRevenue:.03,nwcAsPercentOfRevenue:.02,taxRate:.21},exit:{exitMultiple:null,exitMultipleRange:[.8,1.2],publicMarketDiscount:.1},fees:{managementFeeRate:.02,carriedInterestRate:.2,hurdle:.08}}}buildLBOModel(e,t={}){const{symbol:a,companyName:r,purchasePrice:n,ebitda:i,assumptions:s={}}=e,o={...this.assumptions,...s},l=this.calculateTransactionStructure(n,i,o),c=this.calculateLBOScenario(e,l,o,"Base Case"),u={};if(!1!==t.upside){const t={...o,operating:{...o.operating,ebitdaGrowthRate:1.3*o.operating.ebitdaGrowthRate},exit:{...o.exit,exitMultiple:1.1*(o.exit.exitMultiple||10)}};u.upside=this.calculateLBOScenario(e,l,t,"Upside Case")}if(!1!==t.downside){const t={...o,operating:{...o.operating,ebitdaGrowthRate:.7*o.operating.ebitdaGrowthRate},exit:{...o.exit,exitMultiple:.9*(o.exit.exitMultiple||10)}};u.downside=this.calculateLBOScenario(e,l,t,"Downside Case")}const h=this.performLBOSensitivityAnalysis(e,l,o);return{symbol:a,companyName:r,modelType:"LBO",timestamp:(new Date).toISOString(),transactionStructure:l,baseCase:c,scenarios:u,sensitivityAnalysis:h,assumptions:o,summary:this.generateLBOSummary(c,u,l)}}calculateTransactionStructure(e,t,a){const{debt:r,transaction:n}=a,i=t*r.seniorDebtMultiple,s=i+t*r.subordinatedDebtMultiple,o=e*n.transactionFees,l=s*n.financingFees,c=e+o+l,u=Math.max(c-s,.2*c),h=e*n.managementRollover,m=Math.max(u-h,0),d=c-u,p=Math.min(i,.8*d);return{purchasePrice:e,transactionFees:o,financingFees:l,totalUses:c,seniorDebt:p,subordinatedDebt:d-p,totalDebt:d,equityContribution:u,sponsorEquity:m,managementRollover:h,debtToEbitda:d/t,equityToTotalCapital:u/c}}calculateLBOScenario(e,t,a,r){const{ebitda:n,revenue:i}=e,{holdingPeriod:s}=a.transaction,o=this.projectLBOOperatingPerformance(i,n,a.operating,s),l=this.calculateDebtSchedule(t,o,a.debt,s),c=this.calculateEquityCashFlows(o,l,a),u=this.calculateExitAnalysis(o[s-1],l[s-1],t,a),h=this.calculateReturnsMetrics(t.sponsorEquity,c,u.netProceeds,s);return{scenarioName:r,operatingProjections:o,debtSchedule:l,equityCashFlows:c,exitAnalysis:u,returnsAnalysis:h,keyMetrics:this.calculateLBOKeyMetrics(t,u,h)}}projectLBOOperatingPerformance(e,t,a,r){const n=[];let i=e,s=t;for(let o=1;o<=r;o++){const e=a.ebitdaGrowthRate;s*=1+e,i*=1+e;const t=s/i,r=i*a.capexAsPercentOfRevenue,l=1===o?i*a.nwcAsPercentOfRevenue:(i-n[o-2].revenue)*a.nwcAsPercentOfRevenue,c=s*a.taxRate,u=s-c-r-l;n.push({year:o,revenue:i,ebitda:s,ebitdaMargin:t,capex:r,nwcChange:l,taxes:c,unleveredFCF:u})}return n}calculateDebtSchedule(e,t,a,r){const n=[];let i=e.seniorDebt,s=e.subordinatedDebt;const o=e.revolvingDebt||0,l=a.revolvingRate||.045,c=a.maxLeverageRatio||6,u=a.minCoverageRatio||1.25,h=a.maxCapexRatio||.05;for(let m=1;m<=r;m++){const r=t[m-1],d=i*a.seniorInterestRate,p=s*a.subordinatedInterestRate,g=d+p,M=r.unleveredFCF-g,R=Math.min(i*a.mandatoryPaydown,i),f=Math.max(0,M-R),v=f*a.cashSweep,b=R+v,w=Math.min(b,i),y=Math.max(0,b-w);i=Math.max(0,i-w),s=Math.max(0,s-y);const C=(i+s+o)/r.ebitda,x=r.ebitda/g,S=(r.capex||0)/r.revenue,F={leverageCompliance:C<=c,coverageCompliance:x>=u,capexCompliance:S<=h,leverageRatio:C,coverageRatio:x,capexRatio:S},D=M/(g+R);n.push({year:m,beginningBalance:{senior:1===m?e.seniorDebt:n[m-2].endingBalance.senior,subordinated:1===m?e.subordinatedDebt:n[m-2].endingBalance.subordinated,revolving:1===m?e.revolvingDebt||0:n[m-2].endingBalance.revolving},interestExpense:{senior:d,subordinated:p,revolving:o*l,total:g+o*l},principalPayment:{senior:w,subordinated:y,revolving:0,total:b},endingBalance:{senior:i,subordinated:s,revolving:o,total:i+s+o},cashAvailableForDebt:M,excessCash:f-v,mandatoryPaydown:R,cashSweep:v,dscr:D,covenantTests:F,netDebtToEbitda:(i+s+o)/r.ebitda,ebitdaToInterest:r.ebitda/g})}return n}calculateEquityCashFlows(e,t,a){return e.map((e,r)=>{const n=t[r],i=a.fees.managementFeeRate*(a.transaction.sponsorEquity||0),s=n.excessCash-i;return{year:e.year,unleveredFCF:e.unleveredFCF,interestExpense:n.interestExpense.total,principalPayment:n.principalPayment.total,managementFees:i,cashFlowToEquity:Math.max(0,s)}})}calculateExitAnalysis(e,t,a,r){const n=r.exit.exitMultiple||10,i=e.ebitda,s=i*n,o=t.endingBalance.total,l=s-o,c=l,u=a.sponsorEquity,h=Math.max(0,c-u)*r.fees.carriedInterestRate;return{exitEbitda:i,exitMultiple:n,enterpriseValue:s,totalDebtAtExit:o,grossProceeds:l,carriedInterest:h,netProceeds:l-h,managementProceeds:l*(a.managementRollover/a.equityContribution)}}calculateReturnsMetrics(e,t,a,r){if(!e||e<=0)return{irr:NaN,moic:NaN,totalCashReturned:0,initialInvestment:e||0,holdingPeriod:r,annualizedReturn:NaN};const n=[-Math.abs(e)];t.forEach(e=>{n.push(e.cashFlowToEquity||0)}),n.length>1?n[n.length-1]+=a||0:n.push(a||0);const i=this.calculateIRR(n),s=t.reduce((e,t)=>e+(t.cashFlowToEquity||0),0)+(a||0),o=s/Math.abs(e);return{irr:isNaN(i)?0:i,moic:isNaN(o)?0:o,totalCashReturned:s,initialInvestment:Math.abs(e),holdingPeriod:r,annualizedReturn:isNaN(o)||o<=0?0:Math.pow(o,1/r)-1,cashFlows:n}}calculateIRR(e,t={}){if(!e||e.length<2)return NaN;if(e.every(e=>0===e))return 0;if(0===e.slice(1).reduce((t,a,r)=>t+(Math.sign(a)!==Math.sign(e[r])?1:0),0))return e[0]<0?-1:1/0;const{tolerance:a=1e-8,maxIterations:r=200,initialGuess:n=.1}=t;let i=this.newtonRaphsonIRR(e,n,a,r);return!isNaN(i)&&isFinite(i)||(i=this.bisectionIRR(e,a,r)),!isNaN(i)&&isFinite(i)||(i=this.secantIRR(e,a,r)),i}newtonRaphsonIRR(e,t,a,r){let n=t;for(let i=0;i<r;i++){let t=0,r=0;for(let a=0;a<e.length;a++){const i=Math.pow(1+n,a);t+=e[a]/i,a>0&&(r-=a*e[a]/(i*(1+n)))}if(Math.abs(t)<a)return n;if(Math.abs(r)<Number.EPSILON)break;const i=n-t/r,s=Math.max(-.99,Math.min(i,50));if(Math.abs(s-n)<a)return s;n=s}return n}bisectionIRR(e,t,a){let r=-.99,n=5,i=this.calculateNPV(e,r),s=this.calculateNPV(e,n);if(i*s>0)return NaN;for(let o=0;o<a;o++){const a=(r+n)/2,o=this.calculateNPV(e,a);if(Math.abs(o)<t)return a;if(i*o<0?(n=a,s=o):(r=a,i=o),Math.abs(n-r)<t)return(r+n)/2}return(r+n)/2}secantIRR(e,t,a){let r=0,n=.1;for(let i=0;i<a;i++){const a=this.calculateNPV(e,r),i=this.calculateNPV(e,n);if(Math.abs(i)<t)return n;if(Math.abs(i-a)<t)break;const s=n-i*(n-r)/(i-a);if(Math.abs(s-n)<t)return s;r=n,n=s}return n}calculateNPV(e,t){return e.reduce((e,a,r)=>e+a/Math.pow(1+t,r),0)}calculateLBOKeyMetrics(e,t,a,r=[]){const n=e.purchasePrice/(e.entryMultiple||10),i=n>0?e.purchasePrice/n:null,s=Math.max(...r.map(e=>e.netDebtToEbitda||0)),o=Math.min(...r.map(e=>e.ebitdaToInterest||1/0)),l=r.length>0?r.reduce((e,t)=>e+(t.dscr||0),0)/r.length:0,c=t.exitMultiple-(i||10),u=a.moic-1-c,h=e.totalDebt/e.equityContribution;return{entryMultiple:i,entryLeverage:e.debtToEbitda,equityContribution:e.equityContribution,debtToEquity:h,exitMultiple:t.exitMultiple,exitLeverage:t.totalDebtAtExit/t.exitEbitda,irr:a.irr,moic:a.moic,totalReturn:a.totalCashReturned,leverageReduction:e.totalDebt-t.totalDebtAtExit,peakLeverage:s,minCoverage:o,avgDSCR:l,multipleExpansion:c,operationalImprovement:u,leverageContribution:h>1?(a.moic-1)*(h-1)/h:0,breakdownLeverage:r.length>0?Math.max(...r.map(e=>e.leverageRatio||0)):null,covenantBreaches:r.filter(e=>e.covenantTests&&(!e.covenantTests.leverageCompliance||!e.covenantTests.coverageCompliance)).length,equityEfficiency:a.totalCashReturned/e.equityContribution,timeToRecoverEquity:this.calculateTimeToRecoverEquity(a.cashFlows,e.equityContribution)}}calculateTimeToRecoverEquity(e,t){if(!e||0===e.length)return null;let a=0;for(let r=1;r<e.length;r++)if(a+=e[r],a>=t)return r;return null}performLBOSensitivityAnalysis(e,t,a){const r={};return Object.entries({ebitdaGrowthRate:[-.02,-.01,0,.01,.02],exitMultiple:[-1,-.5,0,.5,1],debtMultiple:[-.5,-.25,0,.25,.5]}).forEach(([n,i])=>{r[n]=i.map(r=>{const i={...a};"ebitdaGrowthRate"===n?i.operating.ebitdaGrowthRate+=r:"exitMultiple"===n&&(i.exit.exitMultiple=(i.exit.exitMultiple||10)+r);try{const a=this.calculateLBOScenario(e,t,i,`${n}_${r}`);return{variation:r,irr:a.returnsAnalysis.irr,moic:a.returnsAnalysis.moic}}catch(s){return{variation:r,irr:null,moic:null,error:s.message}}})}),r}generateLBOSummary(e,t,a){const r=[e,...Object.values(t)],n=r.map(e=>e.returnsAnalysis.irr).filter(e=>null!==e),i=r.map(e=>e.returnsAnalysis.moic).filter(e=>null!==e);return{returnRange:{irrMin:Math.min(...n),irrMax:Math.max(...n),irrAverage:n.reduce((e,t)=>e+t,0)/n.length,moicMin:Math.min(...i),moicMax:Math.max(...i),moicAverage:i.reduce((e,t)=>e+t,0)/i.length},investmentHighlights:this.generateInvestmentHighlights(e,a),riskFactors:this.generateRiskFactors(e,a)}}generateInvestmentHighlights(e,t){const a=[],r=e.returnsAnalysis.irr,n=e.returnsAnalysis.moic;return r>.2&&a.push(`Strong projected IRR of ${(100*r).toFixed(1)}%`),n>2.5&&a.push(`Attractive multiple of ${n.toFixed(1)}x invested capital`),t.debtToEbitda<5&&a.push(`Conservative leverage at ${t.debtToEbitda.toFixed(1)}x EBITDA`),a}generateRiskFactors(e,t){const a=[];return t.debtToEbitda>6&&a.push(`High leverage at ${t.debtToEbitda.toFixed(1)}x EBITDA`),e.returnsAnalysis.irr<.15&&a.push(`Below-target IRR of ${(100*e.returnsAnalysis.irr).toFixed(1)}%`),a}},i=new class{constructor(){this.workers=[],this.isRunning=!1,this.currentSimulation=null}async runDCFSimulation(e,t,r={}){const{iterations:n=1e4,confidenceLevel:i=.95,correlationMatrix:s=null,randomSeed:o=null}=r;a.log("INFO","Starting DCF Monte Carlo simulation",{iterations:n,variables:Object.keys(t).length}),this.isRunning=!0;const l=Date.now();try{o&&this.setSeed(o);const c=this.generateCorrelatedSamples(t,n,s),u=[],h=r.onProgress;for(let a=0;a<n;a++){if(!this.isRunning)throw new Error("Simulation cancelled");const r=this.createScenarioInputs(e,c[a],t),i=this.calculateDCFScenario(r);u.push({iteration:a+1,pricePerShare:i.pricePerShare,enterpriseValue:i.enterpriseValue,upside:i.upside,inputs:r}),h&&a%Math.floor(n/100)===0&&h(a/n*100)}const m=this.analyzeResults(u,i),d=Date.now();return a.log("INFO","DCF Monte Carlo simulation completed",{iterations:n,duration:d-l,meanPrice:m.statistics.mean}),{type:"DCF_MONTE_CARLO",timestamp:(new Date).toISOString(),parameters:{iterations:n,confidenceLevel:i,randomSeed:o},results:u,analysis:m,duration:d-l}}catch(c){throw this.isRunning=!1,a.log("ERROR","DCF Monte Carlo simulation failed",{error:c.message}),c}finally{this.isRunning=!1}}async runLBOSimulation(e,t,r={}){const{iterations:n=1e4,confidenceLevel:i=.95,correlationMatrix:s=null,randomSeed:o=null}=r;a.log("INFO","Starting LBO Monte Carlo simulation",{iterations:n,variables:Object.keys(t).length}),this.isRunning=!0;const l=Date.now();try{o&&this.setSeed(o);const c=this.generateCorrelatedSamples(t,n,s),u=[],h=r.onProgress;for(let a=0;a<n;a++){if(!this.isRunning)throw new Error("Simulation cancelled");const r=this.createScenarioInputs(e,c[a],t),i=this.calculateLBOScenario(r);u.push({iteration:a+1,irr:i.irr,moic:i.moic,totalReturn:i.totalReturn,inputs:r}),h&&a%Math.floor(n/100)===0&&h(a/n*100)}const m=this.analyzeResults(u,i,["irr","moic","totalReturn"]),d=Date.now();return a.log("INFO","LBO Monte Carlo simulation completed",{iterations:n,duration:d-l,meanIRR:m.statistics.irr?.mean}),{type:"LBO_MONTE_CARLO",timestamp:(new Date).toISOString(),parameters:{iterations:n,confidenceLevel:i,randomSeed:o},results:u,analysis:m,duration:d-l}}catch(c){throw this.isRunning=!1,a.log("ERROR","LBO Monte Carlo simulation failed",{error:c.message}),c}finally{this.isRunning=!1}}generateCorrelatedSamples(e,t,a){const r=Object.keys(e),n=r.length,i=[],s=[];for(let o=0;o<t;o++){const t={};r.forEach(a=>{const r=e[a];t[a]=this.sampleFromDistribution(r)}),s.push(t)}if(a&&a.length===n){const e=this.choleskyDecomposition(a);for(let a=0;a<t;a++){const t={},n=r.map(e=>s[a][e]),o=this.applyCorrelation(n,e);r.forEach((e,a)=>{t[e]=o[a]}),i.push(t)}}else i.push(...s);return i}sampleFromDistribution(e){const{type:t,parameters:a}=e;switch(t){case"normal":return this.normalRandom(a.mean,a.stdDev);case"lognormal":const e=this.normalRandom(a.mu,a.sigma);return Math.exp(e);case"uniform":return a.min+Math.random()*(a.max-a.min);case"triangular":return this.triangularRandom(a.min,a.mode,a.max);case"beta":return this.betaRandom(a.alpha,a.beta);case"exponential":return this.exponentialRandom(a.lambda);case"weibull":return this.weibullRandom(a.shape,a.scale);case"pareto":return this.paretoRandom(a.scale,a.shape);case"student_t":return this.studentTRandom(a.df);case"chi_squared":return this.chiSquaredRandom(a.df);default:throw new Error(`Unsupported distribution type: ${t}`)}}exponentialRandom(e){return-Math.log(1-Math.random())/e}weibullRandom(e,t){const a=Math.random();return t*Math.pow(-Math.log(1-a),1/e)}paretoRandom(e,t){const a=Math.random();return e/Math.pow(a,1/t)}studentTRandom(e){if(e<=0)throw new Error("Degrees of freedom must be positive");const t=this.normalRandom(0,1),a=this.chiSquaredRandom(e);return t/Math.sqrt(a/e)}chiSquaredRandom(e){if(e<=0)throw new Error("Degrees of freedom must be positive");return 2*this.gammaRandom(e/2)}normalRandom(e=0,t=1){if(void 0!==this.spareNormal){const a=this.spareNormal;return this.spareNormal=void 0,a*t+e}const a=Math.random(),r=Math.random(),n=Math.sqrt(-2*Math.log(a))*Math.cos(2*Math.PI*r),i=Math.sqrt(-2*Math.log(a))*Math.sin(2*Math.PI*r);return this.spareNormal=i,n*t+e}triangularRandom(e,t,a){const r=Math.random();return r<(t-e)/(a-e)?e+Math.sqrt(r*(a-e)*(t-e)):a-Math.sqrt((1-r)*(a-e)*(a-t))}betaRandom(e,t){const a=this.gammaRandom(e);return a/(a+this.gammaRandom(t))}gammaRandom(e){if(!(e>=1))return this.gammaRandom(e+1)*Math.pow(Math.random(),1/e);{const t=e-1/3,a=1/Math.sqrt(9*t);for(;;){let e,r;do{e=this.normalRandom(),r=1+a*e}while(r<=0);r*=r*r;const n=Math.random();if(n<1-.0331*e*e*e*e)return t*r;if(Math.log(n)<.5*e*e+t*(1-r+Math.log(r)))return t*r}}}choleskyDecomposition(e){const t=e.length,a=Array(t).fill().map(()=>Array(t).fill(0));for(let r=0;r<t;r++)for(let t=0;t<=r;t++)if(r===t){let r=0;for(let e=0;e<t;e++)r+=a[t][e]*a[t][e];a[t][t]=Math.sqrt(e[t][t]-r)}else{let n=0;for(let e=0;e<t;e++)n+=a[r][e]*a[t][e];a[r][t]=(e[r][t]-n)/a[t][t]}return a}applyCorrelation(e,t){const a=e.length,r=Array(a).fill(0);for(let n=0;n<a;n++)for(let a=0;a<=n;a++)r[n]+=t[n][a]*e[a];return r}createScenarioInputs(e,t,a){const r={...e};return Object.entries(t).forEach(([e,t])=>{const n=a[e];n.applyTo?r[n.applyTo]=t:r[e]=t}),r}calculateDCFScenario(e){const{currentRevenue:t=1e9,revenueGrowthRate:a=.1,fcfMargin:r=.15,wacc:n=.1,terminalGrowthRate:i=.025,sharesOutstanding:s=1e8,currentPrice:o=100}=e;let l=0,c=t;for(let m=1;m<=5;m++)c*=1+a,l+=c*r/Math.pow(1+n,m);const u=l+c*r*(1+i)/(n-i)/Math.pow(1+n,5),h=u/s;return{pricePerShare:h,enterpriseValue:u,upside:(h-o)/o*100}}calculateLBOScenario(e){const{ebitda:t=1e8,ebitdaGrowthRate:a=.05,exitMultiple:r=10,debtMultiple:n=5,holdingPeriod:i=5}=e,s=t*n,o=10*t-s,l=t*Math.pow(1+a,i)*r-.5*s,c=l/o;return{irr:Math.pow(c,1/i)-1,moic:c,totalReturn:l}}analyzeResults(e,t,a=["pricePerShare","enterpriseValue","upside"]){const r={statistics:{},percentiles:{},confidenceIntervals:{},riskMetrics:{},distributionTests:{},correlations:{}};return a.forEach(a=>{const n=e.map(e=>e[a]).filter(e=>null!==e&&!isNaN(e)).sort((e,t)=>e-t);if(0===n.length)return;const i=n.reduce((e,t)=>e+t,0)/n.length,s=n.reduce((e,t)=>e+Math.pow(t-i,2),0)/n.length,o=Math.sqrt(s),l=Math.sqrt(s*n.length/(n.length-1));r.statistics[a]={mean:i,median:this.percentile(n,.5),mode:this.calculateMode(n),stdDev:o,sampleStdDev:l,variance:s,min:n[0],max:n[n.length-1],range:n[n.length-1]-n[0],count:n.length,trimmedMean:this.calculateTrimmedMean(n,.1),mad:this.calculateMAD(n),iqr:this.percentile(n,.75)-this.percentile(n,.25)},r.percentiles[a]={p1:this.percentile(n,.01),p5:this.percentile(n,.05),p10:this.percentile(n,.1),p25:this.percentile(n,.25),p50:this.percentile(n,.5),p75:this.percentile(n,.75),p90:this.percentile(n,.9),p95:this.percentile(n,.95),p99:this.percentile(n,.99)};const c=1-t,u=this.percentile(n,c/2),h=this.percentile(n,1-c/2);r.confidenceIntervals[a]={level:t,lowerBound:u,upperBound:h,width:h-u,bootstrapCI:this.calculateBootstrapCI(n,t)};const m=this.percentile(n,.05),d=this.percentile(n,.01),p=n.slice(0,Math.floor(.05*n.length)).reduce((e,t)=>e+t,0)/Math.floor(.05*n.length),g=n.slice(0,Math.floor(.01*n.length)).reduce((e,t)=>e+t,0)/Math.floor(.01*n.length);r.riskMetrics[a]={var95:m,var99:d,cvar95:p,cvar99:g,skewness:this.calculateSkewness(n,i,o),kurtosis:this.calculateKurtosis(n,i,o),excessKurtosis:this.calculateKurtosis(n,i,o)-3,expectedShortfall:p,maxDrawdown:this.calculateMaxDrawdown(n),sharpeRatio:this.calculateSharpeRatio(n,.02),sortinoRatio:this.calculateSortinoRatio(n,i)},r.distributionTests[a]={jarqueBera:this.jarqueBeraTest(n),kolmogorovSmirnov:this.ksTestNormality(n),shapiroWilk:n.length<=5e3?this.shapiroWilkTest(n):null}}),a.length>1&&(r.correlations=this.calculateCorrelationMatrix(e,a)),r}calculateMode(e){const t={};e.forEach(e=>{const a=Math.round(100*e)/100;t[a]=(t[a]||0)+1});const a=Math.max(...Object.values(t)),r=Object.keys(t).filter(e=>t[e]===a);return 1===r.length?parseFloat(r[0]):null}calculateTrimmedMean(e,t=.1){const a=Math.floor(e.length*t),r=e.slice(a,-a||void 0);return r.reduce((e,t)=>e+t,0)/r.length}calculateMAD(e){const t=this.percentile(e,.5),a=e.map(e=>Math.abs(e-t)).sort((e,t)=>e-t);return this.percentile(a,.5)}calculateBootstrapCI(e,t,a=1e3){const r=[];for(let i=0;i<a;i++){const t=[];for(let a=0;a<e.length;a++)t.push(e[Math.floor(Math.random()*e.length)]);r.push(t.reduce((e,t)=>e+t,0)/t.length)}r.sort((e,t)=>e-t);const n=1-t;return{lowerBound:this.percentile(r,n/2),upperBound:this.percentile(r,1-n/2)}}calculateMaxDrawdown(e){let t=e[0],a=0;for(const r of e){r>t&&(t=r);const e=(t-r)/t;e>a&&(a=e)}return a}calculateSharpeRatio(e,t=.02){const a=e.reduce((e,t)=>e+t,0)/e.length,r=e.reduce((e,t)=>e+Math.pow(t-a,2),0)/e.length,n=Math.sqrt(r);return n>0?(a-t)/n:0}calculateSortinoRatio(e,t){const a=e.map(e=>e-t),r=a.filter(e=>e<0);if(0===r.length)return 1/0;const n=Math.sqrt(r.reduce((e,t)=>e+t*t,0)/r.length),i=a.reduce((e,t)=>e+t,0)/a.length;return n>0?i/n:0}jarqueBeraTest(e){const t=e.length,a=e.reduce((e,t)=>e+t,0)/t,r=e.reduce((e,t)=>e+Math.pow(t-a,2),0)/t,n=Math.sqrt(r),i=this.calculateSkewness(e,a,n),s=this.calculateKurtosis(e,a,n),o=t/6*(Math.pow(i,2)+Math.pow(s-3,2)/4),l=1-this.chiSquaredCDF(o,2);return{statistic:o,pValue:l,isNormal:l>.05}}chiSquaredCDF(e,t){return e<=0?0:this.incompleteGamma(t/2,e/2)}incompleteGamma(e,t){return t<=0?0:e<=0?NaN:t<e+1?this.incompleteGammaLowerSeries(e,t):1-this.incompleteGammaUpperContinuedFraction(e,t)}incompleteGammaLowerSeries(e,t){const a=this.logGamma(e);let r=1/e,n=r;for(let i=1;i<=200&&(n*=t/(e+i),r+=n,!(Math.abs(n)<1e-15*Math.abs(r)));i++);return r*Math.exp(-t+e*Math.log(t)-a)}incompleteGammaUpperContinuedFraction(e,t){const a=this.logGamma(e),r=1e-300;let n=t+1-e,i=1/r,s=1/n,o=s;for(let l=1;l<=200;l++){const t=-l*(l-e);n+=2,s=t*s+n,Math.abs(s)<r&&(s=r),i=n+t/i,Math.abs(i)<r&&(i=r),s=1/s;const a=s*i;if(o*=a,Math.abs(a-1)<1e-14)break}return Math.exp(-t+e*Math.log(t)-a)*o}logGamma(e){const t=[76.18009172947146,-86.50532032941678,24.01409824083091,-1.231739572450155,.001208650973866179,-5395239384953e-18];let a=0,r=1.000000000190015,n=e,i=n=e,s=e+5.5;for(s-=(e+.5)*Math.log(s);a<6;a++)r+=t[a]/++i;return-s+Math.log(2.5066282746310007*r/n)}ksTestNormality(e){const t=e.length,a=e.reduce((e,t)=>e+t,0)/t,r=e.reduce((e,t)=>e+Math.pow(t-a,2),0)/t,n=Math.sqrt(r);let i=0;for(let o=0;o<t;o++){const r=(o+1)/t,s=this.normalCDF((e[o]-a)/n),l=Math.abs(r-s);l>i&&(i=l)}const s=1.36/Math.sqrt(t);return{statistic:i,critical:s,isNormal:i<s}}normalCDF(e){return.5*(1+this.erf(e/Math.sqrt(2)))}erf(e){const t=e<0?-1:1,a=1/(1+.3275911*(e=Math.abs(e)));return t*(1-((((1.061405429*a-1.453152027)*a+1.421413741)*a-.284496736)*a+.254829592)*a*Math.exp(-e*e))}shapiroWilkTest(e){const t=e.length;if(t<3||t>5e3)return null;const a=[...e].sort((e,t)=>e-t),r=e.reduce((e,t)=>e+t,0)/t;let n=0;for(let s=0;s<t;s++)n+=Math.pow(a[s]-r,2);const i=0/n;return{statistic:i,isNormal:i>.9}}calculateCorrelationMatrix(e,t){const a={};for(let r=0;r<t.length;r++){a[t[r]]={};for(let n=0;n<t.length;n++)if(r===n)a[t[r]][t[n]]=1;else{const i=e.map(e=>e[t[r]]).filter(e=>null!==e&&!isNaN(e)),s=e.map(e=>e[t[n]]).filter(e=>null!==e&&!isNaN(e));a[t[r]][t[n]]=this.calculateCorrelation(i,s)}}return a}calculateCorrelation(e,t){if(e.length!==t.length||0===e.length)return 0;const a=e.length,r=e.reduce((e,t)=>e+t,0)/a,n=t.reduce((e,t)=>e+t,0)/a;let i=0,s=0,o=0;for(let c=0;c<a;c++){const a=e[c]-r,l=t[c]-n;i+=a*l,s+=a*a,o+=l*l}const l=Math.sqrt(s*o);return l>0?i/l:0}percentile(e,t){const a=t*(e.length-1),r=Math.floor(a),n=Math.ceil(a),i=a-r;return r===n?e[r]:e[r]*(1-i)+e[n]*i}calculateSkewness(e,t,a){const r=e.length;return r/((r-1)*(r-2))*e.reduce((e,r)=>e+Math.pow((r-t)/a,3),0)}calculateKurtosis(e,t,a){const r=e.length;return r*(r+1)/((r-1)*(r-2)*(r-3))*e.reduce((e,r)=>e+Math.pow((r-t)/a,4),0)-3*Math.pow(r-1,2)/((r-2)*(r-3))}setSeed(e){this.seed=e,this.random=()=>(this.seed=(9301*this.seed+49297)%233280,this.seed/233280),Math.random=this.random}stopSimulation(){this.isRunning=!1}isSimulationRunning(){return this.isRunning}};export{a,r as f,n as l,i as m};
//# sourceMappingURL=financial-engines-DJoNW2Bz.js.map
