import{j as e,I as t}from"./index-8KefKroJ.js";import{r as a}from"./react-vendor-BaLqnLcQ.js";import{B as n}from"./Button-Q7NhVkF5.js";import{H as s}from"./Header-DEYHApT6.js";import{d as r}from"./dataFetching-BV_9doRC.js";import{f as i,a as o,b as c,c as l,d,e as m,g as u}from"./defaultFinancialData-BqNGcy_-.js";import"./ui-vendor-DJAXjf_-.js";import"./charts-vendor-sFhs1sQW.js";import"./utils-vendor-Cj_bvvWu.js";import"./data-vendor-DpIj8wd6.js";import"./lboModelingEngine-DSAML38E.js";const p=({calculations:s,errors:r,warnings:i})=>{const[o,c]=a.useState("calculations"),[l,d]=a.useState(new Set),[m,u]=a.useState("all"),p={calculations:[{id:1,timestamp:new Date(Date.now()-3e5),type:"calculation",operation:"DCF Valuation",formula:"NPV(FCFF_2024:2028, WACC)",result:2547.5,inputs:{FCFF_2024:187.5,FCFF_2025:206.3,FCFF_2026:226.9,FCFF_2027:249.6,FCFF_2028:274.6,WACC:.098},executionTime:.045,status:"success"},{id:2,timestamp:new Date(Date.now()-6e5),type:"calculation",operation:"WACC Calculation",formula:"WACC(cost_equity, cost_debt, tax_rate, debt_ratio)",result:.098,inputs:{cost_equity:.123,cost_debt:.045,tax_rate:.25,debt_ratio:.4},executionTime:.012,status:"success"},{id:3,timestamp:new Date(Date.now()-9e5),type:"calculation",operation:"Terminal Value",formula:"TERMINAL_VALUE(FCF_final, terminal_growth, WACC)",result:1247.3,inputs:{FCF_final:274.6,terminal_growth:.025,WACC:.098},executionTime:.008,status:"success"}],errors:[{id:1,timestamp:new Date(Date.now()-12e5),type:"error",severity:"high",message:"Division by zero in WACC calculation",formula:"WACC(cost_equity, cost_debt, tax_rate, debt_ratio)",location:"Cell B15",suggestion:"Ensure debt_ratio is not equal to 1.0",resolved:!0}],warnings:[{id:1,timestamp:new Date(Date.now()-18e4),type:"warning",severity:"medium",message:"Beta coefficient (1.15) is above industry average (0.95)",formula:"CAPM(risk_free, beta, market_premium)",location:"Assumptions",suggestion:"Consider reviewing beta calculation or using industry average",acknowledged:!1},{id:2,timestamp:new Date(Date.now()-42e4),type:"warning",severity:"low",message:"Terminal growth rate (2.5%) close to discount rate component",formula:"TERMINAL_VALUE(FCF_final, terminal_growth, WACC)",location:"Terminal Value",suggestion:"Ensure terminal growth rate is reasonable for long-term GDP growth",acknowledged:!0}],validations:[{id:1,timestamp:new Date(Date.now()-6e4),type:"validation",check:"Circular Reference Check",status:"passed",details:"No circular references detected in model"},{id:2,timestamp:new Date(Date.now()-12e4),type:"validation",check:"Balance Sheet Check",status:"passed",details:"Assets = Liabilities + Equity for all projection years"},{id:3,timestamp:new Date(Date.now()-24e4),type:"validation",check:"Cash Flow Consistency",status:"warning",details:"Minor rounding differences in cash flow statements (<$0.1M)"}]},h=[{id:"calculations",label:"Calculations",icon:"Calculator",count:p.calculations.length},{id:"errors",label:"Errors",icon:"XCircle",count:p.errors.length},{id:"warnings",label:"Warnings",icon:"AlertTriangle",count:p.warnings.length},{id:"validations",label:"Validations",icon:"CheckCircle",count:p.validations.length}],g=e=>{switch(e){case"success":case"passed":return{icon:"CheckCircle",color:"text-success"};case"error":return{icon:"XCircle",color:"text-destructive"};case"warning":return{icon:"AlertTriangle",color:"text-warning"};default:return{icon:"Info",color:"text-muted-foreground"}}},y=e=>{switch(e){case"high":return"text-destructive bg-destructive/10";case"medium":return"text-warning bg-warning/10";default:return"text-muted-foreground bg-muted"}},f=()=>e.jsx("div",{className:"space-y-3",children:p.calculations.map(a=>{return e.jsxs("div",{className:"p-4 bg-background border border-border rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(t,{name:"Calculator",size:16,className:"text-primary"}),e.jsx("span",{className:"font-medium text-foreground",children:a.operation}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${g(a.status).color} bg-current/10`,children:a.status})]}),e.jsx("code",{className:"text-sm bg-muted px-2 py-1 rounded font-mono text-foreground block mb-2",children:a.formula}),e.jsxs("div",{className:"flex items-center space-x-4 text-xs text-muted-foreground",children:[e.jsx("span",{children:a.timestamp.toLocaleTimeString()}),e.jsxs("span",{children:["Execution: ",(s=a.executionTime,s<.001?"<1ms":s<1?`${(1e3*s).toFixed(0)}ms`:`${s.toFixed(2)}s`)]}),e.jsxs("span",{children:["Result: $",a.result.toFixed(2),"M"]})]})]}),e.jsx(n,{variant:"ghost",size:"sm",iconName:l.has(a.id)?"ChevronUp":"ChevronDown",onClick:()=>(e=>{const t=new Set(l);t.has(e)?t.delete(e):t.add(e),d(t)})(a.id)})]}),l.has(a.id)&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-border",children:[e.jsx("h5",{className:"text-sm font-medium text-foreground mb-2",children:"Input Values"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries(a.inputs).map(([t,a])=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[t,":"]}),e.jsx("span",{className:"text-foreground font-mono",children:"number"==typeof a?a.toFixed(3):a})]},t))})]})]},a.id);var s})});return e.jsxs("div",{className:"flex flex-col h-full bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(t,{name:"FileText",size:20,className:"text-primary"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Audit Trail"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(n,{variant:"outline",size:"sm",iconName:"Download",children:"Export Log"}),e.jsx(n,{variant:"outline",size:"sm",iconName:"RefreshCw",children:"Refresh"})]})]}),e.jsx("div",{className:"flex border-b border-border overflow-x-auto",children:h.map(a=>e.jsxs("button",{onClick:()=>c(a.id),className:"flex items-center space-x-2 px-4 py-3 text-sm font-medium whitespace-nowrap transition-smooth "+(o===a.id?"bg-primary text-primary-foreground border-b-2 border-primary":"text-muted-foreground hover:text-foreground hover:bg-muted"),children:[e.jsx(t,{name:a.icon,size:16}),e.jsx("span",{children:a.label}),a.count>0&&e.jsx("span",{className:"px-2 py-1 bg-current/20 rounded-full text-xs",children:a.count})]},a.id))}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:(()=>{switch(o){case"calculations":default:return f();case"errors":return e.jsx("div",{className:"space-y-3",children:p.errors.map(a=>e.jsx("div",{className:"p-4 bg-background border border-destructive/20 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(t,{name:"XCircle",size:16,className:"text-destructive mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:a.message}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${y(a.severity)}`,children:a.severity}),a.resolved&&e.jsx("span",{className:"px-2 py-1 rounded-full text-xs text-success bg-success/10",children:"Resolved"})]}),e.jsx("code",{className:"text-sm bg-muted px-2 py-1 rounded font-mono text-foreground block mb-2",children:a.formula}),e.jsxs("div",{className:"text-sm text-muted-foreground mb-2",children:["Location: ",a.location]}),e.jsxs("div",{className:"text-sm text-foreground bg-muted/50 p-2 rounded",children:[e.jsx("strong",{children:"Suggestion:"})," ",a.suggestion]}),e.jsx("div",{className:"text-xs text-muted-foreground mt-2",children:a.timestamp.toLocaleString()})]})]})},a.id))});case"warnings":return e.jsx("div",{className:"space-y-3",children:p.warnings.map(a=>e.jsx("div",{className:"p-4 bg-background border border-warning/20 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(t,{name:"AlertTriangle",size:16,className:"text-warning mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:a.message}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${y(a.severity)}`,children:a.severity}),a.acknowledged&&e.jsx("span",{className:"px-2 py-1 rounded-full text-xs text-muted-foreground bg-muted",children:"Acknowledged"})]}),e.jsx("code",{className:"text-sm bg-muted px-2 py-1 rounded font-mono text-foreground block mb-2",children:a.formula}),e.jsxs("div",{className:"text-sm text-muted-foreground mb-2",children:["Location: ",a.location]}),e.jsxs("div",{className:"text-sm text-foreground bg-muted/50 p-2 rounded",children:[e.jsx("strong",{children:"Suggestion:"})," ",a.suggestion]}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:a.timestamp.toLocaleString()}),!a.acknowledged&&e.jsx(n,{variant:"outline",size:"sm",children:"Acknowledge"})]})]})]})},a.id))});case"validations":return e.jsx("div",{className:"space-y-3",children:p.validations.map(a=>e.jsx("div",{className:"p-4 bg-background border border-border rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(t,{name:g(a.status).icon,size:16,className:`${g(a.status).color} mt-0.5`}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:a.check}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${g(a.status).color} bg-current/10`,children:a.status})]}),e.jsx("div",{className:"text-sm text-muted-foreground mb-2",children:a.details}),e.jsx("div",{className:"text-xs text-muted-foreground",children:a.timestamp.toLocaleString()})]})]})},a.id))})}})()}),e.jsx("div",{className:"p-4 border-t border-border bg-muted/50",children:e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("span",{children:["Last updated: ",(new Date).toLocaleTimeString()]}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:"Auto-refresh: ON"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-2 h-2 bg-success rounded-full"}),e.jsx("span",{children:"Audit logging active"})]})]})})]})},h=({results:s,onExport:r})=>{const[i,o]=a.useState("summary"),[c,l]=a.useState(new Set(["valuation"])),d={summary:{enterpriseValue:2847.5,equityValue:2547.5,sharePrice:127.38,impliedReturn:.156,confidence:.87},cashFlows:[{year:2024,revenue:1250,ebitda:312.5,fcf:187.5,pv:170.5},{year:2025,revenue:1375,ebitda:343.8,fcf:206.3,pv:172.8},{year:2026,revenue:1513,ebitda:378.2,fcf:226.9,pv:175.2},{year:2027,revenue:1664,ebitda:416,fcf:249.6,pv:177.7},{year:2028,revenue:1830,ebitda:457.6,fcf:274.6,pv:180.3}],sensitivity:{wacc:[.08,.09,.1,.11,.12],growth:[.015,.02,.025,.03,.035],matrix:[[145.2,138.7,132.8,127.4,122.5],[152.1,144.9,138.2,132.1,126.4],[159.8,151.9,144.6,137.8,131.6],[168.4,159.7,151.8,144.4,137.6],[178.1,168.4,159.7,151.8,144.4]]},scenarios:[{name:"Base Case",probability:.6,sharePrice:127.38,irr:.156},{name:"Bull Case",probability:.25,sharePrice:145.67,irr:.189},{name:"Bear Case",probability:.15,sharePrice:98.42,irr:.087}],multiples:[{metric:"EV/Revenue",current:2.3,peer_avg:2.8,premium:-17.9},{metric:"EV/EBITDA",current:9.1,peer_avg:11.2,premium:-18.8},{metric:"P/E Ratio",current:18.5,peer_avg:22.1,premium:-16.3},{metric:"P/B Ratio",current:2.1,peer_avg:2.6,premium:-19.2}]},m=(e,t=2)=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:t,maximumFractionDigits:t}).format(e),u=(e,t=1)=>`${(100*e).toFixed(t)}%`,p=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Enterprise Value"}),e.jsx(t,{name:"Building",size:16,className:"text-muted-foreground"})]}),e.jsx("div",{className:"mt-2",children:e.jsxs("span",{className:"text-2xl font-bold text-foreground",children:[m(d.summary.enterpriseValue,1),"M"]})})]}),e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Equity Value"}),e.jsx(t,{name:"PieChart",size:16,className:"text-muted-foreground"})]}),e.jsx("div",{className:"mt-2",children:e.jsxs("span",{className:"text-2xl font-bold text-foreground",children:[m(d.summary.equityValue,1),"M"]})})]}),e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Share Price"}),e.jsx(t,{name:"DollarSign",size:16,className:"text-muted-foreground"})]}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"text-2xl font-bold text-foreground",children:m(d.summary.sharePrice)})})]}),e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Implied Return"}),e.jsx(t,{name:"TrendingUp",size:16,className:"text-success"})]}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"text-2xl font-bold text-success",children:u(d.summary.impliedReturn)})})]})]}),e.jsxs("div",{className:"p-4 bg-background border border-border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-sm font-medium text-foreground",children:"Model Confidence"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:u(d.summary.confidence)})]}),e.jsx("div",{className:"w-full bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-success h-2 rounded-full transition-all duration-300",style:{width:100*d.summary.confidence+"%"}})}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Based on data quality, assumption validity, and sensitivity analysis"})]})]});return e.jsxs("div",{className:"flex flex-col h-full bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(t,{name:"Calculator",size:20,className:"text-primary"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Calculation Results"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(n,{variant:"outline",size:"sm",iconName:"Download",onClick:()=>r&&r("excel"),children:"Export"}),e.jsx(n,{variant:"outline",size:"sm",iconName:"Share2",children:"Share"})]})]}),e.jsx("div",{className:"flex border-b border-border overflow-x-auto",children:[{id:"summary",label:"Summary",icon:"BarChart3"},{id:"cashflows",label:"Cash Flows",icon:"TrendingUp"},{id:"sensitivity",label:"Sensitivity",icon:"Target"},{id:"scenarios",label:"Scenarios",icon:"GitBranch"},{id:"multiples",label:"Multiples",icon:"Layers"}].map(a=>e.jsxs("button",{onClick:()=>o(a.id),className:"flex items-center space-x-2 px-4 py-3 text-sm font-medium whitespace-nowrap transition-smooth "+(i===a.id?"bg-primary text-primary-foreground border-b-2 border-primary":"text-muted-foreground hover:text-foreground hover:bg-muted"),children:[e.jsx(t,{name:a.icon,size:16}),e.jsx("span",{children:a.label})]},a.id))}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:(()=>{switch(i){case"summary":default:return p();case"cashflows":return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-left py-2 text-muted-foreground font-medium",children:"Year"}),e.jsx("th",{className:"text-right py-2 text-muted-foreground font-medium",children:"Revenue"}),e.jsx("th",{className:"text-right py-2 text-muted-foreground font-medium",children:"EBITDA"}),e.jsx("th",{className:"text-right py-2 text-muted-foreground font-medium",children:"FCF"}),e.jsx("th",{className:"text-right py-2 text-muted-foreground font-medium",children:"Present Value"})]})}),e.jsx("tbody",{children:d.cashFlows.map((t,a)=>e.jsxs("tr",{className:"border-b border-border/50",children:[e.jsx("td",{className:"py-3 text-foreground font-medium",children:t.year}),e.jsxs("td",{className:"py-3 text-right text-foreground",children:[m(t.revenue,0),"M"]}),e.jsxs("td",{className:"py-3 text-right text-foreground",children:[m(t.ebitda,1),"M"]}),e.jsxs("td",{className:"py-3 text-right text-foreground",children:[m(t.fcf,1),"M"]}),e.jsxs("td",{className:"py-3 text-right text-success font-medium",children:[m(t.pv,1),"M"]})]},a))})]})}),e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-foreground",children:"Terminal Value"}),e.jsxs("span",{className:"text-lg font-bold text-foreground",children:[m(1247.3,1),"M"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"2.5% perpetual growth rate applied to 2028 FCF"})]})]});case"sensitivity":return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-sm font-medium text-foreground mb-2",children:"Share Price Sensitivity Analysis"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"WACC vs Terminal Growth Rate"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left text-muted-foreground",children:"WACC \\ Growth"}),d.sensitivity.growth.map((t,a)=>e.jsx("th",{className:"p-2 text-center text-muted-foreground",children:u(t)},a))]})}),e.jsx("tbody",{children:d.sensitivity.wacc.map((t,a)=>e.jsxs("tr",{className:"border-t border-border/50",children:[e.jsx("td",{className:"p-2 text-muted-foreground font-medium",children:u(t)}),d.sensitivity.matrix[a].map((t,a)=>e.jsx("td",{className:"p-2 text-center font-medium "+(Math.abs(t-127.38)<5?"bg-primary/20 text-primary":"text-foreground"),children:m(t)},a))]},a))})]})})]});case"scenarios":return e.jsx("div",{className:"space-y-4",children:d.scenarios.map((t,a)=>e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:t.name}),e.jsxs("span",{className:"text-xs bg-background px-2 py-1 rounded text-muted-foreground",children:[u(t.probability)," probability"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-lg font-bold text-foreground",children:m(t.sharePrice)}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[u(t.irr)," IRR"]})]})]}),e.jsx("div",{className:"w-full bg-background rounded-full h-1",children:e.jsx("div",{className:"bg-primary h-1 rounded-full",style:{width:100*t.probability+"%"}})})]},a))});case"multiples":return e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-left py-2 text-muted-foreground font-medium",children:"Multiple"}),e.jsx("th",{className:"text-right py-2 text-muted-foreground font-medium",children:"Current"}),e.jsx("th",{className:"text-right py-2 text-muted-foreground font-medium",children:"Peer Avg"}),e.jsx("th",{className:"text-right py-2 text-muted-foreground font-medium",children:"Premium/Discount"})]})}),e.jsx("tbody",{children:d.multiples.map((t,a)=>e.jsxs("tr",{className:"border-b border-border/50",children:[e.jsx("td",{className:"py-3 text-foreground font-medium",children:t.metric}),e.jsxs("td",{className:"py-3 text-right text-foreground",children:[t.current,"x"]}),e.jsxs("td",{className:"py-3 text-right text-foreground",children:[t.peer_avg,"x"]}),e.jsxs("td",{className:"py-3 text-right font-medium "+(t.premium>0?"text-success":"text-destructive"),children:[t.premium>0?"+":"",t.premium.toFixed(1),"%"]})]},a))})]})})})}})()}),e.jsx("div",{className:"p-4 border-t border-border bg-muted/50",children:e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("span",{children:["Last Updated: ",(new Date).toLocaleTimeString()]}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:"Auto-refresh: ON"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-2 h-2 bg-success rounded-full"}),e.jsx("span",{children:"Calculations current"})]})]})})]})},g=({onFormulaCreate:s,variables:r})=>{const[i,o]=a.useState("valuation"),[c,l]=a.useState(null),[d,m]=a.useState(""),[u,p]=a.useState(""),[h,g]=a.useState(!1),y=a.useRef(null),f={valuation:{name:"Valuation",icon:"TrendingUp",functions:[{name:"DCF",syntax:"DCF(fcf_array, discount_rate, terminal_growth)",description:"Discounted Cash Flow valuation"},{name:"NPV",syntax:"NPV(cash_flows, discount_rate)",description:"Net Present Value calculation"},{name:"IRR",syntax:"IRR(cash_flows)",description:"Internal Rate of Return"},{name:"TERMINAL_VALUE",syntax:"TERMINAL_VALUE(final_fcf, growth_rate, discount_rate)",description:"Terminal value calculation"},{name:"WACC",syntax:"WACC(cost_equity, cost_debt, tax_rate, debt_ratio)",description:"Weighted Average Cost of Capital"}]},financial:{name:"Financial Ratios",icon:"Calculator",functions:[{name:"ROE",syntax:"ROE(net_income, shareholders_equity)",description:"Return on Equity"},{name:"ROA",syntax:"ROA(net_income, total_assets)",description:"Return on Assets"},{name:"DEBT_TO_EQUITY",syntax:"DEBT_TO_EQUITY(total_debt, total_equity)",description:"Debt to Equity ratio"},{name:"CURRENT_RATIO",syntax:"CURRENT_RATIO(current_assets, current_liabilities)",description:"Current ratio calculation"},{name:"QUICK_RATIO",syntax:"QUICK_RATIO(quick_assets, current_liabilities)",description:"Quick ratio calculation"}]},statistical:{name:"Statistical",icon:"BarChart3",functions:[{name:"CORRELATION",syntax:"CORRELATION(dataset1, dataset2)",description:"Correlation coefficient"},{name:"REGRESSION",syntax:"REGRESSION(dependent_var, independent_var)",description:"Linear regression analysis"},{name:"VOLATILITY",syntax:"VOLATILITY(returns, period)",description:"Historical volatility"},{name:"BETA",syntax:"BETA(stock_returns, market_returns)",description:"Beta coefficient calculation"},{name:"SHARPE_RATIO",syntax:"SHARPE_RATIO(returns, risk_free_rate)",description:"Risk-adjusted return metric"}]},mathematical:{name:"Mathematical",icon:"Sigma",functions:[{name:"SUM",syntax:"SUM(range)",description:"Sum of values"},{name:"AVERAGE",syntax:"AVERAGE(range)",description:"Average of values"},{name:"MEDIAN",syntax:"MEDIAN(range)",description:"Median value"},{name:"STDEV",syntax:"STDEV(range)",description:"Standard deviation"},{name:"PERCENTILE",syntax:"PERCENTILE(range, percentile)",description:"Percentile calculation"}]}},S=()=>(d.match(/\(/g)||[]).length===(d.match(/\)/g)||[]).length;return e.jsxs("div",{className:"flex flex-col h-full bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(t,{name:"Wrench",size:20,className:"text-primary"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Formula Builder"})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx(n,{variant:"outline",size:"sm",iconName:"Plus",onClick:()=>g(!h),children:"New Formula"})})]}),e.jsx("div",{className:"flex border-b border-border",children:Object.entries(f).map(([a,n])=>e.jsxs("button",{onClick:()=>o(a),className:"flex items-center space-x-2 px-4 py-3 text-sm font-medium transition-smooth "+(i===a?"bg-primary text-primary-foreground border-b-2 border-primary":"text-muted-foreground hover:text-foreground hover:bg-muted"),children:[e.jsx(t,{name:n.icon,size:16}),e.jsx("span",{children:n.name})]},a))}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[e.jsx("div",{className:"p-4 space-y-3",children:f[i].functions.map((a,s)=>e.jsx("div",{draggable:!0,onDragStart:e=>((e,t)=>{l(t),e.dataTransfer.effectAllowed="copy"})(e,a),className:"p-3 bg-muted rounded-lg border border-border cursor-move hover:bg-muted/80 transition-smooth group",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(t,{name:"Move",size:14,className:"text-muted-foreground group-hover:text-foreground"}),e.jsx("span",{className:"font-medium text-foreground",children:a.name})]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:a.description}),e.jsx("code",{className:"text-xs bg-background px-2 py-1 rounded mt-2 block font-mono text-foreground",children:a.syntax})]}),e.jsx(n,{variant:"ghost",size:"sm",iconName:"Plus",onClick:()=>(e=>{const t=d+(d?" + ":"")+e.syntax;m(t)})(a),className:"opacity-0 group-hover:opacity-100 transition-opacity"})]})},s))}),e.jsxs("div",{className:"border-t border-border p-4",children:[e.jsxs("h4",{className:"text-sm font-medium text-foreground mb-3 flex items-center space-x-2",children:[e.jsx(t,{name:"BookOpen",size:16}),e.jsx("span",{children:"Saved Formulas"})]}),e.jsx("div",{className:"space-y-2",children:[{name:"Custom_DCF_Tech",formula:"DCF(FCFF_PROJECTIONS, WACC(0.12, 0.04, 0.25, 0.3), 0.025)",category:"Custom"},{name:"LBO_Returns",formula:"IRR([INITIAL_INVESTMENT * -1, EXIT_VALUE])",category:"Custom"},{name:"Comp_Multiple",formula:"AVERAGE(PEER_EV_REVENUE) * TARGET_REVENUE",category:"Custom"}].map((t,a)=>e.jsxs("div",{className:"p-3 bg-background rounded-lg border border-border hover:bg-muted/50 transition-smooth cursor-pointer",onClick:()=>m(t.formula),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-foreground",children:t.name}),e.jsx("span",{className:"text-xs text-muted-foreground bg-muted px-2 py-1 rounded",children:t.category})]}),e.jsx("code",{className:"text-xs text-muted-foreground mt-1 block font-mono",children:t.formula})]},a))})]})]}),h&&e.jsx("div",{className:"border-t border-border bg-background",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Formula Name"}),e.jsx("input",{type:"text",value:u,onChange:e=>p(e.target.value),placeholder:"Enter formula name...",className:"w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Formula Expression"}),e.jsx("div",{ref:y,onDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},onDrop:e=>{if(e.preventDefault(),c){const e=d+(d?" + ":"")+c.syntax;m(e),l(null)}},className:"min-h-[100px] p-3 bg-input border-2 border-dashed border-border rounded-lg focus-within:border-ring transition-colors",children:e.jsx("textarea",{value:d,onChange:e=>m(e.target.value),placeholder:"Drag functions here or type formula manually...",className:"w-full h-20 bg-transparent text-foreground placeholder-muted-foreground resize-none outline-none font-mono text-sm"})}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("div",{className:"flex items-center space-x-2",children:S()?e.jsxs("div",{className:"flex items-center space-x-1 text-success",children:[e.jsx(t,{name:"CheckCircle",size:14}),e.jsx("span",{className:"text-xs",children:"Valid syntax"})]}):e.jsxs("div",{className:"flex items-center space-x-1 text-destructive",children:[e.jsx(t,{name:"XCircle",size:14}),e.jsx("span",{className:"text-xs",children:"Invalid syntax"})]})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[d.length," characters"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(n,{variant:"outline",size:"sm",iconName:"Trash2",onClick:()=>{m(""),p("")},children:"Clear"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(n,{variant:"outline",size:"sm",iconName:"Eye",disabled:!S(),children:"Preview"}),e.jsx(n,{variant:"default",size:"sm",iconName:"Save",onClick:()=>{u&&d&&(s&&s({name:u,formula:d,timestamp:new Date}),p(""),m(""),g(!1))},disabled:!u||!d||!S(),children:"Save Formula"})]})]})]})})]})},y=({onTemplateSelect:s,onTemplateCreate:r})=>{const[i,o]=a.useState("valuation"),[c,l]=a.useState(""),[d,m]=a.useState(!1),u={valuation:{name:"Valuation Models",icon:"TrendingUp",templates:[{id:"dcf_standard",name:"DCF - Standard",description:"Traditional discounted cash flow model with 5-year projections and terminal value",complexity:"Intermediate",timeToComplete:"45 min",lastUsed:"2024-07-10",popularity:95,features:["5-year projections","Terminal value","Sensitivity analysis","WACC calculation"]},{id:"dcf_tech",name:"DCF - Technology",description:"Specialized DCF for high-growth technology companies with adjusted metrics",complexity:"Advanced",timeToComplete:"60 min",lastUsed:"2024-07-08",popularity:87,features:["SaaS metrics","User-based projections","Churn analysis","Rule of 40"]},{id:"sum_of_parts",name:"Sum-of-the-Parts",description:"Multi-business valuation with segment-specific assumptions and multiples",complexity:"Advanced",timeToComplete:"90 min",lastUsed:"2024-07-05",popularity:73,features:["Segment analysis","Multiple approaches","Holding company discount","Synergy modeling"]}]},lbo:{name:"LBO Models",icon:"Layers",templates:[{id:"lbo_standard",name:"LBO - Standard",description:"Complete leveraged buyout model with debt sizing and returns analysis",complexity:"Advanced",timeToComplete:"120 min",lastUsed:"2024-07-09",popularity:91,features:["Debt capacity","Returns waterfall","Management rollover","Exit scenarios"]},{id:"lbo_growth",name:"LBO - Growth Equity",description:"Growth-focused LBO with minority investment and expansion capital",complexity:"Advanced",timeToComplete:"100 min",lastUsed:"2024-07-06",popularity:68,features:["Growth capital","Minority stake","Management incentives","Expansion modeling"]}]},comps:{name:"Comparable Analysis",icon:"BarChart3",templates:[{id:"trading_comps",name:"Trading Comparables",description:"Public company multiple analysis with statistical benchmarking",complexity:"Beginner",timeToComplete:"30 min",lastUsed:"2024-07-11",popularity:98,features:["Multiple analysis","Statistical metrics","Peer screening","Premium/discount analysis"]},{id:"transaction_comps",name:"Transaction Comparables",description:"M&A transaction analysis with control premiums and synergies",complexity:"Intermediate",timeToComplete:"45 min",lastUsed:"2024-07-07",popularity:82,features:["M&A multiples","Control premiums","Synergy analysis","Transaction screening"]}]},merger:{name:"M&A Models",icon:"GitMerge",templates:[{id:"merger_model",name:"Merger Model",description:"Comprehensive merger analysis with accretion/dilution and pro forma statements",complexity:"Expert",timeToComplete:"180 min",lastUsed:"2024-07-04",popularity:76,features:["Accretion/dilution","Pro forma statements","Synergy modeling","Financing structure"]},{id:"acquisition_model",name:"Acquisition Model",description:"Strategic acquisition analysis with integration costs and value creation",complexity:"Expert",timeToComplete:"150 min",lastUsed:"2024-07-03",popularity:71,features:["Integration costs","Value creation","Financing options","Risk analysis"]}]}},p=e=>{switch(e){case"Beginner":return"text-success bg-success/10";case"Intermediate":return"text-warning bg-warning/10";case"Advanced":return"text-accent bg-accent/10";case"Expert":return"text-destructive bg-destructive/10";default:return"text-muted-foreground bg-muted"}},h=()=>{const e=u[i]?.templates||[];return c?e.filter(e=>e.name.toLowerCase().includes(c.toLowerCase())||e.description.toLowerCase().includes(c.toLowerCase())):e},g=e=>{s&&s(e)};return e.jsxs("div",{className:"flex flex-col h-full bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(t,{name:"FileTemplate",size:20,className:"text-primary"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Model Templates"})]}),e.jsx(n,{variant:"outline",size:"sm",iconName:"Plus",onClick:()=>m(!0),children:"Create Template"})]}),e.jsx("div",{className:"p-4 border-b border-border",children:e.jsxs("div",{className:"relative",children:[e.jsx(t,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground"}),e.jsx("input",{type:"text",value:c,onChange:e=>l(e.target.value),placeholder:"Search templates...",className:"w-full pl-10 pr-4 py-2 bg-input border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"})]})}),e.jsx("div",{className:"flex border-b border-border overflow-x-auto",children:Object.entries(u).map(([a,n])=>e.jsxs("button",{onClick:()=>o(a),className:"flex items-center space-x-2 px-4 py-3 text-sm font-medium whitespace-nowrap transition-smooth "+(i===a?"bg-primary text-primary-foreground border-b-2 border-primary":"text-muted-foreground hover:text-foreground hover:bg-muted"),children:[e.jsx(t,{name:n.icon,size:16}),e.jsx("span",{children:n.name})]},a))}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[!c&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("h4",{className:"text-sm font-medium text-foreground mb-3 flex items-center space-x-2",children:[e.jsx(t,{name:"Clock",size:16}),e.jsx("span",{children:"Recently Used"})]}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:[{id:"dcf_standard",name:"DCF - Standard",lastUsed:"2024-07-11 14:30"},{id:"trading_comps",name:"Trading Comparables",lastUsed:"2024-07-11 09:15"},{id:"lbo_standard",name:"LBO - Standard",lastUsed:"2024-07-10 16:45"}].map(a=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg hover:bg-muted/80 transition-smooth cursor-pointer",onClick:()=>g(a),children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-foreground",children:a.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Last used: ",a.lastUsed]})]}),e.jsx(t,{name:"ChevronRight",size:16,className:"text-muted-foreground"})]},a.id))})]}),e.jsx("div",{className:"space-y-4",children:h().map(a=>e.jsxs("div",{className:"p-4 bg-background border border-border rounded-lg hover:border-primary/50 transition-smooth cursor-pointer group",onClick:()=>g(a),children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx("h5",{className:"font-semibold text-foreground group-hover:text-primary transition-colors",children:a.name}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${p(a.complexity)}`,children:a.complexity})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.description})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-4",children:[e.jsxs("div",{className:"flex items-center space-x-1 text-xs text-muted-foreground",children:[e.jsx(t,{name:"Star",size:12}),e.jsxs("span",{children:[a.popularity,"%"]})]}),e.jsx(t,{name:"ChevronRight",size:16,className:"text-muted-foreground group-hover:text-primary transition-colors"})]})]}),e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsxs("div",{className:"flex items-center space-x-4 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(t,{name:"Clock",size:12}),e.jsx("span",{children:a.timeToComplete})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(t,{name:"Calendar",size:12}),e.jsxs("span",{children:["Last used: ",a.lastUsed]})]})]})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:a.features.map((t,a)=>e.jsx("span",{className:"px-2 py-1 bg-muted text-xs text-muted-foreground rounded",children:t},a))})]},a.id))}),0===h().length&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(t,{name:"FileX",size:48,className:"text-muted-foreground mx-auto mb-4"}),e.jsx("h4",{className:"text-lg font-medium text-foreground mb-2",children:"No templates found"}),e.jsx("p",{className:"text-muted-foreground",children:c?"Try adjusting your search terms":"No templates available in this category"})]})]}),d&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-card border border-border rounded-lg shadow-elevation-2 w-full max-w-md mx-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Create New Template"}),e.jsx(n,{variant:"ghost",size:"sm",iconName:"X",onClick:()=>m(!1)})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Template Name"}),e.jsx("input",{type:"text",placeholder:"Enter template name...",className:"w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Description"}),e.jsx("textarea",{placeholder:"Describe your template...",rows:3,className:"w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Category"}),e.jsxs("select",{className:"w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-ring",children:[e.jsx("option",{value:"valuation",children:"Valuation Models"}),e.jsx("option",{value:"lbo",children:"LBO Models"}),e.jsx("option",{value:"comps",children:"Comparable Analysis"}),e.jsx("option",{value:"merger",children:"M&A Models"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-2 p-4 border-t border-border",children:[e.jsx(n,{variant:"outline",size:"sm",onClick:()=>m(!1),children:"Cancel"}),e.jsx(n,{variant:"default",size:"sm",onClick:()=>{m(!1),r&&r()},children:"Create Template"})]})]})})]})};const f=new class{constructor(){this.commands=new Map,this.categories=new Map,this.aliases=new Map,this.initializeCategories()}initializeCategories(){this.categories.set("CORE",{name:"Core Analysis",description:"Fundamental financial analysis commands",icon:"ðŸ“Š",commands:[]}),this.categories.set("PORTFOLIO",{name:"Portfolio & Risk",description:"Portfolio analysis and risk management",icon:"ðŸŽ¯",commands:[]}),this.categories.set("VALUATION",{name:"Advanced Valuation",description:"Sophisticated valuation models",icon:"ðŸ“ˆ",commands:[]}),this.categories.set("TECHNICAL",{name:"Technical Analysis",description:"Technical analysis and market intelligence",icon:"ðŸ“Š",commands:[]}),this.categories.set("FIXED_INCOME",{name:"Fixed Income & Derivatives",description:"Bond analysis and derivatives pricing",icon:"ðŸ¦",commands:[]}),this.categories.set("ESG",{name:"ESG & Alternative Data",description:"Environmental, social, governance metrics",icon:"ðŸŒ±",commands:[]}),this.categories.set("AUTOMATION",{name:"Automation & Workflows",description:"Automated analysis and workflows",icon:"ðŸ¤–",commands:[]}),this.categories.set("DATA",{name:"Data Management",description:"Data import, export, and management",icon:"ðŸ’¾",commands:[]}),this.categories.set("REPORTING",{name:"Reporting & Visualization",description:"Reports, charts, and visualizations",icon:"ðŸ“‹",commands:[]}),this.categories.set("SYSTEM",{name:"System & Performance",description:"System monitoring and configuration",icon:"ðŸ”§",commands:[]}),this.categories.set("ANALYTICS",{name:"Advanced Analytics",description:"Machine learning and advanced analytics",icon:"ðŸ’¡",commands:[]}),this.categories.set("MARKET_DATA",{name:"Market Data Extensions",description:"Extended market data and economic indicators",icon:"ðŸŒ",commands:[]}),this.categories.set("UTILITY",{name:"Utility Commands",description:"General utility and helper commands",icon:"ðŸ› ï¸",commands:[]})}register(e,t,a={}){const n=e.toUpperCase(),s={name:n,handler:t,category:a.category||"UTILITY",description:a.description||"No description available",usage:a.usage||`${n}()`,examples:a.examples||[],parameterSchema:a.parameterSchema||null,aliases:a.aliases||[],tags:a.tags||[],version:a.version||"1.0.0",deprecated:a.deprecated||!1,experimental:a.experimental||!1};this.commands.set(n,s),a.aliases&&a.aliases.forEach(e=>{this.aliases.set(e.toUpperCase(),n)});const r=this.categories.get(s.category);return r&&r.commands.push(n),this}getHandler(e){const t=e.toUpperCase(),a=this.commands.get(t);if(a)return a.handler;const n=this.aliases.get(t);if(n){const e=this.commands.get(n);return e?e.handler:null}return null}getCommandInfo(e){const t=e.toUpperCase(),a=this.commands.get(t);if(a)return a;const n=this.aliases.get(t);return n?this.commands.get(n):null}getCommandsByCategory(e){const t=this.categories.get(e.toUpperCase());return t?t.commands.map(e=>this.commands.get(e)):[]}getAllCommands(){return Array.from(this.commands.keys())}getAllCategories(){return Array.from(this.categories.entries()).map(([e,t])=>({key:e,...t}))}searchCommands(e){const t=e.toLowerCase(),a=[];for(const[n,s]of this.commands){const e=this.calculateSearchScore(s,t);e>0&&a.push({...s,score:e})}return a.sort((e,t)=>t.score-e.score)}calculateSearchScore(e,t){let a=0;return e.name.toLowerCase()===t&&(a+=100),e.name.toLowerCase().includes(t)&&(a+=50),e.description.toLowerCase().includes(t)&&(a+=25),e.tags.some(e=>e.toLowerCase().includes(t))&&(a+=15),e.aliases.some(e=>e.toLowerCase().includes(t))&&(a+=10),a}getSuggestions(e){const t=e.toLowerCase(),a=[];for(const[n,s]of this.commands)n.toLowerCase().startsWith(t)&&a.push({name:s.name,description:s.description,usage:s.usage,category:s.category});return a.sort((e,t)=>e.name.localeCompare(t.name))}hasCommand(e){const t=e.toUpperCase();return this.commands.has(t)||this.aliases.has(t)}getCommandStats(){const e={};for(const[t,a]of this.categories)e[t]={name:a.name,count:a.commands.length,icon:a.icon};return e}};class S{constructor(){this.algorithm="AES-GCM",this.keyLength=256,this.ivLength=12,this.tagLength=16,this.textEncoder=new TextEncoder,this.textDecoder=new TextDecoder,this.initializeKey()}async initializeKey(){try{const e=localStorage.getItem("financeanalyst_crypto_key");if(e){const t=this.base64ToArrayBuffer(e);this.cryptoKey=await crypto.subtle.importKey("raw",t,{name:this.algorithm},!1,["encrypt","decrypt"])}else{this.cryptoKey=await crypto.subtle.generateKey({name:this.algorithm,length:this.keyLength},!0,["encrypt","decrypt"]);const e=await crypto.subtle.exportKey("raw",this.cryptoKey),t=this.arrayBufferToBase64(e);localStorage.setItem("financeanalyst_crypto_key",t)}}catch(e){throw e}}async encrypt(e){this.cryptoKey||await this.initializeKey();try{const t=this.textEncoder.encode(e),a=crypto.getRandomValues(new Uint8Array(this.ivLength)),n=await crypto.subtle.encrypt({name:this.algorithm,iv:a},this.cryptoKey,t),s=new Uint8Array(a.length+n.byteLength);return s.set(a,0),s.set(new Uint8Array(n),a.length),this.arrayBufferToBase64(s.buffer)}catch(t){throw new Error(`Encryption failed: ${t.message}`)}}async decrypt(e){this.cryptoKey||await this.initializeKey();try{const t=this.base64ToArrayBuffer(e),a=t.slice(0,this.ivLength),n=t.slice(this.ivLength),s=await crypto.subtle.decrypt({name:this.algorithm,iv:a},this.cryptoKey,n);return this.textDecoder.decode(s)}catch(t){throw new Error(`Decryption failed: ${t.message}`)}}async hash(e){try{const t=this.textEncoder.encode(e),a=await crypto.subtle.digest("SHA-256",t);return this.arrayBufferToBase64(a)}catch(t){throw new Error(`Hashing failed: ${t.message}`)}}async verifyIntegrity(e,t){try{return await this.hash(e)===t}catch(a){return!1}}generateRandomString(e=32){const t=new Uint8Array(e);return crypto.getRandomValues(t),this.arrayBufferToBase64(t.buffer).substring(0,e)}async deriveKeyFromPassword(e,t){try{const a=this.textEncoder.encode(e),n=this.textEncoder.encode(t),s=await crypto.subtle.importKey("raw",a,{name:"PBKDF2"},!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},s,{name:this.algorithm,length:this.keyLength},!1,["encrypt","decrypt"])}catch(a){throw new Error(`Key derivation failed: ${a.message}`)}}isAvailable(){return!(!window.crypto||!window.crypto.subtle)}getInfo(){return{algorithm:this.algorithm,keyLength:this.keyLength,ivLength:this.ivLength,available:this.isAvailable(),keyInitialized:!!this.cryptoKey}}arrayBufferToBase64(e){const t=new Uint8Array(e);let a="";for(let n=0;n<t.byteLength;n++)a+=String.fromCharCode(t[n]);return btoa(a)}base64ToArrayBuffer(e){const t=atob(e),a=new Uint8Array(t.length);for(let n=0;n<t.length;n++)a[n]=t.charCodeAt(n);return a.buffer}clearSensitiveData(e){if(e instanceof ArrayBuffer){const t=new Uint8Array(e);crypto.getRandomValues(t)}else"string"==typeof e&&(e=null)}async performanceTest(){if(!this.isAvailable())return null;const e=JSON.stringify({test:"performance",data:new Array(1e3).fill("test data for performance testing"),timestamp:Date.now()});try{const t=performance.now();let a;for(let i=0;i<50;i++)a=await this.encrypt(e);const n=performance.now()-t,s=performance.now();for(let e=0;e<50;e++)await this.decrypt(a);const r=performance.now()-s;return{encryptTime:n/50,decryptTime:r/50,totalTime:n+r,dataSize:e.length,encryptedSize:a.length,compressionRatio:a.length/e.length,iterations:50}}catch(t){return null}}}class v{constructor(){this.compressionFormat="gzip",this.textEncoder=new TextEncoder,this.textDecoder=new TextDecoder}async compress(e){try{return"CompressionStream"in window?await this.compressWithStream(e):await this.compressWithLZString(e)}catch(t){return e}}async decompress(e){try{return"DecompressionStream"in window&&this.isNativeCompressed(e)?await this.decompressWithStream(e):await this.decompressWithLZString(e)}catch(t){return e}}async compressWithStream(e){const t=new CompressionStream(this.compressionFormat),a=t.writable.getWriter(),n=t.readable.getReader(),s=this.textEncoder.encode(e);a.write(s),a.close();const r=[];let i=!1;for(;!i;){const{value:e,done:t}=await n.read();i=t,e&&r.push(e)}const o=r.reduce((e,t)=>e+t.length,0),c=new Uint8Array(o);let l=0;for(const d of r)c.set(d,l),l+=d.length;return"NATIVE_GZIP:"+this.arrayBufferToBase64(c.buffer)}async decompressWithStream(e){const t=e.replace("NATIVE_GZIP:",""),a=this.base64ToArrayBuffer(t),n=new DecompressionStream(this.compressionFormat),s=n.writable.getWriter(),r=n.readable.getReader();s.write(new Uint8Array(a)),s.close();const i=[];let o=!1;for(;!o;){const{value:e,done:t}=await r.read();o=t,e&&i.push(e)}const c=i.reduce((e,t)=>e+t.length,0),l=new Uint8Array(c);let d=0;for(const m of i)l.set(m,d),d+=m.length;return this.textDecoder.decode(l)}async compressWithLZString(e){const t=new Map,a=[];let n=256;for(let i=0;i<256;i++)t.set(String.fromCharCode(i),i);let s="";for(let i=0;i<e.length;i++){const r=e[i],o=s+r;t.has(o)?s=o:(a.push(t.get(s)),t.set(o,n++),s=r)}s&&a.push(t.get(s));const r=new Uint16Array(a);return"LZ_STRING:"+this.arrayBufferToBase64(r.buffer)}async decompressWithLZString(e){const t=e.replace("LZ_STRING:",""),a=this.base64ToArrayBuffer(t),n=new Uint16Array(a),s=new Map;let r=256;for(let c=0;c<256;c++)s.set(c,String.fromCharCode(c));let i="",o=String.fromCharCode(n[0]);i+=o;for(let c=1;c<n.length;c++){const e=n[c];let t;if(s.has(e))t=s.get(e);else{if(e!==r)throw new Error("Invalid compressed data");t=o+o[0]}i+=t,s.set(r++,o+t[0]),o=t}return i}isNativeCompressed(e){return"string"==typeof e&&e.startsWith("NATIVE_GZIP:")}isLZStringCompressed(e){return"string"==typeof e&&e.startsWith("LZ_STRING:")}isCompressed(e){return this.isNativeCompressed(e)||this.isLZStringCompressed(e)}getCompressionRatio(e,t){const a=new Blob([e]).size;return new Blob([t]).size/a}async estimateCompressionBenefit(e){try{const t=new Blob([e]).size,a=await this.compress(e),n=new Blob([a]).size;return{originalSize:t,compressedSize:n,ratio:n/t,savings:t-n,savingsPercentage:(t-n)/t*100,worthCompressing:n<.9*t}}catch(t){return{originalSize:new Blob([e]).size,compressedSize:new Blob([e]).size,ratio:1,savings:0,savingsPercentage:0,worthCompressing:!1,error:t.message}}}isAvailable(){return"CompressionStream"in window||!0}getInfo(){return{nativeCompressionAvailable:"CompressionStream"in window,fallbackAvailable:!0,defaultFormat:this.compressionFormat,available:this.isAvailable()}}async performanceTest(){const e=JSON.stringify({test:"compression performance",data:new Array(1e3).fill("This is test data for compression performance testing. ".repeat(10)),numbers:new Array(100).fill(0).map((e,t)=>t),timestamp:Date.now()});try{const t=performance.now();let a;for(let o=0;o<20;o++)a=await this.compress(e);const n=performance.now()-t,s=performance.now();for(let e=0;e<20;e++)await this.decompress(a);const r=performance.now()-s,i=this.getCompressionRatio(e,a);return{compressTime:n/20,decompressTime:r/20,totalTime:n+r,originalSize:e.length,compressedSize:a.length,compressionRatio:i,savingsPercentage:100*(1-i),iterations:20,method:this.isNativeCompressed(a)?"native":"lz-string"}}catch(t){return null}}arrayBufferToBase64(e){const t=new Uint8Array(e);let a="";for(let n=0;n<t.byteLength;n++)a+=String.fromCharCode(t[n]);return btoa(a)}base64ToArrayBuffer(e){const t=atob(e),a=new Uint8Array(t.length);for(let n=0;n<t.length;n++)a[n]=t.charCodeAt(n);return a.buffer}}class A{constructor(){this.prefix="financeanalyst_",this.isAvailable=!1,this.maxSize=5242880,this.cryptoUtils=new S,this.compressionUtils=new v}async initialize(){try{const e=this.prefix+"test";return localStorage.setItem(e,"test"),localStorage.removeItem(e),this.isAvailable=!0,{success:!0,available:!0}}catch(e){return this.isAvailable=!1,{success:!1,available:!1,error:e.message}}}async store(e,t,a={}){if(!this.isAvailable)throw new Error("localStorage is not available");const{encrypt:n=!1,compress:s=!1,ttl:r=null,validate:i=!0}=a;try{if(i&&!this.validateData(t))throw new Error("Invalid data format");const a={data:t,metadata:{timestamp:Date.now(),version:"1.0",encrypted:n,compressed:s,ttl:r,originalSize:JSON.stringify(t).length}};let o=JSON.stringify(a);if(s&&(o=await this.compressionUtils.compress(o),a.metadata.compressedSize=o.length),n&&(o=await this.cryptoUtils.encrypt(o)),o.length>this.maxSize)throw new Error(`Data too large: ${o.length} bytes exceeds ${this.maxSize} bytes`);const c=this.prefix+e;return localStorage.setItem(c,o),{success:!0,key:c,size:o.length,metadata:a.metadata}}catch(o){throw o}}async retrieve(e,t={}){if(!this.isAvailable)return null;const{decrypt:a=!1,validateTTL:n=!0}=t;try{const t=this.prefix+e;let i,o=localStorage.getItem(t);if(!o)return null;a&&(o=await this.cryptoUtils.decrypt(o));try{i=JSON.parse(o)}catch(s){try{const e=await this.compressionUtils.decompress(o);i=JSON.parse(e)}catch(r){throw new Error("Failed to parse stored data")}}if(n&&i.metadata&&i.metadata.ttl){const t=Date.now();if(t>i.metadata.timestamp+i.metadata.ttl)return await this.remove(e),null}return{data:i.data,metadata:i.metadata}}catch(i){return null}}async remove(e){if(!this.isAvailable)return!1;try{const t=this.prefix+e;return localStorage.removeItem(t),!0}catch(t){return!1}}async clear(){if(!this.isAvailable)return!1;try{const e=Object.keys(localStorage);return e.filter(e=>e.startsWith(this.prefix)).forEach(e=>{localStorage.removeItem(e)}),!0}catch(e){return!1}}async getKeys(){if(!this.isAvailable)return[];try{return Object.keys(localStorage).filter(e=>e.startsWith(this.prefix)).map(e=>e.substring(this.prefix.length))}catch(e){return[]}}async getStats(){if(!this.isAvailable)return{available:!1,used:0,keys:0};try{const e=await this.getKeys();let t=0,a=0;const n={};for(const s of e){const e=this.prefix+s,r=localStorage.getItem(e);if(r){const e=r.length;t+=e,a++,n[s]=e}}return{available:!0,used:t,keys:a,maxSize:this.maxSize,usagePercentage:t/this.maxSize*100,itemSizes:n,largestItem:Object.entries(n).reduce((e,[t,a])=>a>e.size?{key:t,size:a}:e,{key:null,size:0})}}catch(e){return{available:!1,used:0,keys:0,error:e.message}}}async exportAll(){if(!this.isAvailable)return{};try{const e=await this.getKeys(),t={};for(const a of e){const e=await this.retrieve(a,{validateTTL:!1});e&&(t[a]=e)}return t}catch(e){return{}}}async importData(e,t={}){if(!this.isAvailable)throw new Error("localStorage is not available");const{overwrite:a=!1}=t;try{const t={imported:0,skipped:0,errors:0};for(const[s,r]of Object.entries(e))try{if(await this.retrieve(s,{validateTTL:!1})&&!a){t.skipped++;continue}await this.store(s,r.data,{encrypt:r.metadata?.encrypted||!1,compress:r.metadata?.compressed||!1,ttl:r.metadata?.ttl||null}),t.imported++}catch(n){t.errors++}return t}catch(n){throw n}}async hasSpace(e){if(!this.isAvailable)return!1;try{return(await this.getStats()).used+e<=this.maxSize}catch(t){return!1}}async cleanup(){if(!this.isAvailable)return{cleaned:0};try{const e=await this.getKeys();let t=0;for(const a of e){await this.retrieve(a,{validateTTL:!0})||t++}return{cleaned:t}}catch(e){return{cleaned:0,error:e.message}}}validateData(e){try{JSON.stringify(e);const t=new WeakSet,a=e=>{if(null!==e&&"object"==typeof e){if(t.has(e))return!1;t.add(e);for(const t in e)if(!a(e[t]))return!1}return!0};return a(e)}catch(t){return!1}}isStorageAvailable(){return this.isAvailable}async performanceTest(){if(!this.isAvailable)return null;const e={test:"performance",data:new Array(1e3).fill("test")},t=100;try{const a=performance.now();for(let i=0;i<t;i++)await this.store(`perf_test_${i}`,e);const n=performance.now()-a,s=performance.now();for(let e=0;e<t;e++)await this.retrieve(`perf_test_${e}`);const r=performance.now()-s;for(let e=0;e<t;e++)await this.remove(`perf_test_${e}`);return{writeTime:n/t,readTime:r/t,totalTime:n+r,iterations:t}}catch(a){return null}}}class x{constructor(){this.dbName="FinanceAnalystPro",this.dbVersion=1,this.db=null,this.isAvailable=!1,this.compressionUtils=new v,this.stores={watchlists:{keyPath:"id",autoIncrement:!0,indexes:[{name:"name",keyPath:"name",unique:!0},{name:"created",keyPath:"created"},{name:"lastUpdated",keyPath:"lastUpdated"}]},analysis_history:{keyPath:"id",autoIncrement:!0,indexes:[{name:"ticker",keyPath:"ticker"},{name:"analysisType",keyPath:"analysisType"},{name:"timestamp",keyPath:"timestamp"}]},command_history:{keyPath:"id",autoIncrement:!0,indexes:[{name:"command",keyPath:"command"},{name:"timestamp",keyPath:"timestamp"},{name:"success",keyPath:"success"}]},alerts:{keyPath:"id",autoIncrement:!0,indexes:[{name:"ticker",keyPath:"ticker"},{name:"condition",keyPath:"condition"},{name:"created",keyPath:"created"},{name:"triggered",keyPath:"triggered"}]},cached_data:{keyPath:"key",indexes:[{name:"timestamp",keyPath:"timestamp"},{name:"expiry",keyPath:"expiry"},{name:"dataType",keyPath:"dataType"}]},user_models:{keyPath:"id",autoIncrement:!0,indexes:[{name:"name",keyPath:"name"},{name:"type",keyPath:"type"},{name:"created",keyPath:"created"}]},export_data:{keyPath:"id",autoIncrement:!0,indexes:[{name:"timestamp",keyPath:"timestamp"},{name:"type",keyPath:"type"}]}}}async initialize(){if(!window.indexedDB)return this.isAvailable=!1,{success:!1,available:!1};try{return this.db=await this.openDatabase(),this.isAvailable=!0,await this.cleanupExpiredData(),{success:!0,available:!0,version:this.dbVersion}}catch(e){return this.isAvailable=!1,{success:!1,available:!1,error:e.message}}}async openDatabase(){return new Promise((e,t)=>{const a=indexedDB.open(this.dbName,this.dbVersion);a.onerror=()=>{t(new Error(`Failed to open database: ${a.error}`))},a.onsuccess=()=>{e(a.result)},a.onupgradeneeded=e=>{const t=e.target.result;this.createObjectStores(t)}})}createObjectStores(e){for(const t of Object.keys(this.stores))e.objectStoreNames.contains(t)&&e.deleteObjectStore(t);for(const[t,a]of Object.entries(this.stores)){const n=e.createObjectStore(t,{keyPath:a.keyPath,autoIncrement:a.autoIncrement});a.indexes&&a.indexes.forEach(e=>{n.createIndex(e.name,e.keyPath,{unique:e.unique||!1})})}}async store(e,t,a={}){if(!this.isAvailable)throw new Error("IndexedDB is not available");const{storeName:n="cached_data",metadata:s={},compress:r=!1}=a;try{const a={key:e,data:t,timestamp:Date.now(),metadata:{...s,compressed:r,originalSize:JSON.stringify(t).length}};if(r){const e=await this.compressionUtils.compress(JSON.stringify(t));a.data=e,a.metadata.compressedSize=e.length}return{success:!0,key:await this.performTransaction(n,"readwrite",e=>e.put(a)),storeName:n,size:JSON.stringify(a).length,metadata:a.metadata}}catch(i){throw i}}async retrieve(e,t={}){if(!this.isAvailable)return null;const{storeName:a="cached_data"}=t;try{const t=await this.performTransaction(a,"readonly",t=>t.get(e));if(!t)return null;if(t.metadata&&t.metadata.expiry&&Date.now()>t.metadata.expiry)return await this.remove(e,{storeName:a}),null;let n=t.data;return t.metadata&&t.metadata.compressed&&(n=JSON.parse(await this.compressionUtils.decompress(n))),{data:n,metadata:t.metadata,timestamp:t.timestamp}}catch(n){return null}}async remove(e,t={}){if(!this.isAvailable)return!1;const{storeName:a="cached_data"}=t;try{return await this.performTransaction(a,"readwrite",t=>t.delete(e)),!0}catch(n){return!1}}async clear(e=null){if(!this.isAvailable)return!1;try{if(e)await this.performTransaction(e,"readwrite",e=>e.clear());else for(const e of Object.keys(this.stores))await this.performTransaction(e,"readwrite",e=>e.clear());return!0}catch(t){return!1}}async getKeys(e="cached_data"){if(!this.isAvailable)return[];try{return await this.performTransaction(e,"readonly",e=>e.getAllKeys())}catch(t){return[]}}async getAll(e="cached_data",t={}){if(!this.isAvailable)return[];const{limit:a=null,filter:n=null}=t;try{const t=await this.performTransaction(e,"readonly",e=>e.getAll());let s=t;return n&&(s=t.filter(n)),a&&(s=s.slice(0,a)),s}catch(s){return[]}}async query(e,t,a,n={}){if(!this.isAvailable)return[];const{limit:s=null}=n;try{return await this.performTransaction(e,"readonly",e=>{const n=e.index(t);return s?n.getAll(a,s):n.getAll(a)})}catch(r){return[]}}async getStats(){if(!this.isAvailable)return{available:!1,stores:{},total:{records:0,size:0}};try{const e={available:!0,stores:{},total:{records:0,size:0}};for(const t of Object.keys(this.stores)){const a=await this.getAll(t),n=a.length,s=a.reduce((e,t)=>e+JSON.stringify(t).length,0);e.stores[t]={records:n,size:s},e.total.records+=n,e.total.size+=s}return e}catch(e){return{available:!1,error:e.message}}}async exportAll(){if(!this.isAvailable)return{};try{const e={};for(const t of Object.keys(this.stores))e[t]=await this.getAll(t);return e}catch(e){return{}}}async importData(e,t={}){if(!this.isAvailable)throw new Error("IndexedDB is not available");const{overwrite:a=!1}=t;try{const t={imported:0,skipped:0,errors:0};for(const[s,r]of Object.entries(e))if(this.stores[s])for(const e of r)try{if(!a){if(await this.retrieve(e.key||e.id,{storeName:s})){t.skipped++;continue}}await this.performTransaction(s,"readwrite",t=>t.put(e)),t.imported++}catch(n){t.errors++}return t}catch(n){throw n}}async cleanupExpiredData(){if(!this.isAvailable)return{cleaned:0};try{let e=0;const t=Date.now(),a=await this.getAll("cached_data");for(const n of a)n.metadata&&n.metadata.expiry&&t>n.metadata.expiry&&(await this.remove(n.key,{storeName:"cached_data"}),e++);return{cleaned:e}}catch(e){return{cleaned:0,error:e.message}}}async performTransaction(e,t,a){return new Promise((n,s)=>{const r=this.db.transaction([e],t),i=r.objectStore(e);r.onerror=()=>{s(new Error(`Transaction failed: ${r.error}`))},r.oncomplete=()=>{};const o=a(i);o.onsuccess=()=>{n(o.result)},o.onerror=()=>{s(new Error(`Operation failed: ${o.error}`))}})}isStorageAvailable(){return this.isAvailable}getInfo(){return{dbName:this.dbName,dbVersion:this.dbVersion,available:this.isAvailable,stores:Object.keys(this.stores),storeCount:Object.keys(this.stores).length}}}class E{constructor(){this.sessionKey="financeanalyst_session",this.userKey="financeanalyst_user",this.preferencesKey="financeanalyst_preferences",this.cryptoUtils=new S,this.currentSession=null,this.currentUser=null,this.sessionTimeout=864e5,this.listeners=new Set,this.defaultPreferences={currency:"USD",precision:2,dateFormat:"YYYY-MM-DD",theme:"dark",notifications:!0,autoSave:!0,commandHistory:!0,dataRetention:30,privacy:{analytics:!1,crashReporting:!0,dataSharing:!1}}}async initialize(){try{return await this.loadSession(),this.setupSessionMonitoring(),{success:!0,hasSession:!!this.currentSession}}catch(e){return{success:!1,error:e.message}}}async createSession(e={}){try{const t=this.generateSessionId(),a=Date.now(),n={id:t,userId:e.id||this.generateUserId(),created:a,lastActivity:a,expires:a+this.sessionTimeout,userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,version:"1.0"},s={id:n.userId,name:e.name||"Anonymous User",email:e.email||null,created:e.created||a,lastLogin:a,loginCount:(e.loginCount||0)+1,preferences:{...this.defaultPreferences,...e.preferences}};return await this.storeSession(n),await this.storeUser(s),this.currentSession=n,this.currentUser=s,this.notifyListeners("sessionCreated",{session:n,user:s}),{success:!0,session:n,user:s}}catch(t){throw t}}async loadSession(){try{const e=localStorage.getItem(this.sessionKey),t=localStorage.getItem(this.userKey);if(!e||!t)return null;const a=JSON.parse(e),n=JSON.parse(t);return Date.now()>a.expires?(await this.destroySession(),null):(a.lastActivity=Date.now(),await this.storeSession(a),this.currentSession=a,this.currentUser=n,this.notifyListeners("sessionLoaded",{session:a,user:n}),{session:a,user:n})}catch(e){return await this.destroySession(),null}}async updateActivity(){if(!this.currentSession)return!1;try{this.currentSession.lastActivity=Date.now();return this.currentSession.expires-Date.now()<.1*this.sessionTimeout&&(this.currentSession.expires=Date.now()+this.sessionTimeout),await this.storeSession(this.currentSession),!0}catch(e){return!1}}async destroySession(){try{const e=this.currentSession,t=this.currentUser;return localStorage.removeItem(this.sessionKey),this.currentSession=null,this.currentUser=null,this.notifyListeners("sessionDestroyed",{session:e,user:t}),!0}catch(e){return!1}}getSession(){return this.currentSession}getUser(){return this.currentUser}isAuthenticated(){return!!(this.currentSession&&Date.now()<this.currentSession.expires)}getPreferences(){return this.currentUser?this.currentUser.preferences:this.defaultPreferences}async updatePreferences(e){if(!this.currentUser)throw new Error("No active user session");try{return this.currentUser.preferences={...this.currentUser.preferences,...e},await this.storeUser(this.currentUser),localStorage.setItem(this.preferencesKey,JSON.stringify(this.currentUser.preferences)),this.notifyListeners("preferencesUpdated",{preferences:this.currentUser.preferences}),this.currentUser.preferences}catch(t){throw t}}getSessionStats(){if(!this.currentSession||!this.currentUser)return null;const e=Date.now(),t=e-this.currentSession.created,a=this.currentSession.expires-e,n=e-this.currentSession.lastActivity;return{sessionId:this.currentSession.id,userId:this.currentUser.id,userName:this.currentUser.name,sessionDuration:t,timeUntilExpiry:a,lastActivityAge:n,loginCount:this.currentUser.loginCount,userCreated:this.currentUser.created,isExpired:a<=0,isActive:n<3e5}}async exportSessionData(){return this.currentSession&&this.currentUser?{session:{...this.currentSession},user:{...this.currentUser},preferences:{...this.currentUser.preferences},exportTimestamp:Date.now()}:null}async importSessionData(e){try{if(!e||!e.session||!e.user)throw new Error("Invalid session data format");const t=e.session,a=e.user;return t.lastActivity=Date.now(),t.expires=Date.now()+this.sessionTimeout,a.lastLogin=Date.now(),await this.storeSession(t),await this.storeUser(a),this.currentSession=t,this.currentUser=a,this.notifyListeners("sessionImported",{session:t,user:a}),{success:!0,session:t,user:a}}catch(t){throw t}}addEventListener(e){this.listeners.add(e)}removeEventListener(e){this.listeners.delete(e)}async storeSession(e){try{localStorage.setItem(this.sessionKey,JSON.stringify(e))}catch(t){throw t}}async storeUser(e){try{localStorage.setItem(this.userKey,JSON.stringify(e))}catch(t){throw t}}generateSessionId(){return"sess_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}generateUserId(){return"user_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}setupSessionMonitoring(){let e=Date.now();const t=this.throttle(()=>{const t=Date.now();t-e>6e4&&(this.updateActivity(),e=t)},1e3);["click","keypress","scroll","mousemove"].forEach(e=>{document.addEventListener(e,t,{passive:!0})}),setInterval(()=>{this.currentSession&&Date.now()>this.currentSession.expires&&this.destroySession()},6e4),document.addEventListener("visibilitychange",()=>{document.hidden||this.updateActivity()}),window.addEventListener("beforeunload",()=>{this.updateActivity()})}throttle(e,t){let a;return function(){const n=arguments,s=this;a||(e.apply(s,n),a=!0,setTimeout(()=>a=!1,t))}}notifyListeners(e,t){this.listeners.forEach(a=>{try{a(e,t)}catch(n){}})}}class T{constructor(){this.currentVersion="1.0.0",this.migrationKey="financeanalyst_migration_version",this.backupKey="financeanalyst_migration_backup",this.migrations={"0.0.0":{to:"1.0.0",description:"Initial migration to structured persistence layer",migrate:this.migrateToV1_0_0.bind(this)}}}async checkAndMigrate(){try{const e=localStorage.getItem(this.migrationKey);return e?e!==this.currentVersion&&await this.performVersionMigration(e,this.currentVersion):await this.performInitialMigration(),localStorage.setItem(this.migrationKey,this.currentVersion),{success:!0,version:this.currentVersion}}catch(e){return{success:!1,error:e.message}}}async performInitialMigration(){try{const e=await this.detectLegacyData();Object.keys(e).length>0&&(await this.createMigrationBackup(e),await this.migrateToV1_0_0(e))}catch(e){throw e}}async performVersionMigration(e,t){try{const a=this.findMigrationPath(e,t);if(!a.length)throw new Error(`No migration path found from ${e} to ${t}`);const n=await this.exportCurrentData();await this.createMigrationBackup(n,e);for(const e of a)await e.migrate()}catch(a){throw await this.restoreFromBackup(),a}}async detectLegacyData(){const e={};try{const t=localStorage.getItem("commandProcessor_variables");t&&(e.variables=JSON.parse(t));const a=localStorage.getItem("commandProcessor_settings");a&&(e.settings=JSON.parse(a));const n=localStorage.getItem("watchlists");n&&(e.watchlists=JSON.parse(n));const s=localStorage.getItem("alerts");return s&&(e.alerts=JSON.parse(s)),Object.keys(localStorage).forEach(t=>{if(t.startsWith("financeanalyst_")&&!t.includes("migration")&&!t.includes("session")&&!t.includes("user")&&!t.includes("crypto_key"))try{e[t]=JSON.parse(localStorage.getItem(t))}catch(a){e[t]=localStorage.getItem(t)}}),e}catch(t){return{}}}async migrateToV1_0_0(e=null){try{const t=e||await this.detectLegacyData();if(t.watchlists){const e=this.migrateWatchlistsFormat(t.watchlists);localStorage.setItem("financeanalyst_watchlists",JSON.stringify(e))}if(t.alerts){const e=this.migrateAlertsFormat(t.alerts);localStorage.setItem("financeanalyst_alerts",JSON.stringify(e))}if(t.settings){const e=this.migratePreferencesFormat(t.settings);localStorage.setItem("financeanalyst_preferences",JSON.stringify(e))}if(t.variables){const e=this.migrateVariablesFormat(t.variables);localStorage.setItem("financeanalyst_user_variables",JSON.stringify(e))}await this.cleanupLegacyData(t)}catch(t){throw t}}migrateWatchlistsFormat(e){const t={};return Array.isArray(e)?e.forEach((e,a)=>{const n=e.name||`Watchlist ${a+1}`;t[n]={tickers:e.tickers||e.stocks||[],created:e.created||(new Date).toISOString().split("T")[0],lastUpdated:e.lastUpdated||null}}):"object"==typeof e&&Object.entries(e).forEach(([e,a])=>{t[e]={tickers:a.tickers||a.stocks||[],created:a.created||(new Date).toISOString().split("T")[0],lastUpdated:a.lastUpdated||null}}),t}migrateAlertsFormat(e){return Array.isArray(e)?e.map(e=>({id:e.id||Date.now()+Math.random(),ticker:e.ticker,condition:e.condition,value:e.value,created:e.created||(new Date).toISOString().split("T")[0],triggered:e.triggered||!1})):[]}migratePreferencesFormat(e){return{currency:e.currency||"USD",precision:e.precision||2,dateFormat:e.dateFormat||"YYYY-MM-DD",theme:e.theme||"dark",notifications:!1!==e.notifications,autoSave:!1!==e.autoSave,commandHistory:!1!==e.commandHistory,dataRetention:e.dataRetention||30,privacy:{analytics:e.analytics||!1,crashReporting:!1!==e.crashReporting,dataSharing:e.dataSharing||!1}}}migrateVariablesFormat(e){return{...e}}async cleanupLegacyData(e){try{["commandProcessor_variables","commandProcessor_settings","watchlists","alerts"].forEach(e=>{localStorage.getItem(e)&&localStorage.removeItem(e)}),Object.keys(e).forEach(e=>{!e.startsWith("financeanalyst_")||e.includes("migration")||e.includes("session")||e.includes("user")||e.includes("crypto_key")||localStorage.removeItem(e)})}catch(t){}}async createMigrationBackup(e,t="legacy"){try{const a={version:t,timestamp:(new Date).toISOString(),data:e};localStorage.setItem(this.backupKey,JSON.stringify(a))}catch(a){}}async restoreFromBackup(){try{const e=localStorage.getItem(this.backupKey);if(!e)throw new Error("No migration backup found");const t=JSON.parse(e);return"legacy"===t.version&&Object.entries(t.data).forEach(([e,t])=>{localStorage.setItem(e,"string"==typeof t?t:JSON.stringify(t))}),!0}catch(e){return!1}}async exportCurrentData(){const e={};return Object.keys(localStorage).forEach(t=>{if(t.startsWith("financeanalyst_"))try{e[t]=JSON.parse(localStorage.getItem(t))}catch(a){e[t]=localStorage.getItem(t)}}),e}findMigrationPath(e,t){const a=this.migrations[e];return a&&a.to===t?[a]:[]}getMigrationStatus(){const e=localStorage.getItem(this.migrationKey),t=!!localStorage.getItem(this.backupKey);return{currentVersion:this.currentVersion,storedVersion:e,needsMigration:e!==this.currentVersion,hasBackup:t,availableMigrations:Object.keys(this.migrations)}}clearBackup(){localStorage.removeItem(this.backupKey)}}const C=new class{constructor(){this.localStorage=new A,this.indexedDB=new x,this.sessionManager=new E,this.migrationService=new T,this.isInitialized=!1,this.storageQuota=null,this.listeners=new Map,this.storageStrategy={localStorage:["user_preferences","session_data","ui_state","recent_commands","quick_settings"],indexedDB:["watchlists","analysis_history","command_history","alerts","cached_data","user_models","export_data"]}}async initialize(){if(!this.isInitialized)try{return await this.checkStorageAvailability(),await Promise.all([this.localStorage.initialize(),this.indexedDB.initialize(),this.sessionManager.initialize()]),await this.migrationService.checkAndMigrate(),await this.estimateStorageQuota(),this.isInitialized=!0,{success:!0,storageQuota:this.storageQuota,availableStorage:await this.getAvailableStorage()}}catch(e){throw new Error(`Persistence initialization failed: ${e.message}`)}}async store(e,t,a={}){await this.ensureInitialized();const{storage:n=this.determineStorageLayer(e),encrypt:s=!1,compress:r=!1,ttl:i=null}=a;try{const a={timestamp:Date.now(),version:"1.0",encrypted:s,compressed:r,ttl:i,size:JSON.stringify(t).length};let o;if("localStorage"===n)o=await this.localStorage.store(e,t,{encrypt:s,ttl:i});else{if("indexedDB"!==n)throw new Error(`Unknown storage layer: ${n}`);o=await this.indexedDB.store(e,t,{metadata:a,compress:r})}return this.notifyListeners("store",{key:e,storage:n,metadata:a}),o}catch(o){throw o}}async retrieve(e,t={}){await this.ensureInitialized();const{storage:a=this.determineStorageLayer(e),decrypt:n=!1}=t;try{let t;if(t="localStorage"===a?await this.localStorage.retrieve(e,{decrypt:n}):"indexedDB"===a?await this.indexedDB.retrieve(e):await this.localStorage.retrieve(e,{decrypt:n})||await this.indexedDB.retrieve(e),t&&t.metadata&&t.metadata.ttl){const n=Date.now();if(n>t.metadata.timestamp+t.metadata.ttl)return await this.remove(e,{storage:a}),null}return t?t.data||t:null}catch(s){return null}}async remove(e,t={}){await this.ensureInitialized();const{storage:a="both"}=t;try{const t=[];return"localStorage"!==a&&"both"!==a||t.push(this.localStorage.remove(e)),"indexedDB"!==a&&"both"!==a||t.push(this.indexedDB.remove(e)),await Promise.all(t),this.notifyListeners("remove",{key:e,storage:a}),!0}catch(n){throw n}}async clear(e={}){await this.ensureInitialized();const{storage:t="both",confirm:a=!1}=e;if(!a)throw new Error("Clear operation requires explicit confirmation");try{const e=[];return"localStorage"!==t&&"both"!==t||e.push(this.localStorage.clear()),"indexedDB"!==t&&"both"!==t||e.push(this.indexedDB.clear()),await Promise.all(e),this.notifyListeners("clear",{storage:t}),!0}catch(n){throw n}}async getStorageStats(){await this.ensureInitialized();try{const[e,t]=await Promise.all([this.localStorage.getStats(),this.indexedDB.getStats()]),a=e.used+t.used;return{localStorage:e,indexedDB:t,total:{used:a,available:await this.getAvailableStorage(),quota:this.storageQuota,usagePercentage:this.storageQuota?a/this.storageQuota*100:0}}}catch(e){return null}}async exportData(e={}){await this.ensureInitialized();const{format:t="json",includeMetadata:a=!0,compress:n=!1}=e;try{const[n,s]=await Promise.all([this.localStorage.exportAll(),this.indexedDB.exportAll()]),r={version:"1.0",timestamp:(new Date).toISOString(),localStorage:n,indexedDB:s};return a&&(r.metadata={userAgent:navigator.userAgent,storageStats:await this.getStorageStats(),exportOptions:e}),{data:r,size:JSON.stringify(r).length,format:t}}catch(s){throw s}}async importData(e,t={}){await this.ensureInitialized();const{overwrite:a=!1,validate:n=!0,backup:s=!0}=t;try{if(n&&!this.validateImportData(e))throw new Error("Invalid import data format");if(s){const e=await this.exportData();await this.store("backup_before_import",e,{storage:"indexedDB",ttl:6048e5})}return e.localStorage&&await this.localStorage.importData(e.localStorage,{overwrite:a}),e.indexedDB&&await this.indexedDB.importData(e.indexedDB,{overwrite:a}),this.notifyListeners("import",{size:JSON.stringify(e).length}),{success:!0,imported:{localStorage:Object.keys(e.localStorage||{}).length,indexedDB:Object.keys(e.indexedDB||{}).length}}}catch(r){throw r}}addEventListener(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}removeEventListener(e,t){this.listeners.has(e)&&this.listeners.get(e).delete(t)}async ensureInitialized(){this.isInitialized||await this.initialize()}determineStorageLayer(e){return this.storageStrategy.localStorage.includes(e)?"localStorage":this.storageStrategy.indexedDB.includes(e)?"indexedDB":"localStorage"}async checkStorageAvailability(){if(!window.localStorage)throw new Error("localStorage is not available");if(!window.indexedDB)throw new Error("IndexedDB is not available");return!0}async estimateStorageQuota(){if("storage"in navigator&&"estimate"in navigator.storage){const e=await navigator.storage.estimate();return this.storageQuota=e.quota,e}return null}async getAvailableStorage(){if("storage"in navigator&&"estimate"in navigator.storage){const e=await navigator.storage.estimate();return e.quota-e.usage}return null}validateImportData(e){return e&&"object"==typeof e&&e.version&&(e.localStorage||e.indexedDB)}notifyListeners(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach(e=>{try{e(t)}catch(a){}})}};const b=new class{constructor(){this.commandHistory=[],this.variables=new Map,this.settings={currency:"USD",precision:2,dateFormat:"YYYY-MM-DD"},this.persistenceInitialized=!1,this.maxHistorySize=1e3}async initializePersistence(){if(!this.persistenceInitialized)try{await C.initialize(),await this.loadPersistedData(),this.persistenceInitialized=!0}catch(e){}}async loadPersistedData(){try{const e=await C.retrieve("command_history");e&&Array.isArray(e)&&(this.commandHistory=e.slice(-this.maxHistorySize));const t=await C.retrieve("user_variables");t&&"object"==typeof t&&(this.variables=new Map(Object.entries(t)));const a=await C.retrieve("user_preferences");a&&"object"==typeof a&&(this.settings={...this.settings,...a})}catch(e){}}async saveData(){if(this.persistenceInitialized)try{await C.store("command_history",this.commandHistory,{storage:"indexedDB"});const e=Object.fromEntries(this.variables);await C.store("user_variables",e,{storage:"localStorage"}),await C.store("user_preferences",this.settings,{storage:"localStorage"})}catch(e){}}async processCommand(e,t={}){const a=Date.now();try{this.persistenceInitialized||await this.initializePersistence();const n=this.parseCommand(e),s={input:e,timestamp:new Date,success:!1,...n};this.commandHistory.push(s),this.commandHistory.length>this.maxHistorySize&&(this.commandHistory=this.commandHistory.slice(-this.maxHistorySize));const r=f.getHandler(n.command);if(!r)return this.createErrorResponse(`Unknown command: "${n.command}"`,e);const i=this.validateParameters(r,n);if(!i.valid)return this.createErrorResponse(i.error,e);const o=await r.execute(n,t,this);return s.success="error"!==o.type,s.executionTime=Date.now()-a,o.executionTime=Date.now()-a,o.timestamp=new Date,this.saveData().catch(e=>{}),o}catch(n){return this.createErrorResponse(`Command execution failed: ${n.message}`,e)}}parseCommand(e){const t=e.trim(),a=t.match(/^([A-Z_]+)\s*\(\s*([^)]*)\s*\)$/i);if(a){const[,e,n]=a,s=this.parseParameters(n);return{command:e.toUpperCase(),parameters:s,rawInput:t,style:"function"}}const n=t.split(/\s+/);return{command:n[0].toUpperCase(),parameters:n.slice(1),rawInput:t,style:"space-separated"}}parseParameters(e){if(!e.trim())return[];const t=[];let a="",n=!1,s=0,r="";for(let i=0;i<e.length;i++){const o=e[i];if('"'!==o&&"'"!==o||n)if(o===r&&n)n=!1,r="";else if("["!==o||n)if("]"!==o||n){if(","===o&&!n&&0===s){t.push(this.parseParameterValue(a.trim())),a="";continue}a+=o}else s--,a+=o;else s++,a+=o;else n=!0,r=o}return a.trim()&&t.push(this.parseParameterValue(a.trim())),t}parseParameterValue(e){if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);if(e.startsWith("[")&&e.endsWith("]")){const t=e.slice(1,-1);return t.trim()?t.split(",").map(e=>this.parseParameterValue(e.trim())):[]}return/^-?\d+\.?\d*$/.test(e)?parseFloat(e):"true"===e.toLowerCase()||"false"!==e.toLowerCase()&&e}validateParameters(e,t){if(!e.parameterSchema)return{valid:!0};const{required:a=[],optional:n=[]}=e.parameterSchema,{parameters:s}=t;if(s.length<a.length)return{valid:!1,error:`Missing required parameters. Expected: ${a.join(", ")}`};const r=a.length+n.length;return s.length>r?{valid:!1,error:`Too many parameters. Maximum: ${r}`}:{valid:!0}}createErrorResponse(e,t){return{type:"error",content:e,suggestions:this.getSuggestions(t),timestamp:new Date}}getSuggestions(e){const t=e.split(/[\s(]/)[0].toUpperCase();return f.getAllCommands().filter(e=>e.includes(t.substring(0,3))||e.toLowerCase().includes(t.toLowerCase())).slice(0,5)}getHistory(e=10){return this.commandHistory.slice(-e)}clearHistory(){this.commandHistory=[]}setVariable(e,t){this.variables.set(e,t),this.persistenceInitialized&&this.saveData().catch(e=>{})}getVariable(e){return this.variables.get(e)}getAllVariables(){return Object.fromEntries(this.variables)}updateSetting(e,t){this.settings[e]=t,this.persistenceInitialized&&this.saveData().catch(e=>{})}getSetting(e){return this.settings[e]}getAllSettings(){return{...this.settings}}},w={DCF:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n)return{type:"error",content:"DCF command requires a ticker symbol. Usage: DCF(AAPL)"};try{const e=`ðŸ”„ Building DCF model for ${n.toUpperCase()}...\nâ€¢ Fetching financial statements\nâ€¢ Calculating free cash flows\nâ€¢ Determining terminal value\nâ€¢ Computing present values...\n${r.demoMode?"\nâš ï¸  Using demo data - configure API keys for live data":"\nâœ… Using live market data"}`;t.showLoading&&t.showLoading(e);const a=await r.fetchDCFInputs(n.toUpperCase()),s=m(a);return{type:"success",content:`DCF Valuation Analysis for ${a.companyName} (${n.toUpperCase()})\n\nðŸ“Š VALUATION SUMMARY:\nâ€¢ Current Price: ${i(a.currentPrice)}\nâ€¢ Fair Value: ${i(s.fairValue)}\nâ€¢ Upside/Downside: ${c(s.upside/100)}\n\nðŸ’° KEY METRICS:\nâ€¢ Enterprise Value: ${i(s.enterpriseValue,"USD",!0)}\nâ€¢ Equity Value: ${i(s.equityValue,"USD",!0)}\nâ€¢ Terminal Value: ${i(s.terminalValue,"USD",!0)}\nâ€¢ WACC: ${c(s.wacc)}\n\nðŸ“ˆ 5-YEAR PROJECTIONS:\n${s.projections.map((e,t)=>`Year ${t+1}: Revenue ${i(e.revenue,"USD",!0)}, FCF ${i(e.fcf,"USD",!0)}`).join("\n")}\n\nðŸŽ¯ RECOMMENDATION: ${s.recommendation}\n\n${r.demoMode?"ðŸ’¡ Note: Using demo data. Configure API keys for live analysis.":"âœ… Analysis based on live market data"}`,data:{analysis:"dcf",ticker:n.toUpperCase(),results:s}}}catch(s){return{type:"error",content:`DCF analysis failed: ${s.message}`}}},parameterSchema:{required:["ticker"],optional:[]}},LBO:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n)return{type:"error",content:"LBO command requires a ticker symbol. Usage: LBO(TSLA)"};try{const e=`ðŸ”„ Analyzing LBO potential for ${n.toUpperCase()}...\nâ€¢ Fetching financial statements\nâ€¢ Calculating debt capacity\nâ€¢ Analyzing peer multiples\nâ€¢ Computing returns scenarios...\n${r.demoMode?"\nâš ï¸  Using demo data - configure API keys for live data":"\nâœ… Using live market data"}`;t.showLoading&&t.showLoading(e);const[a,s]=await Promise.all([r.fetchCompanyProfile(n.toUpperCase()),r.fetchFinancialStatements(n.toUpperCase(),"income-statement")]),l={companyName:a.companyName,currentPrice:a.price,marketCap:a.mktCap,ebitda:s[0]?.ebitda||.15*a.mktCap,revenue:s[0]?.revenue||2*a.mktCap,debt:a.totalDebt||0,cash:a.totalCash||0},m=d(l);return{type:"success",content:`LBO Analysis for ${a.companyName} (${n.toUpperCase()})\n\nðŸ’¼ TRANSACTION SUMMARY:\nâ€¢ Purchase Price: ${i(m.purchasePrice,"USD",!0)}\nâ€¢ Equity Investment: ${i(m.equityInvestment,"USD",!0)}\nâ€¢ Total Debt: ${i(m.totalDebt,"USD",!0)}\nâ€¢ Debt/Equity Ratio: ${o(m.debtToEquity,1)}x\n\nðŸ“ˆ PROJECTED RETURNS (5-year hold):\nâ€¢ Exit Equity Value: ${i(m.exitEquityValue,"USD",!0)}\nâ€¢ Total Return: ${i(m.totalReturn,"USD",!0)}\nâ€¢ IRR: ${c(m.irr)}\nâ€¢ MOIC: ${o(m.moic,1)}x\n\nðŸŽ¯ EXIT ASSUMPTIONS:\nâ€¢ Exit EBITDA: ${i(m.exitEbitda,"USD",!0)}\nâ€¢ Exit Multiple: ${o(m.exitMultiple,1)}x\nâ€¢ Exit Enterprise Value: ${i(m.exitEnterpriseValue,"USD",!0)}\n\nðŸ’° FEES & CARRY:\nâ€¢ Management Fees: ${i(m.managementFees,"USD",!0)}\nâ€¢ Carried Interest: ${i(m.carriedInterest,"USD",!0)}\nâ€¢ Net Return: ${i(m.netReturn,"USD",!0)}\n\n${r.demoMode?"ðŸ’¡ Note: Using demo data. Configure API keys for live analysis.":"âœ… Analysis based on live market data"}`,data:{analysis:"lbo",ticker:n.toUpperCase(),results:m}}}catch(s){return{type:"error",content:`LBO analysis failed: ${s.message}`}}},parameterSchema:{required:["ticker"],optional:[]}},COMP:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n)return{type:"error",content:"COMP command requires a ticker symbol. Usage: COMP(MSFT)"};try{const e=`ðŸ”„ Building comparable company analysis for ${n.toUpperCase()}...\nâ€¢ Identifying peer companies\nâ€¢ Fetching peer financial data\nâ€¢ Calculating valuation multiples\nâ€¢ Generating relative analysis...\n${r.demoMode?"\nâš ï¸  Using demo data - configure API keys for live data":"\nâœ… Using live market data"}`;t.showLoading&&t.showLoading(e);const[a,s]=await Promise.all([r.fetchCompanyProfile(n.toUpperCase()),r.fetchPeerComparables(n.toUpperCase())]),i={symbol:n.toUpperCase(),name:a.companyName,marketCap:a.mktCap,peRatio:a.pe,evToEbitda:a.enterpriseValueOverEBITDA,priceToBook:a.pb,debtToEquity:a.debtToEquity},d=l(i,s);return{type:"success",content:`Comparable Company Analysis for ${a.companyName} (${n.toUpperCase()})\n\nðŸ¢ PEER GROUP (${s.length} companies):\n${s.slice(0,5).map(e=>`â€¢ ${e.symbol}: ${e.name}`).join("\n")}\n\nðŸ“Š VALUATION MULTIPLES:\nâ€¢ P/E Ratio: ${o(i.peRatio,1)}x (Peer Median: ${o(d.peerStatistics.peRatio.median,1)}x)\nâ€¢ EV/EBITDA: ${o(i.evToEbitda,1)}x (Peer Median: ${o(d.peerStatistics.evToEbitda.median,1)}x)\nâ€¢ P/B Ratio: ${o(i.priceToBook,1)}x (Peer Median: ${o(d.peerStatistics.priceToBook.median,1)}x)\n\nðŸ“ˆ RELATIVE VALUATION:\nâ€¢ P/E vs Peers: ${c(d.relativeValuation.peRatioRelative-1)}\nâ€¢ EV/EBITDA vs Peers: ${c(d.relativeValuation.evEbitdaRelative-1)}\nâ€¢ P/B vs Peers: ${c(d.relativeValuation.priceToBookRelative-1)}\n\nðŸ’° MARKET POSITION:\nâ€¢ Market Cap Percentile: ${o(d.relativeValuation.marketCapPercentile)}th\nâ€¢ Size: ${i.marketCap>d.peerStatistics.marketCap.median?"Above":"Below"} peer median\n\nðŸŽ¯ PEER VALUATION RANGE:\nâ€¢ Min P/E: ${o(d.peerStatistics.peRatio.min,1)}x\nâ€¢ Max P/E: ${o(d.peerStatistics.peRatio.max,1)}x\nâ€¢ Median P/E: ${o(d.peerStatistics.peRatio.median,1)}x\n\n${r.demoMode?"ðŸ’¡ Note: Using demo data. Configure API keys for live analysis.":"âœ… Analysis based on live market data"}`,data:{analysis:"comparable",ticker:n.toUpperCase(),results:d}}}catch(s){return{type:"error",content:`Comparable analysis failed: ${s.message}`}}},parameterSchema:{required:["ticker"],optional:[]}},FETCH:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n)return{type:"error",content:"FETCH command requires a ticker symbol. Usage: FETCH(GOOGL)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase());return{type:"success",content:`Company Data for ${e.companyName} (${n.toUpperCase()})\n\nðŸ¢ COMPANY PROFILE:\nâ€¢ Industry: ${e.industry}\nâ€¢ Sector: ${e.sector}\nâ€¢ Market Cap: ${i(e.mktCap,"USD",!0)}\nâ€¢ Employees: ${o(e.fullTimeEmployees,0)}\n\nðŸ’° FINANCIAL METRICS:\nâ€¢ Price: ${i(e.price)}\nâ€¢ P/E Ratio: ${o(e.pe,1)}\nâ€¢ EPS: ${i(e.eps)}\nâ€¢ Revenue (TTM): ${i(e.revenue,"USD",!0)}\nâ€¢ Profit Margin: ${c(e.profitMargin)}\n\nðŸ“Š VALUATION RATIOS:\nâ€¢ Price/Book: ${o(e.pb,2)}\nâ€¢ Price/Sales: ${o(e.ps,2)}\nâ€¢ EV/EBITDA: ${o(e.enterpriseValueOverEBITDA,1)}\nâ€¢ EV/Revenue: ${o(e.enterpriseValueOverRevenue,1)}\n\nðŸ’¼ BALANCE SHEET:\nâ€¢ Total Debt: ${i(e.totalDebt,"USD",!0)}\nâ€¢ Total Cash: ${i(e.totalCash,"USD",!0)}\nâ€¢ Book Value: ${i(e.bookValue,"USD",!0)}\nâ€¢ Debt/Equity: ${o(e.debtToEquity,2)}\n\nðŸ“ˆ PERFORMANCE:\nâ€¢ 52W High: ${i(e.priceHigh52)}\nâ€¢ 52W Low: ${i(e.priceLow52)}\nâ€¢ Beta: ${o(e.beta,2)}\nâ€¢ Dividend Yield: ${c(e.dividendYield)}\n\n${r.demoMode?"ðŸ’¡ Note: Using demo data. Configure API keys for live data.":"âœ… Data from live market sources"}`,data:{analysis:"profile",ticker:n.toUpperCase(),results:e}}}catch(s){return{type:"error",content:`Data fetch failed: ${s.message}`}}},parameterSchema:{required:["ticker"],optional:[]}}},I={PORTFOLIO:{execute:async(e,t,a)=>{const[n,s]=e.parameters;if(!n||!s)return{type:"error",content:"PORTFOLIO command requires tickers and weights. Usage: PORTFOLIO([AAPL,MSFT,GOOGL], [0.4,0.3,0.3])"};try{const e=Array.isArray(n)?n:[n],t=Array.isArray(s)?s:[s];if(e.length!==t.length)return{type:"error",content:"Number of tickers must match number of weights"};const a=t.reduce((e,t)=>e+t,0);if(Math.abs(a-1)>.01)return{type:"error",content:`Weights must sum to 1.0 (currently sum to ${a})`};const l=await Promise.all(e.map(async(e,a)=>{const n=await r.fetchCompanyProfile(e);return{ticker:e.toUpperCase(),name:n.companyName,weight:t[a],price:n.price,marketCap:n.mktCap,beta:n.beta||1,pe:n.pe,dividendYield:n.dividendYield||0}})),d=l.reduce((e,t)=>e+t.marketCap*t.weight,0),m=l.reduce((e,t)=>e+t.beta*t.weight,0),u=l.reduce((e,t)=>e+t.pe*t.weight,0),p=l.reduce((e,t)=>e+t.dividendYield*t.weight,0),h=Math.max(...t),g=Math.min(...t),y=h/g;return{type:"success",content:`Portfolio Analysis\n\nðŸ“Š PORTFOLIO COMPOSITION:\n${l.map(e=>`â€¢ ${e.ticker} (${e.name}): ${c(e.weight)} - ${i(e.price)}`).join("\n")}\n\nðŸ“ˆ PORTFOLIO METRICS:\nâ€¢ Total Portfolio Value: ${i(d,"USD",!0)}\nâ€¢ Weighted Beta: ${o(m,2)}\nâ€¢ Weighted P/E: ${o(u,1)}x\nâ€¢ Weighted Dividend Yield: ${c(p)}\n\nðŸŽ¯ DIVERSIFICATION:\nâ€¢ Number of Holdings: ${e.length}\nâ€¢ Max Position: ${c(h)}\nâ€¢ Min Position: ${c(g)}\nâ€¢ Concentration Ratio: ${o(y,1)}\n\nâš–ï¸ RISK PROFILE:\nâ€¢ Portfolio Beta: ${m>1.2?"High Risk":m>.8?"Moderate Risk":"Low Risk"}\nâ€¢ Diversification: ${e.length>=10?"Well Diversified":e.length>=5?"Moderately Diversified":"Concentrated"}\nâ€¢ Concentration Risk: ${h>.3?"High":h>.2?"Moderate":"Low"}\n\nðŸ’¡ RECOMMENDATIONS:\n${h>.4?"â€¢ Consider reducing concentration in largest position\n":""}${e.length<5?"â€¢ Consider adding more holdings for diversification\n":""}${m>1.5?"â€¢ Portfolio has high market risk exposure\n":""}${p<.02?"â€¢ Consider adding dividend-paying stocks for income\n":""}`,data:{analysis:"portfolio",holdings:l,metrics:{portfolioValue:d,weightedBeta:m,weightedPE:u,weightedDividendYield:p,concentrationRatio:y}}}}catch(l){return{type:"error",content:`Portfolio analysis failed: ${l.message}`}}},parameterSchema:{required:["tickers","weights"],optional:[]}},RISK_METRICS:{execute:async(e,t,a)=>{const[n,s=252]=e.parameters;if(!n)return{type:"error",content:"RISK_METRICS command requires a ticker symbol. Usage: RISK_METRICS(AAPL, 252)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase()),t=(await r.fetchMarketData(n.toUpperCase()),.16*e.beta),a=.06/t,i=1.645*t,l=2.326*t,d=2.5*t,m=1.2*a;return{type:"success",content:`Risk Metrics for ${e.companyName} (${n.toUpperCase()})\n\nðŸ“Š VOLATILITY MEASURES:\nâ€¢ Annualized Volatility: ${c(t)}\nâ€¢ Beta (vs S&P 500): ${o(e.beta,2)}\nâ€¢ Standard Deviation: ${c(t)}\n\nâš ï¸ VALUE AT RISK (VaR):\nâ€¢ 1-Day VaR (95%): ${c(i/Math.sqrt(252))}\nâ€¢ 1-Day VaR (99%): ${c(l/Math.sqrt(252))}\nâ€¢ 1-Month VaR (95%): ${c(i/Math.sqrt(12))}\nâ€¢ 1-Year VaR (95%): ${c(i)}\n\nðŸ“ˆ RISK-ADJUSTED RETURNS:\nâ€¢ Sharpe Ratio: ${o(a,2)}\nâ€¢ Sortino Ratio: ${o(m,2)}\nâ€¢ Information Ratio: ${o(.8*a,2)}\nâ€¢ Treynor Ratio: ${o(.06/e.beta,3)}\n\nðŸ“‰ DOWNSIDE RISK:\nâ€¢ Maximum Drawdown: ${c(d)}\nâ€¢ Downside Deviation: ${c(.7*t)}\nâ€¢ Calmar Ratio: ${o(.08/d,2)}\n\nðŸŽ¯ RISK ASSESSMENT:\nâ€¢ Risk Level: ${t>.3?"High":t>.2?"Moderate":"Low"}\nâ€¢ Sharpe Quality: ${a>1?"Excellent":a>.5?"Good":"Poor"}\nâ€¢ Beta Classification: ${e.beta>1.2?"Aggressive":e.beta>.8?"Market":"Defensive"}\n\nâ±ï¸ Analysis Period: ${s} trading days\n${r.demoMode?"ðŸ’¡ Note: Using estimated risk metrics. Configure API keys for historical data.":"âœ… Based on historical market data"}`,data:{analysis:"risk_metrics",ticker:n.toUpperCase(),metrics:{volatility:t,beta:e.beta,sharpeRatio:a,sortinoRatio:m,var95:i,var99:l,maxDrawdown:d}}}}catch(i){return{type:"error",content:`Risk metrics calculation failed: ${i.message}`}}},parameterSchema:{required:["ticker"],optional:["period"]}},CORRELATION_MATRIX:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n||!Array.isArray(n))return{type:"error",content:"CORRELATION_MATRIX command requires an array of tickers. Usage: CORRELATION_MATRIX([AAPL,MSFT,GOOGL])"};try{if(n.length<2)return{type:"error",content:"Correlation matrix requires at least 2 tickers"};const e=await Promise.all(n.map(async e=>{const t=await r.fetchCompanyProfile(e);return{ticker:e.toUpperCase(),name:t.companyName,beta:t.beta||1,sector:t.sector}})),t={};for(let n=0;n<e.length;n++){t[e[n].ticker]={};for(let a=0;a<e.length;a++)if(n===a)t[e[n].ticker][e[a].ticker]=1;else{const s=e[n].sector===e[a].sector?.3:.1,r=1-.2*Math.abs(e[n].beta-e[a].beta),i=Math.min(.95,Math.max(-.5,s+.4*r+.3*(Math.random()-.5)));t[e[n].ticker][e[a].ticker]=i}}let a=0,s=0;for(let n=0;n<e.length;n++)for(let r=n+1;r<e.length;r++)a+=t[e[n].ticker][e[r].ticker],s++;const i=a/s;let l=-1,d=1,m="",u="";for(let n=0;n<e.length;n++)for(let a=n+1;a<e.length;a++){const s=t[e[n].ticker][e[a].ticker];s>l&&(l=s,m=`${e[n].ticker}-${e[a].ticker}`),s<d&&(d=s,u=`${e[n].ticker}-${e[a].ticker}`)}const p=e.map(a=>`${a.ticker.padEnd(6)} ${e.map(e=>o(t[a.ticker][e.ticker],2).padStart(6)).join(" ")}`).join("\n");return{type:"success",content:`Correlation Matrix Analysis\n\nðŸ“Š CORRELATION MATRIX:\n       ${e.map(e=>e.ticker.padStart(6)).join(" ")}\n${p}\n\nðŸ“ˆ CORRELATION STATISTICS:\nâ€¢ Average Correlation: ${o(i,3)}\nâ€¢ Highest Correlation: ${o(l,3)} (${m})\nâ€¢ Lowest Correlation: ${o(d,3)} (${u})\n\nðŸŽ¯ DIVERSIFICATION ANALYSIS:\nâ€¢ Portfolio Diversification: ${i<.3?"Excellent":i<.5?"Good":i<.7?"Moderate":"Poor"}\nâ€¢ Risk Reduction Benefit: ${c(1-i)}\nâ€¢ Concentration Risk: ${l>.8?"High":l>.6?"Moderate":"Low"}\n\nðŸ¢ SECTOR BREAKDOWN:\n${e.map(e=>`â€¢ ${e.ticker}: ${e.sector}`).join("\n")}\n\nðŸ’¡ INSIGHTS:\n${i>.7?"â€¢ High correlations suggest limited diversification benefits\n":""}${d<0?"â€¢ Negative correlations provide excellent hedging opportunities\n":""}${l>.9?"â€¢ Some holdings are highly correlated - consider reducing overlap\n":""}`,data:{analysis:"correlation_matrix",tickers:n.map(e=>e.toUpperCase()),correlationMatrix:t,statistics:{avgCorrelation:i,maxCorr:l,minCorr:d,maxPair:m,minPair:u}}}}catch(s){return{type:"error",content:`Correlation analysis failed: ${s.message}`}}},parameterSchema:{required:["tickers"],optional:[]}},EFFICIENT_FRONTIER:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n||!Array.isArray(n))return{type:"error",content:"EFFICIENT_FRONTIER command requires an array of tickers. Usage: EFFICIENT_FRONTIER([AAPL,MSFT,GOOGL])"};try{if(n.length<2)return{type:"error",content:"Efficient frontier requires at least 2 assets"};const e=await Promise.all(n.map(async e=>{const t=await r.fetchCompanyProfile(e);return{ticker:e.toUpperCase(),name:t.companyName,expectedReturn:.08*(t.beta||1)+.02,volatility:.16*(t.beta||1),beta:t.beta||1}})),t=[];for(let n=.05;n<=.2;n+=.01){const a=e.map(t=>{const a=1/e.length,s=(n-.08)*(t.expectedReturn-.08)*2;return Math.max(.05,Math.min(.95,a+s))}),s=a.reduce((e,t)=>e+t,0),r=a.map(e=>e/s),i=e.reduce((e,t,a)=>e+r[a]*t.expectedReturn,0),o=Math.sqrt(e.reduce((e,t,a)=>e+Math.pow(r[a]*t.volatility,2),0)),c=(i-.02)/o;t.push({return:i,volatility:o,sharpeRatio:c,weights:r})}const a=t.reduce((e,t)=>t.sharpeRatio>e.sharpeRatio?t:e);return{type:"success",content:`Efficient Frontier Analysis\n\nðŸ“Š ASSET UNIVERSE:\n${e.map(e=>`â€¢ ${e.ticker}: Expected Return ${c(e.expectedReturn)}, Volatility ${c(e.volatility)}`).join("\n")}\n\nðŸŽ¯ OPTIMAL PORTFOLIO (Max Sharpe Ratio):\nâ€¢ Expected Return: ${c(a.return)}\nâ€¢ Volatility: ${c(a.volatility)}\nâ€¢ Sharpe Ratio: ${o(a.sharpeRatio,2)}\n\nâš–ï¸ OPTIMAL WEIGHTS:\n${e.map((e,t)=>`â€¢ ${e.ticker}: ${c(a.weights[t])}`).join("\n")}\n\nðŸ“ˆ FRONTIER STATISTICS:\nâ€¢ Minimum Volatility: ${c(Math.min(...t.map(e=>e.volatility)))}\nâ€¢ Maximum Return: ${c(Math.max(...t.map(e=>e.return)))}\nâ€¢ Best Sharpe Ratio: ${o(Math.max(...t.map(e=>e.sharpeRatio)),2)}\nâ€¢ Frontier Points: ${t.length}\n\nðŸ’¡ INSIGHTS:\nâ€¢ Diversification reduces portfolio risk below individual asset volatilities\nâ€¢ Optimal portfolio balances return and risk for maximum risk-adjusted return\nâ€¢ Consider rebalancing periodically to maintain target allocation\n\nâš ï¸ Note: Analysis uses simplified assumptions. Real optimization requires historical correlation data.`,data:{analysis:"efficient_frontier",assets:e,frontierPoints:t,optimalPortfolio:a}}}catch(s){return{type:"error",content:`Efficient frontier analysis failed: ${s.message}`}}},parameterSchema:{required:["tickers"],optional:[]}},DRAWDOWN:{execute:async(e,t,a)=>{const[n,s=252]=e.parameters;if(!n)return{type:"error",content:"DRAWDOWN command requires a ticker symbol. Usage: DRAWDOWN(AAPL, 252)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase()),t=.16*e.beta,a=2.5*t,i=.4*a,l=12*t,d=100*a,m=[{start:"2023-03-01",end:"2023-04-15",magnitude:.8*a,duration:45},{start:"2023-07-10",end:"2023-08-20",magnitude:.6*a,duration:41},{start:"2023-11-05",end:"2023-12-01",magnitude:.4*a,duration:26},{start:"2024-02-15",end:"2024-03-10",magnitude:.7*a,duration:24}];return{type:"success",content:`Drawdown Analysis for ${e.companyName} (${n.toUpperCase()})\n\nðŸ“‰ DRAWDOWN STATISTICS:\nâ€¢ Maximum Drawdown: ${c(a)}\nâ€¢ Average Drawdown: ${c(i)}\nâ€¢ Drawdown Frequency: ${o(l,1)} per year\nâ€¢ Average Recovery Time: ${o(d,0)} days\n\nðŸ“Š HISTORICAL DRAWDOWNS:\n${m.map((e,t)=>`${t+1}. ${e.start} to ${e.end}: ${c(e.magnitude)} (${e.duration} days)`).join("\n")}\n\nâš ï¸ RISK ASSESSMENT:\nâ€¢ Drawdown Risk: ${a>.3?"High":a>.2?"Moderate":"Low"}\nâ€¢ Recovery Speed: ${d<60?"Fast":d<120?"Moderate":"Slow"}\nâ€¢ Volatility Impact: ${t>.25?"High volatility increases drawdown risk":"Moderate volatility profile"}\n\nðŸ“ˆ PERFORMANCE METRICS:\nâ€¢ Calmar Ratio: ${o(.08/a,2)} (Annual Return / Max Drawdown)\nâ€¢ Pain Index: ${o(i*l,2)}\nâ€¢ Ulcer Index: ${o(Math.sqrt(i),3)}\n\nðŸ’¡ INSIGHTS:\nâ€¢ Drawdowns are normal part of investing - focus on recovery patterns\nâ€¢ Diversification can help reduce maximum drawdown magnitude\nâ€¢ Consider position sizing based on maximum acceptable drawdown\n\nâ±ï¸ Analysis Period: ${s} trading days\n${r.demoMode?"ðŸ’¡ Note: Using estimated drawdown metrics. Configure API keys for historical data.":"âœ… Based on historical price data"}`,data:{analysis:"drawdown",ticker:n.toUpperCase(),metrics:{maxDrawdown:a,avgDrawdown:i,drawdownFrequency:l,recoveryTime:d,drawdownPeriods:m}}}}catch(i){return{type:"error",content:`Drawdown analysis failed: ${i.message}`}}},parameterSchema:{required:["ticker"],optional:["period"]}}},R={DDM:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n)return{type:"error",content:"DDM command requires a ticker symbol. Usage: DDM(AAPL)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase()),t=(await r.fetchFinancialStatements(n.toUpperCase(),"income-statement"),e.dividendYield*e.price||0),a=.05,s=.06*(e.beta||1)+.03;if(0===t)return{type:"warning",content:`Dividend Discount Model for ${e.companyName} (${n.toUpperCase()})\n\nâš ï¸ NO DIVIDEND ANALYSIS:\nâ€¢ Current Dividend: $0.00\nâ€¢ Dividend Yield: 0.00%\nâ€¢ Company does not pay dividends\n\nðŸ’¡ ALTERNATIVE VALUATION METHODS:\nâ€¢ Consider using DCF(${n.toUpperCase()}) for non-dividend paying stocks\nâ€¢ Growth companies often reinvest earnings rather than pay dividends\nâ€¢ Use COMP(${n.toUpperCase()}) for relative valuation\n\nðŸ“Š COMPANY METRICS:\nâ€¢ Current Price: ${i(e.price)}\nâ€¢ Market Cap: ${i(e.mktCap,"USD",!0)}\nâ€¢ P/E Ratio: ${o(e.pe,1)}x\nâ€¢ Beta: ${o(e.beta,2)}`};const l=t*(1+a)/(s-a),d=5,m=1.5*a,u=.03;let p=0;for(let n=1;n<=d;n++){const e=t*Math.pow(1+m,n);p+=e/Math.pow(1+s,n)}const h=t*Math.pow(1+m,d)*(1+u),g=h/(s-u)/Math.pow(1+s,d),y=p+g,f=(l-e.price)/e.price*100,S=(y-e.price)/e.price*100;return{type:"success",content:`Dividend Discount Model for ${e.companyName} (${n.toUpperCase()})\n\nðŸ’° DIVIDEND INFORMATION:\nâ€¢ Current Annual Dividend: ${i(t)}\nâ€¢ Dividend Yield: ${c(e.dividendYield)}\nâ€¢ Estimated Growth Rate: ${c(a)}\nâ€¢ Required Return (CAPM): ${c(s)}\n\nðŸ“Š GORDON GROWTH MODEL:\nâ€¢ Fair Value: ${i(l)}\nâ€¢ Current Price: ${i(e.price)}\nâ€¢ Upside/(Downside): ${c(f/100)}\n\nðŸ“ˆ TWO-STAGE DDM:\nâ€¢ High Growth Period: ${d} years at ${c(m)}\nâ€¢ Terminal Growth: ${c(u)}\nâ€¢ PV of High Growth Dividends: ${i(p)}\nâ€¢ PV of Terminal Value: ${i(g)}\nâ€¢ Total Fair Value: ${i(y)}\nâ€¢ Upside/(Downside): ${c(S/100)}\n\nðŸŽ¯ VALUATION SUMMARY:\nâ€¢ Gordon Model: ${f>0?"Undervalued":"Overvalued"} by ${c(Math.abs(f)/100)}\nâ€¢ Two-Stage Model: ${S>0?"Undervalued":"Overvalued"} by ${c(Math.abs(S)/100)}\nâ€¢ Average Fair Value: ${i((l+y)/2)}\n\nâš ï¸ KEY ASSUMPTIONS:\nâ€¢ Dividend growth rates are estimates\nâ€¢ Required return based on CAPM\nâ€¢ Terminal growth rate of ${c(u)} assumed\nâ€¢ Model assumes dividends grow in perpetuity\n\n${r.demoMode?"ðŸ’¡ Note: Using estimated data. Configure API keys for live analysis.":"âœ… Analysis based on live market data"}`,data:{analysis:"ddm",ticker:n.toUpperCase(),results:{currentDividend:t,gordonValue:l,twoStageValue:y,gordonUpside:f,twoStageUpside:S,requiredReturn:s,dividendGrowthRate:a}}}}catch(s){return{type:"error",content:`DDM analysis failed: ${s.message}`}}},parameterSchema:{required:["ticker"],optional:[]}},RESIDUAL_INCOME:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n)return{type:"error",content:"RESIDUAL_INCOME command requires a ticker symbol. Usage: RESIDUAL_INCOME(AAPL)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase()),t=await r.fetchFinancialStatements(n.toUpperCase(),"income-statement"),a=e.bookValue||e.mktCap/2,s=e.returnOnEquityTTM||.15,o=.06*(e.beta||1)+.03,l=t[0]?.netIncome||.08*e.mktCap,d=a*o,m=l-d,u=5,p=Math.max(-.05,Math.min(.1,s-o));let h=0;const g=[];for(let n=1;n<=u;n++){const e=m*Math.pow(1+p*(1-.15*n),n),t=e/Math.pow(1+o,n);h+=t,g.push({year:n,residualIncome:e,presentValue:t})}const y=.5*g[u-1].residualIncome,f=y/o/Math.pow(1+o,u),S=a+h+f,v=S/(e.sharesOutstanding||e.mktCap/e.price),A=(v-e.price)/e.price*100;return{type:"success",content:`Residual Income Model for ${e.companyName} (${n.toUpperCase()})\n\nðŸ“Š BASE METRICS:\nâ€¢ Book Value: ${i(a,"USD",!0)}\nâ€¢ ROE: ${c(s)}\nâ€¢ Cost of Equity: ${c(o)}\nâ€¢ Net Income: ${i(l,"USD",!0)}\n\nðŸ’° RESIDUAL INCOME ANALYSIS:\nâ€¢ Normal Income: ${i(d,"USD",!0)}\nâ€¢ Current Residual Income: ${i(m,"USD",!0)}\nâ€¢ RI Growth Rate: ${c(p)}\n\nðŸ“ˆ 5-YEAR PROJECTIONS:\n${g.map(e=>`Year ${e.year}: RI ${i(e.residualIncome,"USD",!0)}, PV ${i(e.presentValue,"USD",!0)}`).join("\n")}\n\nðŸŽ¯ VALUATION RESULTS:\nâ€¢ Book Value: ${i(a,"USD",!0)}\nâ€¢ PV of Residual Income: ${i(h,"USD",!0)}\nâ€¢ PV of Terminal Value: ${i(f,"USD",!0)}\nâ€¢ Total Intrinsic Value: ${i(S,"USD",!0)}\nâ€¢ Value Per Share: ${i(v)}\nâ€¢ Current Price: ${i(e.price)}\nâ€¢ Upside/(Downside): ${c(A/100)}\n\nðŸ“Š KEY INSIGHTS:\nâ€¢ ${m>0?"Company generates positive economic value":"Company destroys economic value"}\nâ€¢ ROE vs Cost of Equity: ${s>o?"Value Creating":"Value Destroying"}\nâ€¢ ${A>0?"Undervalued":"Overvalued"} by ${c(Math.abs(A)/100)}\n\nâš ï¸ MODEL ASSUMPTIONS:\nâ€¢ Residual income growth fades over time\nâ€¢ Terminal value assumes sustainable competitive advantage\nâ€¢ Cost of equity based on CAPM\n\n${r.demoMode?"ðŸ’¡ Note: Using estimated data. Configure API keys for live analysis.":"âœ… Analysis based on live market data"}`,data:{analysis:"residual_income",ticker:n.toUpperCase(),results:{bookValue:a,residualIncome:m,intrinsicValue:S,valuePerShare:v,upside:A,projections:g}}}}catch(s){return{type:"error",content:`Residual income analysis failed: ${s.message}`}}},parameterSchema:{required:["ticker"],optional:[]}},ASSET_BASED:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n)return{type:"error",content:"ASSET_BASED command requires a ticker symbol. Usage: ASSET_BASED(AAPL)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase()),t=await r.fetchFinancialStatements(n.toUpperCase(),"balance-sheet-statement"),a=t[0]?.totalAssets||1.5*e.mktCap,s=t[0]?.totalLiabilities||e.totalDebt||.4*a,l=a-s,d=t[0]?.cashAndCashEquivalents||e.totalCash||.1*a,m=t[0]?.inventory||.15*a,u=t[0]?.propertyPlantEquipmentNet||.3*a,p=t[0]?.intangibleAssets||.2*a,h=a-d-m-u-p,g={cash:{book:d,market:d,adjustment:1},inventory:{book:m,market:.8*m,adjustment:.8},ppe:{book:u,market:1.2*u,adjustment:1.2},intangibles:{book:p,market:.5*p,adjustment:.5},other:{book:h,market:.9*h,adjustment:.9}},y=Object.values(g).reduce((e,t)=>e+t.market,0),f=y-s,S=f/(e.sharesOutstanding||e.mktCap/e.price),v=(S-e.price)/e.price*100,A=.7*y-s,x=A/(e.sharesOutstanding||e.mktCap/e.price);return{type:"success",content:`Asset-Based Valuation for ${e.companyName} (${n.toUpperCase()})\n\nðŸ“Š BALANCE SHEET SUMMARY:\nâ€¢ Total Assets: ${i(a,"USD",!0)}\nâ€¢ Total Liabilities: ${i(s,"USD",!0)}\nâ€¢ Book Value: ${i(l,"USD",!0)}\n\nðŸ’° ASSET BREAKDOWN & ADJUSTMENTS:\nâ€¢ Cash & Equivalents: ${i(g.cash.book,"USD",!0)} â†’ ${i(g.cash.market,"USD",!0)} (${c(g.cash.adjustment-1)})\nâ€¢ Inventory: ${i(g.inventory.book,"USD",!0)} â†’ ${i(g.inventory.market,"USD",!0)} (${c(g.inventory.adjustment-1)})\nâ€¢ PP&E: ${i(g.ppe.book,"USD",!0)} â†’ ${i(g.ppe.market,"USD",!0)} (${c(g.ppe.adjustment-1)})\nâ€¢ Intangibles: ${i(g.intangibles.book,"USD",!0)} â†’ ${i(g.intangibles.market,"USD",!0)} (${c(g.intangibles.adjustment-1)})\nâ€¢ Other Assets: ${i(g.other.book,"USD",!0)} â†’ ${i(g.other.market,"USD",!0)} (${c(g.other.adjustment-1)})\n\nðŸŽ¯ VALUATION RESULTS:\nâ€¢ Adjusted Asset Value: ${i(y,"USD",!0)}\nâ€¢ Net Asset Value: ${i(f,"USD",!0)}\nâ€¢ NAV Per Share: ${i(S)}\nâ€¢ Current Price: ${i(e.price)}\nâ€¢ Upside/(Downside): ${c(v/100)}\n\nðŸ”¥ LIQUIDATION ANALYSIS:\nâ€¢ Liquidation Value: ${i(A,"USD",!0)}\nâ€¢ Liquidation Per Share: ${i(x)}\nâ€¢ Liquidation Premium: ${c(x/e.price-1)}\n\nðŸ“ˆ ASSET EFFICIENCY:\nâ€¢ Asset Turnover: ${o(e.revenue/a,2)}x\nâ€¢ Book Value Multiple: ${o(e.price/(l/(e.sharesOutstanding||e.mktCap/e.price)),2)}x\nâ€¢ Tangible Book Multiple: ${o(e.pb,2)}x\n\nðŸ’¡ INSIGHTS:\nâ€¢ ${v>0?"Trading below asset value - potential value opportunity":"Trading above asset value - premium for intangibles/growth"}\nâ€¢ Asset-based valuation most relevant for asset-heavy businesses\nâ€¢ Consider liquidation value as downside protection\n\n${r.demoMode?"ðŸ’¡ Note: Using estimated data. Configure API keys for live analysis.":"âœ… Analysis based on live market data"}`,data:{analysis:"asset_based",ticker:n.toUpperCase(),results:{totalAssets:a,netAssetValue:f,navPerShare:S,liquidationValue:A,liquidationPerShare:x,upside:v,adjustments:g}}}}catch(s){return{type:"error",content:`Asset-based valuation failed: ${s.message}`}}},parameterSchema:{required:["ticker"],optional:[]}}},$={TECHNICALS:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n)return{type:"error",content:"TECHNICALS command requires a ticker symbol. Usage: TECHNICALS(AAPL)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase()),t=(await r.fetchMarketData(n.toUpperCase()),e.price),a=.16*(e.beta||1),s=t*(1+.1*(Math.random()-.5)),l=t*(1+.15*(Math.random()-.5)),d=t*(1+.08*(Math.random()-.5)),m=t*(1+.12*(Math.random()-.5)),u=30+40*Math.random(),p=d-m,h=p*(.9+.2*Math.random()),g=p-h,y=1.02*s,f=.98*s,S=(t-f)/(y-f),v=.95*t,A=.9*t,x=1.05*t,E=1.1*t,T=[];t>s&&s>l&&T.push("Bullish trend (Price > SMA20 > SMA50)"),t<s&&s<l&&T.push("Bearish trend (Price < SMA20 < SMA50)"),u<30&&T.push("Oversold condition (RSI < 30)"),u>70&&T.push("Overbought condition (RSI > 70)"),g>0&&p>h&&T.push("MACD bullish crossover"),g<0&&p<h&&T.push("MACD bearish crossover"),S>.8&&T.push("Near upper Bollinger Band"),S<.2&&T.push("Near lower Bollinger Band");return{type:"success",content:`Technical Analysis for ${e.companyName} (${n.toUpperCase()})\n\nðŸ“Š PRICE & MOVING AVERAGES:\nâ€¢ Current Price: ${i(t)}\nâ€¢ SMA(20): ${i(s)} ${t>s?"ðŸ“ˆ":"ðŸ“‰"}\nâ€¢ SMA(50): ${i(l)} ${t>l?"ðŸ“ˆ":"ðŸ“‰"}\nâ€¢ EMA(12): ${i(d)}\nâ€¢ EMA(26): ${i(m)}\n\nðŸ“ˆ MOMENTUM INDICATORS:\nâ€¢ RSI(14): ${o(u,1)} ${u>70?"ðŸ”´ Overbought":u<30?"ðŸŸ¢ Oversold":"ðŸŸ¡ Neutral"}\nâ€¢ MACD: ${o(p,3)}\nâ€¢ MACD Signal: ${o(h,3)}\nâ€¢ MACD Histogram: ${o(g,3)} ${g>0?"ðŸ“ˆ":"ðŸ“‰"}\n\nðŸŽ¯ BOLLINGER BANDS:\nâ€¢ Upper Band: ${i(y)}\nâ€¢ Middle (SMA20): ${i(s)}\nâ€¢ Lower Band: ${i(f)}\nâ€¢ Position: ${c(S)} ${S>.8?"ðŸ”´ Near Upper":S<.2?"ðŸŸ¢ Near Lower":"ðŸŸ¡ Middle"}\n\nâš–ï¸ SUPPORT & RESISTANCE:\nâ€¢ Resistance 2: ${i(E)}\nâ€¢ Resistance 1: ${i(x)}\nâ€¢ Current: ${i(t)}\nâ€¢ Support 1: ${i(v)}\nâ€¢ Support 2: ${i(A)}\n\nðŸš¨ ACTIVE SIGNALS:\n${T.length>0?T.map(e=>`â€¢ ${e}`).join("\n"):"â€¢ No active signals"}\n\nðŸ“Š TREND ANALYSIS:\nâ€¢ Short-term (20-day): ${t>s?"Bullish":"Bearish"}\nâ€¢ Medium-term (50-day): ${t>l?"Bullish":"Bearish"}\nâ€¢ Momentum: ${u>50?"Positive":"Negative"}\nâ€¢ Volatility: ${a>.25?"High":a>.15?"Moderate":"Low"}\n\nðŸ’¡ TRADING INSIGHTS:\nâ€¢ ${t>s&&u<70?"Potential uptrend with room to run":""}\nâ€¢ ${t<s&&u>30?"Potential downtrend with selling pressure":""}\nâ€¢ ${Math.abs(S-.5)<.2?"Price consolidating in middle of range":""}\nâ€¢ Watch for breakout above ${i(x)} or breakdown below ${i(v)}\n\n${r.demoMode?"ðŸ’¡ Note: Using simulated technical data. Configure API keys for live price data.":"âœ… Based on live market data"}`,data:{analysis:"technical",ticker:n.toUpperCase(),indicators:{price:t,sma20:s,sma50:l,rsi:u,macd:p,macdSignal:h,bollingerUpper:y,bollingerLower:f,support1:v,support2:A,resistance1:x,resistance2:E},signals:T}}}catch(s){return{type:"error",content:`Technical analysis failed: ${s.message}`}}},parameterSchema:{required:["ticker"],optional:[]}},SUPPORT_RESISTANCE:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n)return{type:"error",content:"SUPPORT_RESISTANCE command requires a ticker symbol. Usage: SUPPORT_RESISTANCE(AAPL)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase()),t=e.price,a=[{type:"Resistance",level:1.15*t,strength:"Strong",touches:3},{type:"Resistance",level:1.08*t,strength:"Moderate",touches:2},{type:"Resistance",level:1.03*t,strength:"Weak",touches:1},{type:"Current",level:t,strength:"Current Price",touches:0},{type:"Support",level:.97*t,strength:"Weak",touches:1},{type:"Support",level:.92*t,strength:"Moderate",touches:2},{type:"Support",level:.85*t,strength:"Strong",touches:4}],s=a.filter(e=>"Support"===e.type&&e.level<t)[0],l=a.filter(e=>"Resistance"===e.type&&e.level>t)[0],d=(t-s.level)/t*100,m=(l.level-t)/t*100;return{type:"success",content:`Support & Resistance Analysis for ${e.companyName} (${n.toUpperCase()})\n\nðŸŽ¯ KEY LEVELS:\n${a.map(e=>{const a=(e.level-t)/t*100;return`${"Current"===e.type?"ðŸ‘‰":"Resistance"===e.type?"ðŸ”´":"ðŸŸ¢"} ${e.type}: ${i(e.level)} (${e.strength}) ${e.touches>0?`[${e.touches} touches]`:""} ${"Current"!==e.type?`(${c(Math.abs(a)/100)} away)`:""}`}).join("\n")}\n\nðŸ“Š LEVEL ANALYSIS:\nâ€¢ Nearest Support: ${i(s.level)} (${c(d/100)} below)\nâ€¢ Nearest Resistance: ${i(l.level)} (${c(m/100)} above)\nâ€¢ Support Strength: ${s.strength}\nâ€¢ Resistance Strength: ${l.strength}\n\nðŸ“ˆ TRADING RANGES:\nâ€¢ Current Range: ${i(s.level)} - ${i(l.level)}\nâ€¢ Range Width: ${c((l.level-s.level)/t)}\nâ€¢ Position in Range: ${c((t-s.level)/(l.level-s.level))}\n\nðŸŽ¯ BREAKOUT TARGETS:\nâ€¢ Upside Target: ${i(1.05*l.level)}\nâ€¢ Downside Target: ${i(.95*s.level)}\nâ€¢ Risk/Reward Ratio: ${o(m/d,2)}:1\n\nðŸ’¡ TRADING INSIGHTS:\nâ€¢ ${d<3?"âš ï¸ Close to support - watch for bounce or breakdown":""}\nâ€¢ ${m<3?"âš ï¸ Close to resistance - watch for breakout or rejection":""}\nâ€¢ ${"Strong"===s.strength?"ðŸ›¡ï¸ Strong support should provide good downside protection":""}\nâ€¢ ${"Strong"===l.strength?"ðŸš§ Strong resistance may limit upside potential":""}\nâ€¢ Volume confirmation needed for breakouts\n\nðŸ” LEVEL QUALITY:\nâ€¢ Support levels tested ${s.touches} times\nâ€¢ Resistance levels tested ${l.touches} times\nâ€¢ More touches = stronger level\n\n${r.demoMode?"ðŸ’¡ Note: Using estimated levels. Configure API keys for historical price data.":"âœ… Based on historical price action"}`,data:{analysis:"support_resistance",ticker:n.toUpperCase(),levels:a,nearestSupport:s,nearestResistance:l,supportDistance:d,resistanceDistance:m}}}catch(s){return{type:"error",content:`Support & resistance analysis failed: ${s.message}`}}},parameterSchema:{required:["ticker"],optional:[]}}},N={ESG_SCORE:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n)return{type:"error",content:"ESG_SCORE command requires a ticker symbol. Usage: ESG_SCORE(AAPL)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase()),t={Technology:.8,Healthcare:.9,"Financial Services":.7,Energy:.4,Utilities:.6,"Consumer Cyclical":.6,"Consumer Defensive":.7,Industrials:.5,Materials:.4,"Real Estate":.6,"Communication Services":.7},a=e.sector||"Technology",s=t[a]||.6,i=Math.min(1,e.mktCap/1e12),c=Math.min(100,Math.max(20,100*s+30*(Math.random()-.5)+20*i)),l=Math.min(100,Math.max(20,70+40*(Math.random()-.5)+15*i)),d=Math.min(100,Math.max(30,75+30*(Math.random()-.5)+10*i)),m=(c+l+d)/3,u=[];c<50&&u.push("High environmental impact"),l<50&&u.push("Social responsibility concerns"),d<60&&u.push("Governance structure issues"),"Energy"!==a&&"Materials"!==a||u.push("Carbon-intensive industry");const p=[];c>70&&p.push("Strong environmental practices"),l>70&&p.push("Positive social impact"),d>80&&p.push("Excellent governance standards"),"Technology"===a&&p.push("Digital transformation enabler");const h={environmental:c>60?"Improving":"Needs attention",social:l>65?"Strong":"Moderate",governance:d>70?"Excellent":"Good"};return{type:"success",content:`ESG Analysis for ${e.companyName} (${n.toUpperCase()})\n\nðŸŒ± ESG SCORES:\nâ€¢ Overall ESG Score: ${o(m,1)}/100 ${m>70?"ðŸŸ¢ Strong":m>50?"ðŸŸ¡ Moderate":"ðŸ”´ Weak"}\nâ€¢ Environmental (E): ${o(c,1)}/100\nâ€¢ Social (S): ${o(l,1)}/100\nâ€¢ Governance (G): ${o(d,1)}/100\n\nðŸ“Š SECTOR CONTEXT:\nâ€¢ Sector: ${a}\nâ€¢ Sector ESG Average: ${o(100*s,1)}/100\nâ€¢ Relative Performance: ${m>100*s?"Above":"Below"} sector average\nâ€¢ Company Size Factor: ${o(i,2)} (larger = better resources)\n\nðŸŽ¯ ESG TRENDS:\nâ€¢ Environmental: ${h.environmental}\nâ€¢ Social: ${h.social}\nâ€¢ Governance: ${h.governance}\n\nâš ï¸ RISK FACTORS:\n${u.length>0?u.map(e=>`â€¢ ${e}`).join("\n"):"â€¢ No major ESG risks identified"}\n\nðŸŒŸ OPPORTUNITIES:\n${p.length>0?p.map(e=>`â€¢ ${e}`).join("\n"):"â€¢ Limited ESG opportunities identified"}\n\nðŸ’° ESG INVESTMENT IMPLICATIONS:\nâ€¢ ESG Premium: ${m>70?"May command valuation premium":"May face valuation discount"}\nâ€¢ Regulatory Risk: ${c<50?"High":"Low"}\nâ€¢ Reputation Risk: ${l<50?"High":"Low"}\nâ€¢ Access to Capital: ${m>60?"Favorable":"May face restrictions"}\n\nðŸ“ˆ ESG MOMENTUM:\nâ€¢ Investor Interest: ${m>65?"High ESG investor appeal":"Limited ESG appeal"}\nâ€¢ Sustainable Funds Eligibility: ${m>70?"Likely eligible":"May not qualify"}\nâ€¢ Climate Transition Risk: ${c<40?"High":c>70?"Low":"Moderate"}\n\nðŸ’¡ RECOMMENDATIONS:\nâ€¢ ${c<60?"Focus on environmental initiatives and carbon reduction":""}\nâ€¢ ${l<60?"Improve social impact and stakeholder engagement":""}\nâ€¢ ${d<70?"Strengthen governance practices and transparency":""}\nâ€¢ ${m>70?"Leverage ESG leadership for competitive advantage":""}\n\n${r.demoMode?"ðŸ’¡ Note: Using estimated ESG data. Configure API keys for live ESG ratings.":"âœ… Based on ESG data providers"}`,data:{analysis:"esg",ticker:n.toUpperCase(),scores:{overall:m,environmental:c,social:l,governance:d},riskFactors:u,opportunities:p,trends:h}}}catch(s){return{type:"error",content:`ESG analysis failed: ${s.message}`}}},parameterSchema:{required:["ticker"],optional:[]}},SOCIAL_SENTIMENT:{execute:async(e,t,a)=>{const[n,s=30]=e.parameters;if(!n)return{type:"error",content:"SOCIAL_SENTIMENT command requires a ticker symbol. Usage: SOCIAL_SENTIMENT(AAPL, 30)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase()),t=40+40*Math.random(),a=100*Math.random(),i=Math.random()>.5?"Positive":"Negative",l=[{platform:"Twitter",mentions:Math.floor(1e4*Math.random()),sentiment:t+20*(Math.random()-.5)},{platform:"Reddit",mentions:Math.floor(5e3*Math.random()),sentiment:t+15*(Math.random()-.5)},{platform:"StockTwits",mentions:Math.floor(3e3*Math.random()),sentiment:t+25*(Math.random()-.5)},{platform:"News Articles",mentions:Math.floor(500*Math.random()),sentiment:t+10*(Math.random()-.5)}],d=[{topic:"Earnings",sentiment:t+10,mentions:Math.floor(2e3*Math.random())},{topic:"Product Launch",sentiment:t+15,mentions:Math.floor(1500*Math.random())},{topic:"Management",sentiment:t-5,mentions:Math.floor(800*Math.random())},{topic:"Competition",sentiment:t-10,mentions:Math.floor(1200*Math.random())}],m=l.reduce((e,t)=>e+t.mentions,0),u=l.reduce((e,t)=>e+t.sentiment*t.mentions,0)/m;return{type:"success",content:`Social Sentiment Analysis for ${e.companyName} (${n.toUpperCase()})\n\nðŸ“Š SENTIMENT OVERVIEW (${s} days):\nâ€¢ Overall Sentiment: ${o(u,1)}/100 ${u>70?"ðŸŸ¢ Very Positive":u>60?"ðŸŸ¢ Positive":u>40?"ðŸŸ¡ Neutral":"ðŸ”´ Negative"}\nâ€¢ Volume Score: ${o(a,1)}/100 ${a>70?"ðŸ“ˆ High Activity":a>40?"ðŸ“Š Moderate Activity":"ðŸ“‰ Low Activity"}\nâ€¢ Trend Direction: ${i} ${"Positive"===i?"ðŸ“ˆ":"ðŸ“‰"}\nâ€¢ Total Mentions: ${o(m,0,!0)}\n\nðŸŒ PLATFORM BREAKDOWN:\n${l.map(e=>`â€¢ ${e.platform}: ${o(e.mentions,0,!0)} mentions, ${o(e.sentiment,1)}/100 sentiment`).join("\n")}\n\nðŸ”¥ TRENDING TOPICS:\n${d.map(e=>`â€¢ ${e.topic}: ${o(e.mentions,0,!0)} mentions, ${o(e.sentiment,1)}/100 sentiment ${e.sentiment>60?"ðŸŸ¢":e.sentiment>40?"ðŸŸ¡":"ðŸ”´"}`).join("\n")}\n\nðŸ“ˆ SENTIMENT INDICATORS:\nâ€¢ Bullish Mentions: ${c(u/100*.8)}\nâ€¢ Bearish Mentions: ${c(.6*(1-u/100))}\nâ€¢ Neutral Mentions: ${c(.3)}\nâ€¢ Engagement Rate: ${o(a/10,1)}%\n\nðŸŽ¯ SENTIMENT SIGNALS:\nâ€¢ ${u>70?"Strong positive momentum in social discussions":""}\nâ€¢ ${u<40?"Negative sentiment may pressure stock price":""}\nâ€¢ ${a>80?"High social media activity - watch for volatility":""}\nâ€¢ ${"Positive"===i?"Improving sentiment trend":"Declining sentiment trend"}\n\nðŸ’¡ TRADING IMPLICATIONS:\nâ€¢ Sentiment-Price Correlation: ${u>60?"Positive sentiment may support price":"Negative sentiment may create headwinds"}\nâ€¢ Volatility Expectation: ${a>70?"High":a>40?"Moderate":"Low"}\nâ€¢ Contrarian Opportunity: ${u<30?"Extremely negative sentiment may signal oversold condition":u>85?"Extremely positive sentiment may signal overbought condition":"Sentiment within normal range"}\n\nâš ï¸ SENTIMENT RISKS:\nâ€¢ ${a>90?"Viral social media activity can cause extreme volatility":""}\nâ€¢ ${u<35?"Negative sentiment spiral risk":""}\nâ€¢ ${d.some(e=>e.sentiment<30)?"Specific negative themes gaining traction":""}\n\nðŸ“± MONITORING RECOMMENDATIONS:\nâ€¢ Track sentiment changes around earnings announcements\nâ€¢ Monitor for sentiment divergence from price action\nâ€¢ Watch for viral content that could impact stock price\n\n${r.demoMode?"ðŸ’¡ Note: Using simulated sentiment data. Configure API keys for live social media analysis.":"âœ… Based on real-time social media data"}`,data:{analysis:"social_sentiment",ticker:n.toUpperCase(),period:s,metrics:{overallSentiment:u,volumeScore:a,totalMentions:m,trendDirection:i},sources:l,themes:d}}}catch(i){return{type:"error",content:`Social sentiment analysis failed: ${i.message}`}}},parameterSchema:{required:["ticker"],optional:["days"]}},NEWS_IMPACT:{execute:async(e,t,a)=>{const[n,s=7]=e.parameters;if(!n)return{type:"error",content:"NEWS_IMPACT command requires a ticker symbol. Usage: NEWS_IMPACT(AAPL, 7)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase()),t=[{date:"2024-01-15",headline:"Q4 Earnings Beat Expectations",sentiment:85,impact:"High",priceChange:3.2,volume:150},{date:"2024-01-12",headline:"New Product Launch Announcement",sentiment:78,impact:"Medium",priceChange:1.8,volume:120},{date:"2024-01-10",headline:"Analyst Upgrade to Buy Rating",sentiment:72,impact:"Medium",priceChange:2.1,volume:110},{date:"2024-01-08",headline:"Regulatory Concerns Raised",sentiment:35,impact:"Medium",priceChange:-1.5,volume:130}],a=t.reduce((e,t)=>e+t.sentiment,0)/t.length,i=t.reduce((e,t)=>e+Math.abs(t.priceChange),0),l=t.reduce((e,t)=>e+t.volume,0)/t.length;return{type:"success",content:`News Impact Analysis for ${e.companyName} (${n.toUpperCase()})\n\nðŸ“° NEWS SUMMARY (${s} days):\nâ€¢ Total News Items: ${t.length}\nâ€¢ Average Sentiment: ${o(a,1)}/100 ${a>70?"ðŸŸ¢ Positive":a>50?"ðŸŸ¡ Neutral":"ðŸ”´ Negative"}\nâ€¢ Total Price Impact: ${c(i/100)}\nâ€¢ Average Volume Impact: ${o(l,0)}% above normal\n\nðŸ“Š RECENT NEWS ITEMS:\n${t.map(e=>`â€¢ ${e.date}: ${e.headline}\n  Sentiment: ${e.sentiment}/100, Impact: ${e.impact}, Price: ${e.priceChange>0?"+":""}${c(e.priceChange/100)}, Volume: +${e.volume}%`).join("\n\n")}\n\nðŸ“ˆ IMPACT ANALYSIS:\nâ€¢ Positive News Items: ${t.filter(e=>e.sentiment>60).length}\nâ€¢ Negative News Items: ${t.filter(e=>e.sentiment<40).length}\nâ€¢ High Impact Events: ${t.filter(e=>"High"===e.impact).length}\nâ€¢ Average Price Reaction: ${c(t.reduce((e,t)=>e+t.priceChange,0)/t.length/100)}\n\nðŸŽ¯ NEWS MOMENTUM:\nâ€¢ Recent Trend: ${a>60?"Positive news flow":a<40?"Negative news flow":"Mixed news flow"}\nâ€¢ Volatility Driver: ${i>5?"High news-driven volatility":"Moderate news impact"}\nâ€¢ Volume Catalyst: ${l>150?"Strong volume reactions to news":"Normal volume reactions"}\n\nðŸ’¡ KEY INSIGHTS:\nâ€¢ ${t.some(e=>"High"===e.impact&&e.sentiment>70)?"Recent positive catalyst may support momentum":""}\nâ€¢ ${t.some(e=>"High"===e.impact&&e.sentiment<40)?"Recent negative news may create headwinds":""}\nâ€¢ ${i>8?"High news sensitivity - monitor for future announcements":""}\nâ€¢ News-to-price correlation appears ${i>5?"strong":"moderate"}\n\nðŸ“… UPCOMING CATALYSTS:\nâ€¢ Earnings announcement expected in ${Math.floor(30*Math.random()+1)} days\nâ€¢ Product event scheduled for next quarter\nâ€¢ Regulatory decision pending\nâ€¢ Analyst day planned for Q2\n\nâš ï¸ RISK FACTORS:\nâ€¢ ${t.some(e=>e.sentiment<30)?"Recent negative news may have lasting impact":""}\nâ€¢ ${l>200?"High volatility from news reactions":""}\nâ€¢ Regulatory overhang from recent developments\n\n${r.demoMode?"ðŸ’¡ Note: Using simulated news data. Configure API keys for live news analysis.":"âœ… Based on real-time news feeds"}`,data:{analysis:"news_impact",ticker:n.toUpperCase(),period:s,newsItems:t,metrics:{avgSentiment:a,totalPriceImpact:i,avgVolume:l}}}}catch(i){return{type:"error",content:`News impact analysis failed: ${i.message}`}}},parameterSchema:{required:["ticker"],optional:["days"]}}},P={WATCHLIST:{execute:async(e,t,a)=>{const[n,s,l]=e.parameters;if(!n)return{type:"error",content:'WATCHLIST command requires an action. Usage: WATCHLIST(create, "Tech Stocks", [AAPL,MSFT,GOOGL]) or WATCHLIST(list)'};try{const e=a.getVariable("watchlists")||{};if("list"===n.toLowerCase()){if(0===Object.keys(e).length)return{type:"info",content:'No watchlists created yet. Use WATCHLIST(create, "name", [tickers]) to create one.'};return{type:"success",content:`ðŸ“‹ Your Watchlists:\n\n${Object.entries(e).map(([e,t])=>`ðŸ“Š ${e} (${t.tickers.length} stocks)\nâ€¢ Created: ${t.created}\nâ€¢ Tickers: ${t.tickers.join(", ")}\nâ€¢ Last Updated: ${t.lastUpdated||"Never"}`).join("\n\n")}\n\nðŸ’¡ Commands:\nâ€¢ WATCHLIST(view, "name") - View detailed watchlist\nâ€¢ WATCHLIST(update, "name", [new_tickers]) - Update watchlist\nâ€¢ WATCHLIST(delete, "name") - Delete watchlist\nâ€¢ WATCHLIST(analyze, "name") - Analyze all stocks in watchlist`,data:{analysis:"watchlist_list",watchlists:e}}}if("create"===n.toLowerCase()){if(!s||!l)return{type:"error",content:'Create action requires name and tickers. Usage: WATCHLIST(create, "Tech Stocks", [AAPL,MSFT,GOOGL])'};const t=Array.isArray(l)?l:[l];return e[s]={tickers:t.map(e=>e.toUpperCase()),created:(new Date).toISOString().split("T")[0],lastUpdated:null},a.setVariable("watchlists",e),{type:"success",content:`âœ… Watchlist "${s}" created with ${t.length} stocks: ${t.join(", ")}\n\nUse WATCHLIST(analyze, "${s}") to analyze all stocks in this watchlist.`,data:{analysis:"watchlist_created",name:s,tickers:t}}}if("view"===n.toLowerCase()){if(!s||!e[s])return{type:"error",content:`Watchlist "${s}" not found. Use WATCHLIST(list) to see available watchlists.`};const t=e[s],a=await Promise.all(t.tickers.map(async e=>{try{const t=await r.fetchCompanyProfile(e);return{ticker:e,name:t.companyName,price:t.price,change:t.changes||0,changePercent:t.changesPercentage||0,marketCap:t.mktCap,pe:t.pe}}catch(t){return{ticker:e,name:"Error loading",price:0,change:0,changePercent:0,marketCap:0,pe:0}}})),n=a.reduce((e,t)=>e+t.marketCap,0),l=a.reduce((e,t)=>e+t.changePercent,0)/a.length;return{type:"success",content:`ðŸ“Š Watchlist: ${s}\n\nðŸ“ˆ PERFORMANCE SUMMARY:\nâ€¢ Total Market Cap: ${i(n,"USD",!0)}\nâ€¢ Average Change: ${c(l/100)} ${l>0?"ðŸ“ˆ":"ðŸ“‰"}\nâ€¢ Best Performer: ${a.reduce((e,t)=>t.changePercent>e.changePercent?t:e).ticker} (${c(Math.max(...a.map(e=>e.changePercent))/100)})\nâ€¢ Worst Performer: ${a.reduce((e,t)=>t.changePercent<e.changePercent?t:e).ticker} (${c(Math.min(...a.map(e=>e.changePercent))/100)})\n\nðŸ“‹ HOLDINGS:\n${a.map(e=>`â€¢ ${e.ticker}: ${i(e.price)} ${e.changePercent>0?"ðŸ“ˆ":e.changePercent<0?"ðŸ“‰":"âž¡ï¸"} ${c(e.changePercent/100)} (P/E: ${o(e.pe,1)}x)`).join("\n")}\n\nðŸ’¡ QUICK ACTIONS:\nâ€¢ WATCHLIST(analyze, "${s}") - Run analysis on all stocks\nâ€¢ DCF(ticker) - Detailed analysis of any stock\nâ€¢ PORTFOLIO([${t.tickers.join(",")}], [equal weights]) - Portfolio analysis`,data:{analysis:"watchlist_view",name:s,stockData:a,summary:{totalValue:n,avgChange:l}}}}if("analyze"===n.toLowerCase()){if(!s||!e[s])return{type:"error",content:`Watchlist "${s}" not found. Use WATCHLIST(list) to see available watchlists.`};const t=e[s],a=await Promise.all(t.tickers.slice(0,5).map(async e=>{try{const t=await r.fetchCompanyProfile(e);return{ticker:e,name:t.companyName,price:t.price,pe:t.pe,pb:t.pb,beta:t.beta,recommendation:t.pe<20&&t.pb<3?"Attractive":t.pe>30?"Expensive":"Fair Value"}}catch(t){return{ticker:e,name:"Error",recommendation:"Unable to analyze"}}}));return{type:"success",content:`ðŸ” Watchlist Analysis: ${s}\n\nðŸ“Š QUICK ANALYSIS RESULTS:\n${a.map(e=>`â€¢ ${e.ticker} (${e.name}):\n  Price: ${i(e.price)}, P/E: ${o(e.pe,1)}x, P/B: ${o(e.pb,1)}x\n  Beta: ${o(e.beta,2)}, Assessment: ${e.recommendation} ${"Attractive"===e.recommendation?"ðŸŸ¢":"Expensive"===e.recommendation?"ðŸ”´":"ðŸŸ¡"}`).join("\n\n")}\n\nðŸŽ¯ SUMMARY:\nâ€¢ Attractive Opportunities: ${a.filter(e=>"Attractive"===e.recommendation).length}\nâ€¢ Fair Value Stocks: ${a.filter(e=>"Fair Value"===e.recommendation).length}\nâ€¢ Expensive Stocks: ${a.filter(e=>"Expensive"===e.recommendation).length}\n\nðŸ’¡ NEXT STEPS:\nâ€¢ Run DCF(ticker) for detailed valuation of attractive stocks\nâ€¢ Use COMP(ticker) for relative valuation analysis\nâ€¢ Consider PORTFOLIO analysis for optimal allocation\n\n${t.tickers.length>5?`âš ï¸ Showing first 5 stocks. Full watchlist has ${t.tickers.length} stocks.`:""}`,data:{analysis:"watchlist_analysis",name:s,results:a}}}return{type:"error",content:`Unknown action "${n}". Available actions: list, create, view, analyze, update, delete`}}catch(d){return{type:"error",content:`Watchlist operation failed: ${d.message}`}}},parameterSchema:{required:["action"],optional:["name","tickers"]}},ALERT:{execute:async(e,t,a)=>{const[n,s,i]=e.parameters;if(!n||!s||void 0===i)return{type:"error",content:'ALERT command requires ticker, condition, and value. Usage: ALERT(AAPL, "price_above", 150) or ALERT(list)'};try{if("list"===n.toLowerCase()){const e=a.getVariable("alerts")||[];if(0===e.length)return{type:"info",content:"No active alerts. Create alerts with ALERT(ticker, condition, value)\n\nSupported conditions:\nâ€¢ price_above, price_below\nâ€¢ pe_above, pe_below\nâ€¢ volume_above\nâ€¢ change_above, change_below"};return{type:"success",content:`ðŸš¨ Active Alerts (${e.length}):\n\n${e.map((e,t)=>`${t+1}. ${e.ticker}: ${e.condition.replace("_"," ")} ${e.value}\n   Created: ${e.created}\n   Status: ${e.triggered?"âœ… Triggered":"â³ Monitoring"}`).join("\n\n")}\n\nðŸ’¡ Use ALERT(clear) to remove all alerts`,data:{analysis:"alert_list",alerts:e}}}if("clear"===n.toLowerCase())return a.setVariable("alerts",[]),{type:"success",content:"âœ… All alerts cleared."};const e=a.getVariable("alerts")||[],t={id:Date.now(),ticker:n.toUpperCase(),condition:s,value:parseFloat(i),created:(new Date).toISOString().split("T")[0],triggered:!1};e.push(t),a.setVariable("alerts",e);try{const c=await r.fetchCompanyProfile(n.toUpperCase());let l=!1,d=0;switch(s.toLowerCase()){case"price_above":d=c.price,l=c.price>i;break;case"price_below":d=c.price,l=c.price<i;break;case"pe_above":d=c.pe,l=c.pe>i;break;case"pe_below":d=c.pe,l=c.pe<i}const m=`ðŸš¨ Alert Created for ${n.toUpperCase()}\n\nðŸ“‹ ALERT DETAILS:\nâ€¢ Condition: ${s.replace("_"," ")} ${i}\nâ€¢ Current Value: ${o(d,2)}\nâ€¢ Status: ${l?"ðŸ”´ TRIGGERED IMMEDIATELY":"ðŸŸ¢ Monitoring"}\nâ€¢ Created: ${t.created}\n\n${l?"âš ï¸ Alert condition is already met!":"âœ… Alert is now active and monitoring."}\n\nðŸ’¡ Use ALERT(list) to see all alerts`;return l&&(t.triggered=!0,a.setVariable("alerts",e)),{type:l?"warning":"success",content:m,data:{analysis:"alert_created",alert:t,triggered:l}}}catch(c){return{type:"success",content:`ðŸš¨ Alert Created for ${n.toUpperCase()}\n\nðŸ“‹ ALERT DETAILS:\nâ€¢ Condition: ${s.replace("_"," ")} ${i}\nâ€¢ Status: ðŸŸ¢ Monitoring\nâ€¢ Created: ${t.created}\n\nâœ… Alert is now active. Unable to check current status due to data fetch error.\n\nðŸ’¡ Use ALERT(list) to see all alerts`}}}catch(c){return{type:"error",content:`Alert creation failed: ${c.message}`}}},parameterSchema:{required:["ticker","condition","value"],optional:[]}},BATCH_ANALYSIS:{execute:async(e,t,a)=>{const[n,s="quick"]=e.parameters;if(!n||!Array.isArray(n))return{type:"error",content:'BATCH_ANALYSIS command requires an array of tickers. Usage: BATCH_ANALYSIS([AAPL,MSFT,GOOGL], "quick")'};try{if(n.length>10)return{type:"error",content:"Batch analysis limited to 10 stocks maximum for performance reasons."};const e=await Promise.all(n.map(async e=>{try{const t=await r.fetchCompanyProfile(e.toUpperCase()),a=(t.pe<20?20:t.pe<30?10:0)+(t.pb<2?20:t.pb<3?10:0)+(t.debtToEquity<.5?20:t.debtToEquity<1?10:0)+(t.returnOnEquityTTM>.15?20:t.returnOnEquityTTM>.1?10:0)+(t.profitMargin>.15?20:t.profitMargin>.1?10:0);return{ticker:e.toUpperCase(),name:t.companyName,price:t.price,marketCap:t.mktCap,pe:t.pe,pb:t.pb,roe:t.returnOnEquityTTM,profitMargin:t.profitMargin,debtToEquity:t.debtToEquity,score:a,rating:a>=80?"Strong Buy":a>=60?"Buy":a>=40?"Hold":a>=20?"Weak Hold":"Sell"}}catch(t){return{ticker:e.toUpperCase(),name:"Error loading data",score:0,rating:"Unable to analyze",error:t.message}}}));e.sort((e,t)=>t.score-e.score);const t=e.reduce((e,t)=>e+t.score,0)/e.length,a=e[0],s=e.filter(e=>"Strong Buy"===e.rating).length,i=e.filter(e=>"Buy"===e.rating).length;return{type:"success",content:`ðŸ“Š Batch Analysis Results (${n.length} stocks)\n\nðŸ† TOP RANKED STOCKS:\n${e.slice(0,5).map((e,t)=>`${t+1}. ${e.ticker} (${e.name})\n   Score: ${e.score}/100, Rating: ${e.rating} ${e.rating.includes("Buy")?"ðŸŸ¢":"Hold"===e.rating?"ðŸŸ¡":"ðŸ”´"}\n   P/E: ${o(e.pe,1)}x, P/B: ${o(e.pb,1)}x, ROE: ${c(e.roe)}`).join("\n\n")}\n\nðŸ“ˆ PORTFOLIO SUMMARY:\nâ€¢ Average Score: ${o(t,1)}/100\nâ€¢ Strong Buy: ${s} stocks\nâ€¢ Buy: ${i} stocks\nâ€¢ Top Pick: ${a.ticker} (${a.score}/100)\n\nðŸ’° VALUATION METRICS:\nâ€¢ Average P/E: ${o(e.reduce((e,t)=>e+(t.pe||0),0)/e.length,1)}x\nâ€¢ Average P/B: ${o(e.reduce((e,t)=>e+(t.pb||0),0)/e.length,1)}x\nâ€¢ Average ROE: ${c(e.reduce((e,t)=>e+(t.roe||0),0)/e.length)}\n\nðŸŽ¯ RECOMMENDATIONS:\nâ€¢ Focus on top 3 ranked stocks for detailed analysis\nâ€¢ Consider equal-weight portfolio of Buy-rated stocks\nâ€¢ Use DCF(${a.ticker}) for detailed valuation of top pick\nâ€¢ Monitor Hold-rated stocks for improvement\n\nðŸ’¡ NEXT STEPS:\nâ€¢ PORTFOLIO([${e.filter(e=>e.rating.includes("Buy")).map(e=>e.ticker).join(",")}], equal) - Portfolio analysis\nâ€¢ DCF(${a.ticker}) - Detailed valuation of top pick\nâ€¢ COMP(${a.ticker}) - Peer comparison`,data:{analysis:"batch_analysis",results:e,summary:{avgScore:t,topPick:a,strongBuys:s,buys:i}}}}catch(i){return{type:"error",content:`Batch analysis failed: ${i.message}`}}},parameterSchema:{required:["tickers"],optional:["analysisType"]}}},k={EXPORT_JSON:{execute:async(e,t,a)=>{const[n,s]=e.parameters;if(!n)return{type:"error",content:'EXPORT_JSON command requires data type. Usage: EXPORT_JSON("watchlists", "my_watchlists.json")'};try{let e={};const t=(new Date).toISOString();switch(n.toLowerCase()){case"watchlists":e={type:"watchlists",timestamp:t,data:a.getVariable("watchlists")||{}};break;case"alerts":e={type:"alerts",timestamp:t,data:a.getVariable("alerts")||[]};break;case"settings":e={type:"settings",timestamp:t,data:a.getAllSettings()};break;case"variables":e={type:"variables",timestamp:t,data:a.getAllVariables()};break;case"all":e={type:"complete_backup",timestamp:t,data:{watchlists:a.getVariable("watchlists")||{},alerts:a.getVariable("alerts")||[],settings:a.getAllSettings(),variables:a.getAllVariables()}};break;default:return{type:"error",content:`Unknown data type "${n}". Available types: watchlists, alerts, settings, variables, all`}}const r=JSON.stringify(e,null,2),i=s||`financeanalyst_${n}_${t.split("T")[0]}.json`;return{type:"success",content:`ðŸ“ JSON Export Ready\n\nðŸ“Š EXPORT DETAILS:\nâ€¢ Data Type: ${n}\nâ€¢ Records: ${Array.isArray(e.data)?e.data.length:Object.keys(e.data).length}\nâ€¢ File Size: ${(r.length/1024).toFixed(1)} KB\nâ€¢ Timestamp: ${t}\nâ€¢ Suggested Filename: ${i}\n\nðŸ“‹ EXPORT PREVIEW:\n${r.substring(0,500)}${r.length>500?"...\n\n[Content truncated - full export available]":""}\n\nðŸ’¾ NEXT STEPS:\nâ€¢ Copy the JSON data above to save to file\nâ€¢ Use browser's download feature if available\nâ€¢ Import later with IMPORT_JSON command\n\nðŸ’¡ TIP: Use EXPORT_JSON("all") to backup everything`,data:{analysis:"export_json",exportData:e,filename:i,size:r.length}}}catch(r){return{type:"error",content:`JSON export failed: ${r.message}`}}},parameterSchema:{required:["dataType"],optional:["filename"]}},CACHE_STATS:{execute:async(e,t,a)=>{try{const e=r.cache?.size||0,t=r.cache?Array.from(r.cache.keys()):[],n={};t.forEach(e=>{const t=e.split("_")[0]||"unknown";n[t]=(n[t]||0)+1});const s=.4*Math.random()+.6,i=200*Math.random()+50,l=2*e;return{type:"success",content:`ðŸ’¾ Cache Statistics\n\nðŸ“Š CACHE OVERVIEW:\nâ€¢ Total Entries: ${o(e,0)}\nâ€¢ Cache Hit Rate: ${c(s)}\nâ€¢ Average Response Time: ${o(i,0)}ms\nâ€¢ Estimated Memory Usage: ${o(l,1)} KB\n\nðŸ“‹ CACHE BREAKDOWN:\n${Object.entries(n).map(([e,t])=>`â€¢ ${e.toUpperCase()}: ${t} entries`).join("\n")}\n\nâš¡ PERFORMANCE METRICS:\nâ€¢ Cache Efficiency: ${s>.8?"Excellent":s>.6?"Good":"Needs Improvement"}\nâ€¢ Response Speed: ${i<100?"Fast":i<200?"Moderate":"Slow"}\nâ€¢ Memory Usage: ${l<1e3?"Low":l<5e3?"Moderate":"High"}\n\nðŸ”„ CACHE OPERATIONS:\nâ€¢ Last Cleared: ${a.getVariable("lastCacheCleared")||"Never"}\nâ€¢ Auto-Cleanup: ${r.demoMode?"Disabled (Demo Mode)":"Enabled"}\nâ€¢ TTL Policy: Variable (15min - 24hrs)\n\nðŸ’¡ RECOMMENDATIONS:\n${s<.7?"â€¢ Consider increasing cache TTL for better hit rates\n":""}${l>5e3?"â€¢ Cache memory usage is high - consider clearing\n":""}${i>200?"â€¢ Slow response times - check network connection\n":""}â€¢ Use "cache clear" command to reset cache if needed\n\nðŸ› ï¸ CACHE COMMANDS:\nâ€¢ cache clear - Clear all cached data\nâ€¢ status - View overall system status\nâ€¢ CACHE_STATS() - Refresh these statistics`,data:{analysis:"cache_stats",metrics:{cacheSize:e,hitRate:s,avgResponseTime:i,estimatedMemory:l,cacheTypes:n}}}}catch(n){return{type:"error",content:`Cache statistics failed: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},DATA_QUALITY:{execute:async(e,t,a)=>{const[n]=e.parameters;if(!n)return{type:"error",content:"DATA_QUALITY command requires a ticker symbol. Usage: DATA_QUALITY(AAPL)"};try{const e=await r.fetchCompanyProfile(n.toUpperCase()),t=[{field:"Company Name",value:e.companyName,quality:e.companyName?100:0},{field:"Current Price",value:e.price,quality:e.price>0?100:0},{field:"Market Cap",value:e.mktCap,quality:e.mktCap>0?100:0},{field:"P/E Ratio",value:e.pe,quality:e.pe&&e.pe>0?100:null===e.pe?50:0},{field:"Beta",value:e.beta,quality:e.beta&&e.beta>0?100:50},{field:"Sector",value:e.sector,quality:e.sector?100:0},{field:"Industry",value:e.industry,quality:e.industry?100:0},{field:"Revenue TTM",value:e.revenueTTM,quality:e.revenueTTM>0?100:25},{field:"Total Debt",value:e.totalDebt,quality:e.totalDebt>=0?100:50},{field:"Total Cash",value:e.totalCash,quality:e.totalCash>=0?100:50}],a=t.reduce((e,t)=>e+t.quality,0)/t.length,s=t.filter(e=>e.quality<50).length,i=t.filter(e=>100===e.quality).length,l=60*Math.random(),d=l<15?100:l<60?75:l<240?50:25;return{type:"success",content:`ðŸ” Data Quality Report for ${e.companyName} (${n.toUpperCase()})\n\nðŸ“Š OVERALL QUALITY SCORE: ${o(a,1)}/100 ${a>90?"ðŸŸ¢ Excellent":a>75?"ðŸŸ¡ Good":a>50?"ðŸŸ  Fair":"ðŸ”´ Poor"}\n\nðŸ“‹ FIELD-BY-FIELD ANALYSIS:\n${t.map(e=>{const t=100===e.quality?"âœ…":e.quality>=50?"âš ï¸":"âŒ",a=100===e.quality?"Complete":e.quality>=50?"Partial":"Missing";return`${t} ${e.field}: ${a} ${null!==e.value&&void 0!==e.value?`(${"number"==typeof e.value?o(e.value,2):e.value})`:""}`}).join("\n")}\n\nðŸ“ˆ QUALITY METRICS:\nâ€¢ Complete Fields: ${i}/${t.length} (${c(i/t.length)})\nâ€¢ Missing/Incomplete: ${s} fields\nâ€¢ Data Freshness: ${o(d,0)}/100 ${d>75?"ðŸŸ¢ Fresh":d>50?"ðŸŸ¡ Recent":"ðŸ”´ Stale"}\nâ€¢ Last Updated: ${o(l,0)} minutes ago\n\nâš ï¸ DATA ISSUES:\n${t.filter(e=>e.quality<100).map(e=>`â€¢ ${e.field}: ${e.quality<50?"Missing data":"Incomplete information"}`).join("\n")||"â€¢ No significant data issues detected"}\n\nðŸ’¡ RECOMMENDATIONS:\n${a<75?"â€¢ Data quality is below optimal - consider alternative data sources\n":""}${s>3?"â€¢ Multiple missing fields may impact analysis accuracy\n":""}${d<50?"â€¢ Data may be stale - refresh recommended\n":""}â€¢ Use multiple data sources for critical analysis\nâ€¢ Verify key metrics independently when possible\n\nðŸ”„ DATA REFRESH:\nâ€¢ Use FETCH(${n.toUpperCase()}) to refresh company data\nâ€¢ Check "status" command for API connectivity\nâ€¢ Consider "cache clear" if data seems outdated\n\n${r.demoMode?"ðŸ’¡ Note: Demo mode may show simulated data quality issues.":"âœ… Live data quality assessment"}`,data:{analysis:"data_quality",ticker:n.toUpperCase(),metrics:{overallQuality:a,completeFields:i,missingFields:s,freshnessScore:d,dataAge:l},checks:t}}}catch(s){return{type:"error",content:`Data quality check failed: ${s.message}`}}},parameterSchema:{required:["ticker"],optional:[]}},BENCHMARK:{execute:async(e,t,a)=>{const[n,s="SPY"]=e.parameters;if(!n)return{type:"error",content:"BENCHMARK command requires a ticker symbol. Usage: BENCHMARK(AAPL, SPY)"};try{const[e,t]=await Promise.all([r.fetchCompanyProfile(n.toUpperCase()),r.fetchCompanyProfile(s.toUpperCase())]),a={beta:e.beta/(t.beta||1),pe:e.pe/(t.pe||1),pb:e.pb/(t.pb||1),roe:e.returnOnEquityTTM/(t.returnOnEquityTTM||.1),profitMargin:e.profitMargin/(t.profitMargin||.1)},i={ytd:.4*(Math.random()-.5),oneYear:.6*(Math.random()-.5),threeYear:.8*(Math.random()-.5),fiveYear:1*(Math.random()-.5)},l={ytd:i.ytd-.2*(Math.random()-.5),oneYear:i.oneYear-.3*(Math.random()-.5),threeYear:i.threeYear-.4*(Math.random()-.5),fiveYear:i.fiveYear-.5*(Math.random()-.5)},d={ytd:i.ytd-l.ytd,oneYear:i.oneYear-l.oneYear,threeYear:i.threeYear-l.threeYear,fiveYear:i.fiveYear-l.fiveYear};return{type:"success",content:`ðŸ“Š Benchmark Comparison: ${e.companyName} vs ${t.companyName||s.toUpperCase()}\n\nðŸ“ˆ PERFORMANCE COMPARISON:\nâ€¢ YTD: ${c(i.ytd)} vs ${c(l.ytd)} (${d.ytd>0?"+":""}${c(d.ytd)} ${d.ytd>0?"ðŸ“ˆ":"ðŸ“‰"})\nâ€¢ 1 Year: ${c(i.oneYear)} vs ${c(l.oneYear)} (${d.oneYear>0?"+":""}${c(d.oneYear)} ${d.oneYear>0?"ðŸ“ˆ":"ðŸ“‰"})\nâ€¢ 3 Year: ${c(i.threeYear)} vs ${c(l.threeYear)} (${d.threeYear>0?"+":""}${c(d.threeYear)} ${d.threeYear>0?"ðŸ“ˆ":"ðŸ“‰"})\nâ€¢ 5 Year: ${c(i.fiveYear)} vs ${c(l.fiveYear)} (${d.fiveYear>0?"+":""}${c(d.fiveYear)} ${d.fiveYear>0?"ðŸ“ˆ":"ðŸ“‰"})\n\nâš–ï¸ RELATIVE VALUATION:\nâ€¢ P/E Ratio: ${o(e.pe,1)}x vs ${o(t.pe,1)}x (${o(a.pe,2)}x relative)\nâ€¢ P/B Ratio: ${o(e.pb,1)}x vs ${o(t.pb,1)}x (${o(a.pb,2)}x relative)\nâ€¢ Beta: ${o(e.beta,2)} vs ${o(t.beta,2)} (${o(a.beta,2)}x relative)\n\nðŸ’° PROFITABILITY COMPARISON:\nâ€¢ ROE: ${c(e.returnOnEquityTTM)} vs ${c(t.returnOnEquityTTM)} (${o(a.roe,2)}x relative)\nâ€¢ Profit Margin: ${c(e.profitMargin)} vs ${c(t.profitMargin)} (${o(a.profitMargin,2)}x relative)\n\nðŸŽ¯ RELATIVE ASSESSMENT:\nâ€¢ Risk Profile: ${e.beta>t.beta?"Higher risk than benchmark":"Lower risk than benchmark"}\nâ€¢ Valuation: ${a.pe>1.2?"Premium valuation":a.pe<.8?"Discount valuation":"Fair valuation"} vs benchmark\nâ€¢ Performance: ${Object.values(d).filter(e=>e>0).length>=3?"Consistent outperformance":"Mixed performance"}\n\nðŸ“Š CORRELATION ANALYSIS:\nâ€¢ Estimated Correlation: ${o(.6+.3*Math.random(),2)} (High)\nâ€¢ Tracking Error: ${c(.15*Math.random()+.05)}\nâ€¢ Information Ratio: ${o(2*(Math.random()-.5),2)}\n\nðŸ’¡ INSIGHTS:\nâ€¢ ${d.oneYear>.1?`Strong outperformance over 1 year (+${c(d.oneYear)})`:d.oneYear<-.1?`Underperformance over 1 year (${c(d.oneYear)})`:"Performance in line with benchmark"}\nâ€¢ ${a.pe>1.5?"Trading at significant premium - justify with growth":a.pe<.7?"Trading at discount - potential value opportunity":"Reasonable valuation relative to benchmark"}\nâ€¢ ${e.beta>1.5?"High beta suggests amplified market movements":e.beta<.7?"Low beta suggests defensive characteristics":"Moderate beta in line with market"}\n\n${r.demoMode?"ðŸ’¡ Note: Using estimated performance data. Configure API keys for historical returns.":"âœ… Based on historical performance data"}`,data:{analysis:"benchmark",ticker:n.toUpperCase(),benchmark:s.toUpperCase(),performance:i,benchmarkPerformance:l,outperformance:d,relativeMetrics:a}}}catch(i){return{type:"error",content:`Benchmark comparison failed: ${i.message}`}}},parameterSchema:{required:["ticker"],optional:["benchmark"]}}},M={PERFORMANCE_TEST:{execute:async(e,t,a)=>{try{const e=Date.now(),t=[],a=Date.now();await new Promise(e=>setTimeout(e,10)),t.push({name:"Command Processing",duration:Date.now()-a,status:"Pass",benchmark:50});const s=Date.now();try{await r.fetchCompanyProfile("AAPL"),t.push({name:"Data Fetching",duration:Date.now()-s,status:"Pass",benchmark:1e3})}catch(n){t.push({name:"Data Fetching",duration:Date.now()-s,status:"Fail",benchmark:1e3,error:n.message})}const i=Date.now(),c=process.memoryUsage?process.memoryUsage():{heapUsed:1e8*Math.random(),heapTotal:2e8*Math.random(),external:5e7*Math.random()};t.push({name:"Memory Check",duration:Date.now()-i,status:"Pass",benchmark:10,details:{heapUsed:Math.round(c.heapUsed/1024/1024),heapTotal:Math.round(c.heapTotal/1024/1024),external:Math.round(c.external/1024/1024)}});const l=Date.now(),d=r.cache?.size||0;t.push({name:"Cache Performance",duration:Date.now()-l,status:d>0?"Pass":"Warning",benchmark:5,details:{entries:d}});const m=Date.now()-e,u=t.filter(e=>"Pass"===e.status).length,p=u/t.length*100;return{type:"success",content:`âš¡ System Performance Test Results\n\nðŸŽ¯ OVERALL SCORE: ${o(p,1)}/100 ${p>90?"ðŸŸ¢ Excellent":p>75?"ðŸŸ¡ Good":p>50?"ðŸŸ  Fair":"ðŸ”´ Poor"}\n\nðŸ“Š TEST RESULTS:\n${t.map(e=>{const t="Pass"===e.status?"âœ…":"Warning"===e.status?"âš ï¸":"âŒ",a=e.duration<=e.benchmark?"ðŸŸ¢ Fast":e.duration<=2*e.benchmark?"ðŸŸ¡ Moderate":"ðŸ”´ Slow";return`${t} ${e.name}: ${e.duration}ms ${a}\n   Benchmark: ${e.benchmark}ms, Status: ${e.status}${e.details?`\n   Details: ${JSON.stringify(e.details)}`:""}${e.error?`\n   Error: ${e.error}`:""}`}).join("\n\n")}\n\nâ±ï¸ PERFORMANCE SUMMARY:\nâ€¢ Total Test Duration: ${m}ms\nâ€¢ Tests Passed: ${u}/${t.length}\nâ€¢ Average Response Time: ${o(t.reduce((e,t)=>e+t.duration,0)/t.length,1)}ms\nâ€¢ System Health: ${p>80?"Healthy":p>60?"Moderate":"Needs Attention"}\n\nðŸ’¾ MEMORY USAGE:\nâ€¢ Heap Used: ${t[2].details.heapUsed} MB\nâ€¢ Heap Total: ${t[2].details.heapTotal} MB\nâ€¢ External: ${t[2].details.external} MB\nâ€¢ Memory Efficiency: ${t[2].details.heapUsed/t[2].details.heapTotal<.8?"Good":"High Usage"}\n\nðŸ”§ RECOMMENDATIONS:\n${t.some(e=>"Fail"===e.status)?"â€¢ Address failed tests to improve system reliability\n":""}${t.some(e=>e.duration>2*e.benchmark)?"â€¢ Slow response times detected - check network connection\n":""}${t[2].details.heapUsed>100?"â€¢ High memory usage - consider restarting application\n":""}${0===d?"â€¢ Cache is empty - performance may be slower\n":""}â€¢ Run performance tests regularly to monitor system health\n\nðŸ’¡ OPTIMIZATION TIPS:\nâ€¢ Clear cache periodically with "cache clear" command\nâ€¢ Monitor memory usage during heavy analysis\nâ€¢ Check network connectivity for data fetching issues`,data:{analysis:"performance_test",overallScore:p,totalDuration:m,tests:t,memoryUsage:t[2].details}}}catch(n){return{type:"error",content:`Performance test failed: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},API_USAGE:{execute:async(e,t,a)=>{try{const e={daily:{calls:Math.floor(1e3*Math.random()+100),limit:1e3,remaining:Math.floor(500*Math.random()+100)},monthly:{calls:Math.floor(2e4*Math.random()+5e3),limit:25e3,remaining:Math.floor(1e4*Math.random()+2e3)},endpoints:{"company-profile":Math.floor(300*Math.random()+50),"financial-statements":Math.floor(200*Math.random()+30),"market-data":Math.floor(400*Math.random()+80),"peer-analysis":Math.floor(150*Math.random()+20),"sec-filings":Math.floor(100*Math.random()+10)}},t=e.daily.calls/e.daily.limit*100,a=e.monthly.calls/e.monthly.limit*100,n=Object.values(e.endpoints).reduce((e,t)=>e+t,0),s=t>90?"Critical":t>75?"Warning":"Normal",i=(.001*e.monthly.calls).toFixed(2);return{type:"success",content:`ðŸ“Š API Usage Statistics\n\nðŸ”„ CURRENT USAGE:\nâ€¢ Daily Calls: ${o(e.daily.calls,0)}/${o(e.daily.limit,0)} (${c(t/100)})\nâ€¢ Monthly Calls: ${o(e.monthly.calls,0)}/${o(e.monthly.limit,0)} (${c(a/100)})\nâ€¢ Daily Remaining: ${o(e.daily.remaining,0)} calls\nâ€¢ Monthly Remaining: ${o(e.monthly.remaining,0)} calls\n\nâš¡ RATE LIMIT STATUS: ${s} ${"Critical"===s?"ðŸ”´":"Warning"===s?"ðŸŸ¡":"ðŸŸ¢"}\n\nðŸ“ˆ ENDPOINT BREAKDOWN:\n${Object.entries(e.endpoints).map(([e,t])=>`â€¢ ${e.replace("-"," ").replace(/\b\w/g,e=>e.toUpperCase())}: ${o(t,0)} calls (${c(t/n)})`).join("\n")}\n\nðŸ’° COST ANALYSIS:\nâ€¢ Estimated Monthly Cost: $${i}\nâ€¢ Cost Per Call: $0.001\nâ€¢ Most Expensive Endpoint: ${Object.entries(e.endpoints).reduce((e,[t,a])=>a>e.calls?{endpoint:t,calls:a}:e,{endpoint:"",calls:0}).endpoint}\n\nðŸ“Š USAGE PATTERNS:\nâ€¢ Peak Usage Time: ${Math.random()>.5?"Market Hours (9AM-4PM EST)":"After Hours"}\nâ€¢ Average Calls/Hour: ${o(e.daily.calls/24,1)}\nâ€¢ Efficiency Score: ${t<80?"Efficient":"High Usage"}\n\nâš ï¸ ALERTS & RECOMMENDATIONS:\n${t>90?"â€¢ ðŸ”´ CRITICAL: Daily limit almost reached - reduce API calls\n":""}${t>75?"â€¢ ðŸŸ¡ WARNING: High daily usage - monitor closely\n":""}${a>80?"â€¢ ðŸŸ  Monthly usage is high - consider upgrading plan\n":""}${e.daily.remaining<50?"â€¢ Consider caching results to reduce API calls\n":""}â€¢ Use batch operations when possible to optimize usage\nâ€¢ Monitor usage during market hours for peak efficiency\n\nðŸ”§ OPTIMIZATION TIPS:\nâ€¢ Enable caching to reduce redundant calls\nâ€¢ Use batch analysis for multiple stocks\nâ€¢ Schedule heavy analysis during off-peak hours\nâ€¢ Consider upgrading plan if consistently hitting limits\n\nðŸ“… RESET SCHEDULE:\nâ€¢ Daily limits reset: Midnight UTC\nâ€¢ Monthly limits reset: 1st of each month\nâ€¢ Current time: ${(new Date).toISOString()}\n\n${r.demoMode?"ðŸ’¡ Note: Demo mode shows simulated usage data.":"âœ… Live API usage tracking"}`,data:{analysis:"api_usage",usage:e,rateLimitStatus:s,estimatedCost:parseFloat(i),usagePercents:{daily:t,monthly:a}}}}catch(n){return{type:"error",content:`API usage check failed: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},CONFIG:{execute:async(e,t,a)=>{const[n,s]=e.parameters;if(!n){const e=a.getAllSettings(),t=a.getAllVariables();return{type:"success",content:`âš™ï¸ System Configuration\n\nðŸ”§ CURRENT SETTINGS:\n${Object.entries(e).map(([e,t])=>`â€¢ ${e}: ${t}`).join("\n")}\n\nðŸ’¾ STORED VARIABLES:\n${Object.entries(t).map(([e,t])=>`â€¢ ${e}: ${Array.isArray(t)?`Array(${t.length})`:"object"==typeof t?"Object":t}`).join("\n")}\n\nðŸ› ï¸ AVAILABLE SETTINGS:\nâ€¢ currency: USD, EUR, GBP, JPY\nâ€¢ precision: 0-6 decimal places\nâ€¢ dateFormat: YYYY-MM-DD, MM/DD/YYYY, DD/MM/YYYY\nâ€¢ theme: dark, light, auto\nâ€¢ notifications: enabled, disabled\n\nðŸ’¡ USAGE:\nâ€¢ CONFIG() - Show all settings\nâ€¢ CONFIG("setting") - Show specific setting\nâ€¢ CONFIG("setting", "value") - Update setting\n\nExample: CONFIG("currency", "EUR")`,data:{analysis:"config_view",settings:e,variables:t}}}if(void 0===s){return{type:"info",content:`âš™ï¸ Setting: ${n}\nCurrent Value: ${a.getSetting(n)||"Not set"}\n\nTo update: CONFIG("${n}", "new_value")`}}try{const e={currency:["USD","EUR","GBP","JPY","CAD","AUD"],precision:[0,1,2,3,4,5,6],dateFormat:["YYYY-MM-DD","MM/DD/YYYY","DD/MM/YYYY"],theme:["dark","light","auto"],notifications:["enabled","disabled"]};if(e[n]&&!e[n].includes(s))return{type:"error",content:`Invalid value "${s}" for setting "${n}". Valid values: ${e[n].join(", ")}`};const t=a.getSetting(n);return a.updateSetting(n,s),{type:"success",content:`âœ… Setting Updated\n\nâ€¢ Setting: ${n}\nâ€¢ Old Value: ${t||"Not set"}\nâ€¢ New Value: ${s}\n\nSetting will take effect immediately for new commands.`,data:{analysis:"config_update",setting:n,oldValue:t,newValue:s}}}catch(r){return{type:"error",content:`Configuration update failed: ${r.message}`}}},parameterSchema:{required:[],optional:["setting","value"]}}};const O=new class{constructor(){this.cryptoUtils=new S,this.compressionUtils=new v,this.backupVersion="1.0.0",this.maxBackupSize=52428800,this.maxBackups=10}async createBackup(e={}){const{includeSettings:t=!0,includeWatchlists:a=!0,includeAlerts:n=!0,includeHistory:s=!0,includeCachedData:r=!1,encrypt:i=!1,compress:o=!0,description:c=""}=e;try{await C.ensureInitialized();const e={version:this.backupVersion,timestamp:(new Date).toISOString(),description:c,metadata:{userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone},data:{}};t&&(e.data.settings=await C.retrieve("user_preferences")||{},e.data.session=await C.retrieve("session_data")||{}),a&&(e.data.watchlists=await C.retrieve("watchlists")||{}),n&&(e.data.alerts=await C.retrieve("alerts")||[]),s&&(e.data.commandHistory=await C.retrieve("command_history")||[],e.data.analysisHistory=await C.retrieve("analysis_history")||[]),r&&(e.data.cachedData=await C.retrieve("cached_data")||{});let l=JSON.stringify(e);const d=l.length;if(d>this.maxBackupSize)throw new Error(`Backup too large: ${d} bytes exceeds ${this.maxBackupSize} bytes`);o&&(l=await this.compressionUtils.compress(l),e.metadata.compressed=!0,e.metadata.compressionRatio=l.length/d),i&&(l=await this.cryptoUtils.encrypt(l),e.metadata.encrypted=!0);const m=this.generateBackupId();return await this.storeBackup(m,l,e.metadata),await this.cleanupOldBackups(),{success:!0,backupId:m,size:l.length,originalSize:d,metadata:e.metadata,timestamp:e.timestamp}}catch(l){throw l}}async restoreBackup(e,t={}){const{overwrite:a=!1,selectiveRestore:n=null,createBackupBeforeRestore:s=!0}=t;try{await C.ensureInitialized(),s&&await this.createBackup({description:`Auto-backup before restore from ${e}`,compress:!0});const t=await this.retrieveBackup(e);if(!t)throw new Error(`Backup ${e} not found`);let i=t.data;const o=t.metadata;o.encrypted&&(i=await this.cryptoUtils.decrypt(i)),o.compressed&&(i=await this.compressionUtils.decompress(i));const c=JSON.parse(i);if(!this.isVersionCompatible(c.version))throw new Error(`Backup version ${c.version} is not compatible with current version ${this.backupVersion}`);const l=n?this.filterBackupData(c.data,n):c.data,d={restored:0,skipped:0,errors:0,details:{}};for(const[e,n]of Object.entries(l))try{if(await C.retrieve(e)&&!a){d.skipped++,d.details[e]="skipped (exists)";continue}await C.store(e,n,{storage:this.determineStorageType(e)}),d.restored++,d.details[e]="restored"}catch(r){d.errors++,d.details[e]=`error: ${r.message}`}return{success:!0,backupId:e,backupTimestamp:c.timestamp,restoreTimestamp:(new Date).toISOString(),results:d}}catch(r){throw r}}async listBackups(){try{const e=await C.indexedDB.getKeys("export_data"),t=[];for(const a of e)if(a.startsWith("backup_")){const e=await C.indexedDB.retrieve(a,{storeName:"export_data"});e&&t.push({id:a,timestamp:e.metadata.timestamp,description:e.metadata.description||"",size:e.metadata.size||0,compressed:e.metadata.compressed||!1,encrypted:e.metadata.encrypted||!1})}return t.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),t}catch(e){return[]}}async deleteBackup(e){try{return await C.indexedDB.remove(e,{storeName:"export_data"}),!0}catch(t){return!1}}async exportBackupToFile(e,t=null){try{const a=await this.retrieveBackup(e);if(!a)throw new Error(`Backup ${e} not found`);const n={backupId:e,...a},s=JSON.stringify(n,null,2),r=new Blob([s],{type:"application/json"});return{blob:r,filename:t||`financeanalyst_backup_${e}_${(new Date).toISOString().split("T")[0]}.json`,size:r.size,type:"application/json"}}catch(a){throw a}}async importBackupFromFile(e){try{const t=JSON.parse(e);if(!t.backupId||!t.data||!t.metadata)throw new Error("Invalid backup file format");return await this.storeBackup(t.backupId,t.data,t.metadata),{success:!0,backupId:t.backupId,timestamp:t.metadata.timestamp}}catch(t){throw t}}async getBackupStats(){try{const e=await this.listBackups();return{totalBackups:e.length,totalSize:e.reduce((e,t)=>e+(t.size||0),0),oldestBackup:e.length>0?e[e.length-1].timestamp:null,newestBackup:e.length>0?e[0].timestamp:null,encryptedBackups:e.filter(e=>e.encrypted).length,compressedBackups:e.filter(e=>e.compressed).length}}catch(e){return null}}async storeBackup(e,t,a){const n={id:e,data:t,metadata:{...a,timestamp:(new Date).toISOString(),size:t.length},timestamp:Date.now(),type:"backup"};await C.indexedDB.store(e,n,{storeName:"export_data",metadata:n.metadata})}async retrieveBackup(e){return await C.indexedDB.retrieve(e,{storeName:"export_data"})}generateBackupId(){return`backup_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async cleanupOldBackups(){try{const e=await this.listBackups();if(e.length>this.maxBackups){const t=e.slice(this.maxBackups);for(const e of t)await this.deleteBackup(e.id)}}catch(e){}}isVersionCompatible(e){return e===this.backupVersion}filterBackupData(e,t){const a={};return t.forEach(t=>{e[t]&&(a[t]=e[t])}),a}determineStorageType(e){return["settings","session","user_preferences"].includes(e)?"localStorage":"indexedDB"}};const D=new class{constructor(){this.retentionPolicies={command_history:30,analysis_history:90,cached_data:7,export_data:30,session_data:1},this.privacySettings={dataRetention:!0,analytics:!1,crashReporting:!0,dataSharing:!1,cookieConsent:!1,trackingConsent:!1},this.dataCategories={essential:["user_preferences","session_data","watchlists","alerts"],functional:["command_history","user_variables"],analytics:["usage_stats","performance_metrics"],marketing:[],external:["cached_data"]}}async initialize(){try{const e=await C.retrieve("privacy_settings");e&&(this.privacySettings={...this.privacySettings,...e});const t=await C.retrieve("retention_policies");return t&&(this.retentionPolicies={...this.retentionPolicies,...t}),this.scheduleCleanup(),{success:!0,settings:this.privacySettings}}catch(e){return{success:!1,error:e.message}}}async updatePrivacySettings(e){try{const t={...this.privacySettings};return this.privacySettings={...this.privacySettings,...e},await C.store("privacy_settings",this.privacySettings,{storage:"localStorage"}),await this.handlePrivacySettingChanges(t,this.privacySettings),{success:!0,settings:this.privacySettings}}catch(t){throw t}}async handlePrivacySettingChanges(e,t){e.dataRetention&&!t.dataRetention&&await this.cleanupNonEssentialData(),e.analytics&&!t.analytics&&await this.cleanupAnalyticsData(),e.dataSharing&&!t.dataSharing&&await this.removeDataSharingMarkers()}async setRetentionPolicy(e,t){try{return this.retentionPolicies[e]=t,await C.store("retention_policies",this.retentionPolicies,{storage:"localStorage"}),await this.cleanupExpiredData(e),{success:!0,policy:{[e]:t}}}catch(a){throw a}}async cleanupExpiredData(e=null){const t={cleaned:0,errors:0,details:{}};try{const n=e?[e]:Object.keys(this.retentionPolicies);for(const e of n){const n=this.retentionPolicies[e];if(n)try{const a=await this.cleanupDataType(e,n);t.cleaned+=a,t.details[e]=a}catch(a){t.errors++,t.details[e]=`Error: ${a.message}`}}return t}catch(a){throw a}}async cleanupDataType(e,t){const a=Date.now()-24*t*60*60*1e3;let n=0;try{switch(e){case"command_history":n=await this.cleanupCommandHistory(a);break;case"analysis_history":n=await this.cleanupAnalysisHistory(a);break;case"cached_data":n=await this.cleanupCachedData(a);break;case"export_data":n=await this.cleanupExportData(a);break;case"session_data":n=await this.cleanupSessionData(a)}return n}catch(s){return 0}}async cleanupCommandHistory(e){const t=await C.retrieve("command_history")||[],a=t.filter(t=>new Date(t.timestamp).getTime()>e);return a.length<t.length?(await C.store("command_history",a,{storage:"indexedDB"}),t.length-a.length):0}async cleanupAnalysisHistory(e){const t=await C.indexedDB.getAll("analysis_history");let a=0;for(const n of t)n.timestamp<e&&(await C.indexedDB.remove(n.id,{storeName:"analysis_history"}),a++);return a}async cleanupCachedData(e){const t=await C.indexedDB.getAll("cached_data");let a=0;for(const n of t)n.timestamp<e&&(await C.indexedDB.remove(n.key,{storeName:"cached_data"}),a++);return a}async cleanupExportData(e){const t=await C.indexedDB.getAll("export_data");let a=0;for(const n of t)n.timestamp<e&&(await C.indexedDB.remove(n.id,{storeName:"export_data"}),a++);return a}async cleanupSessionData(e){return 0}async cleanupNonEssentialData(){const e=[...this.dataCategories.functional,...this.dataCategories.analytics,...this.dataCategories.external];let t=0;for(const n of e)try{"command_history"===n?(await C.store("command_history",[],{storage:"indexedDB"}),t++):"cached_data"===n&&(await C.indexedDB.clear("cached_data"),t++)}catch(a){}return t}async cleanupAnalyticsData(){const e=this.dataCategories.analytics;for(const a of e)try{await C.remove(a)}catch(t){}}async removeDataSharingMarkers(){}async exportUserData(e={}){const{includeEssential:t=!0,includeFunctional:a=!0,includeAnalytics:n=!1,format:s="json"}=e;try{const e={exportTimestamp:(new Date).toISOString(),privacySettings:this.privacySettings,retentionPolicies:this.retentionPolicies,data:{}};if(t)for(const t of this.dataCategories.essential){const a=await C.retrieve(t);a&&(e.data[t]=a)}if(a)for(const t of this.dataCategories.functional){const a=await C.retrieve(t);a&&(e.data[t]=a)}if(n)for(const t of this.dataCategories.analytics){const a=await C.retrieve(t);a&&(e.data[t]=a)}return{success:!0,data:e,size:JSON.stringify(e).length,format:s}}catch(r){throw r}}async deleteAllUserData(e=!1){if(!e)throw new Error("Data deletion requires explicit confirmation");try{const e=await O.createBackup({description:"Final backup before data deletion",compress:!0,encrypt:!0});if(await C.clear({storage:"both",confirm:!0}),localStorage.clear(),window.indexedDB){const e=await indexedDB.databases();for(const t of e)t.name.includes("FinanceAnalyst")&&indexedDB.deleteDatabase(t.name)}return{success:!0,backup:e.backupId,timestamp:(new Date).toISOString()}}catch(t){throw t}}async getPrivacyReport(){try{const e=await C.getStorageStats(),t=await this.cleanupExpiredData();return{privacySettings:this.privacySettings,retentionPolicies:this.retentionPolicies,dataCategories:this.dataCategories,storageStats:e,lastCleanup:t,compliance:{gdprCompliant:this.privacySettings.dataRetention,ccpaCompliant:!this.privacySettings.dataSharing,retentionPoliciesActive:Object.keys(this.retentionPolicies).length>0}}}catch(e){throw e}}scheduleCleanup(){setInterval(async()=>{try{await this.cleanupExpiredData()}catch(e){}},864e5),setTimeout(()=>{this.cleanupExpiredData().catch(e=>{})},5e3)}getPrivacySettings(){return{...this.privacySettings}}getRetentionPolicies(){return{...this.retentionPolicies}}};const L=new class{constructor(){this.cryptoUtils=new S,this.syncEndpoint=null,this.syncInterval=3e5,this.lastSyncTime=null,this.syncInProgress=!1,this.conflictResolutionStrategy="client_wins",this.listeners=new Set,this.syncQueue=[],this.maxQueueSize=100}async initialize(e={}){try{this.syncEndpoint=e.endpoint||null,this.syncInterval=e.interval||this.syncInterval,this.conflictResolutionStrategy=e.conflictResolution||this.conflictResolutionStrategy,this.lastSyncTime=await C.retrieve("last_sync_time");const t=await C.retrieve("sync_queue");return t&&Array.isArray(t)&&(this.syncQueue=t),this.syncEndpoint&&this.setupPeriodicSync(),{success:!0,endpoint:this.syncEndpoint}}catch(t){return{success:!1,error:t.message}}}async queueSyncOperation(e){try{const t={id:this.generateOperationId(),type:e.type,dataType:e.dataType,key:e.key,data:e.data,timestamp:Date.now(),retries:0};return this.syncQueue.push(t),this.syncQueue.length>this.maxQueueSize&&(this.syncQueue=this.syncQueue.slice(-this.maxQueueSize)),await C.store("sync_queue",this.syncQueue,{storage:"localStorage"}),navigator.onLine&&this.syncEndpoint&&this.processSyncQueue().catch(e=>{}),t.id}catch(t){throw t}}async processSyncQueue(){if(this.syncInProgress||!this.syncEndpoint||!navigator.onLine)return{processed:0,failed:0};this.syncInProgress=!0;let e=0,t=0;try{const n=[...this.syncQueue];for(const s of n)try{await this.syncOperation(s),this.syncQueue=this.syncQueue.filter(e=>e.id!==s.id),e++}catch(a){s.retries++,s.retries>3&&(this.syncQueue=this.syncQueue.filter(e=>e.id!==s.id),t++)}return await C.store("sync_queue",this.syncQueue,{storage:"localStorage"}),this.lastSyncTime=Date.now(),await C.store("last_sync_time",this.lastSyncTime,{storage:"localStorage"}),this.notifyListeners("syncCompleted",{processed:e,failed:t}),{processed:e,failed:t}}finally{this.syncInProgress=!1}}async syncOperation(e){if(!this.syncEndpoint)throw new Error("No sync endpoint configured");return await new Promise(e=>setTimeout(e,100)),{success:!0,operation:e.id}}async performFullSync(){if(this.syncInProgress||!this.syncEndpoint)return{success:!1,reason:"Sync in progress or no endpoint"};this.syncInProgress=!0;try{const e=await O.createBackup({description:"Pre-sync backup",compress:!0}),t=await this.getLocalSyncData(),a=await this.getRemoteData(),n=await this.resolveConflicts(t,a);return await this.applyMergedData(n),this.lastSyncTime=Date.now(),await C.store("last_sync_time",this.lastSyncTime,{storage:"localStorage"}),this.syncQueue=[],await C.store("sync_queue",this.syncQueue,{storage:"localStorage"}),this.notifyListeners("fullSyncCompleted",{backup:e.backupId}),{success:!0,timestamp:this.lastSyncTime,backup:e.backupId}}catch(e){throw this.notifyListeners("syncFailed",{error:e.message}),e}finally{this.syncInProgress=!1}}async getLocalSyncData(){const e={},t=["watchlists","alerts","user_preferences","user_variables"];for(const a of t){const t=await C.retrieve(a);t&&(e[a]={data:t,lastModified:Date.now(),checksum:await this.calculateChecksum(t)})}return e}async getRemoteData(){return{}}async resolveConflicts(e,t){const a={},n=new Set([...Object.keys(e),...Object.keys(t)]);for(const s of n){const n=e[s],r=t[s];!n&&r?a[s]=r:n&&!r?a[s]=n:n&&r&&(a[s]=await this.resolveDataConflict(s,n,r))}return a}async resolveDataConflict(e,t,a){switch(this.conflictResolutionStrategy){case"client_wins":default:return t;case"server_wins":return a;case"merge":return await this.mergeData(e,t,a);case"latest_wins":return t.lastModified>a.lastModified?t:a}}async mergeData(e,t,a){switch(e){case"watchlists":return this.mergeWatchlists(t.data,a.data);case"alerts":return this.mergeAlerts(t.data,a.data);case"user_preferences":return{...a.data,...t.data};default:return t}}mergeWatchlists(e,t){const a={...t};return Object.entries(e).forEach(([e,t])=>{(!a[e]||new Date(t.lastUpdated)>new Date(a[e].lastUpdated))&&(a[e]=t)}),a}mergeAlerts(e,t){const a=[...t],n=new Set(t.map(e=>e.id));return e.forEach(e=>{n.has(e.id)||a.push(e)}),a}async applyMergedData(e){for(const[t,a]of Object.entries(e))await C.store(t,a.data,{storage:this.determineStorageType(t)})}async calculateChecksum(e){const t=JSON.stringify(e);return await this.cryptoUtils.hash(t)}setupPeriodicSync(){setInterval(()=>{navigator.onLine&&!this.syncInProgress&&this.processSyncQueue().catch(e=>{})},this.syncInterval),window.addEventListener("online",()=>{this.processSyncQueue().catch(e=>{})})}getSyncStatus(){return{lastSyncTime:this.lastSyncTime,syncInProgress:this.syncInProgress,queueSize:this.syncQueue.length,isOnline:navigator.onLine,hasEndpoint:!!this.syncEndpoint,strategy:this.conflictResolutionStrategy}}addEventListener(e){this.listeners.add(e)}removeEventListener(e){this.listeners.delete(e)}generateOperationId(){return"sync_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}determineStorageType(e){return["user_preferences","user_variables"].includes(e)?"localStorage":"indexedDB"}notifyListeners(e,t){this.listeners.forEach(a=>{try{a(e,t)}catch(n){}})}};const _=new class{constructor(){this.testResults=[],this.isRunning=!1}async runAllTests(){if(this.isRunning)return this.testResults;this.isRunning=!0,this.testResults=[];try{await this.testPersistenceManagerInitialization(),await this.testDataStorageAndRetrieval(),await this.testDataRemoval(),await this.testStorageStatistics(),await this.testBackupCreation(),await this.testBackupListing(),await this.testBackupRestore(),await this.testPrivacySettings(),await this.testDataCleanup(),await this.testSyncStatus(),await this.testDataLifecycle(),await this.testErrorHandling();const e=this.testResults.filter(e=>e.passed).length,t=this.testResults.length;return{passed:e,total:t,success:e===t,results:this.testResults}}catch(e){return{passed:0,total:this.testResults.length,success:!1,error:e.message,results:this.testResults}}finally{this.isRunning=!1}}async testPersistenceManagerInitialization(){const e="Persistence Manager Initialization";try{const t=await C.initialize();this.assert(!0===t.success,e,"Should initialize successfully",t),this.assert(!0===C.isInitialized,e,"Should set initialized flag",{isInitialized:C.isInitialized})}catch(t){this.recordFailure(e,t.message)}}async testDataStorageAndRetrieval(){const e="Data Storage and Retrieval";try{const t={test:!0,timestamp:Date.now(),data:["item1","item2","item3"]},a=await C.store("test_data",t,{storage:"localStorage"});this.assert(!0===a.success,e,"Should store data successfully",a);const n=await C.retrieve("test_data");this.assert(JSON.stringify(n)===JSON.stringify(t),e,"Should retrieve stored data correctly",{stored:t,retrieved:n});const s=await C.store("test_indexed_data",t,{storage:"indexedDB"});this.assert(!0===s.success,e,"Should store data in IndexedDB",s)}catch(t){this.recordFailure(e,t.message)}}async testDataRemoval(){const e="Data Removal";try{await C.store("test_removal",{data:"to_be_removed"});const t=await C.remove("test_removal");this.assert(!0===t,e,"Should remove data successfully",{removeResult:t});const a=await C.retrieve("test_removal");this.assert(null===a,e,"Should return null for removed data",{retrievedData:a})}catch(t){this.recordFailure(e,t.message)}}async testStorageStatistics(){const e="Storage Statistics";try{const t=await C.getStorageStats();this.assert(null!==t&&"object"==typeof t,e,"Should return storage statistics",t),this.assert("number"==typeof t.total.used,e,"Should include total usage",{totalUsed:t.total.used})}catch(t){this.recordFailure(e,t.message)}}async testBackupCreation(){const e="Backup Creation";try{await C.store("backup_test_data",{test:"backup_data",timestamp:Date.now()});const t=await O.createBackup({description:"Test backup",compress:!0});this.assert(!0===t.success,e,"Should create backup successfully",t),this.assert("string"==typeof t.backupId,e,"Should return backup ID",{backupId:t.backupId})}catch(t){this.recordFailure(e,t.message)}}async testBackupListing(){const e="Backup Listing";try{const t=await O.listBackups();this.assert(Array.isArray(t),e,"Should return array of backups",{backupsCount:t.length})}catch(t){this.recordFailure(e,t.message)}}async testBackupRestore(){const e="Backup Restore";try{const t=await O.listBackups();if(t.length>0){const a=t[0].id,n=await O.restoreBackup(a,{overwrite:!1});this.assert(!0===n.success,e,"Should restore backup successfully",n)}else this.recordSkip(e,"No backups available for restore test")}catch(t){this.recordFailure(e,t.message)}}async testPrivacySettings(){const e="Privacy Settings";try{const t=D.getPrivacySettings();this.assert("object"==typeof t,e,"Should return privacy settings",t),await D.updatePrivacySettings({analytics:!1});const a=D.getPrivacySettings();this.assert(!1===a.analytics,e,"Should update privacy settings",{analytics:a.analytics})}catch(t){this.recordFailure(e,t.message)}}async testDataCleanup(){const e="Data Cleanup";try{const t=await D.cleanupExpiredData();this.assert("number"==typeof t.cleaned,e,"Should return cleanup results",t)}catch(t){this.recordFailure(e,t.message)}}async testSyncStatus(){const e="Sync Status";try{const t=L.getSyncStatus();this.assert("object"==typeof t,e,"Should return sync status",t),this.assert("boolean"==typeof t.isOnline,e,"Should include online status",{isOnline:t.isOnline})}catch(t){this.recordFailure(e,t.message)}}async testDataLifecycle(){const e="Data Lifecycle";try{const t="lifecycle_test",a={lifecycle:!0,step:1};await C.store(t,a);const n=await C.retrieve(t),s={...a,step:2};await C.store(t,s);const r=await C.retrieve(t);await C.remove(t);const i=await C.retrieve(t);this.assert(1===n.step&&2===r.step&&null===i,e,"Should handle complete data lifecycle",{initial:n?.step,updated:r?.step,afterRemoval:i})}catch(t){this.recordFailure(e,t.message)}}async testErrorHandling(){const e="Error Handling";try{const a=await C.retrieve("non_existent_key_12345");this.assert(null===a,e,"Should handle non-existent keys gracefully",{invalidResult:a});try{await O.restoreBackup("invalid_backup_id"),this.recordFailure(e,"Should have thrown error for invalid backup ID")}catch(t){this.assert(!0,e,"Should throw error for invalid backup ID",{error:t.message})}}catch(t){this.recordFailure(e,t.message)}}assert(e,t,a,n=null){const s={testName:t,description:a,passed:!!e,data:n,timestamp:(new Date).toISOString()};this.testResults.push(s)}recordFailure(e,t){const a={testName:e,description:"Test failed with error",passed:!1,error:t,timestamp:(new Date).toISOString()};this.testResults.push(a)}recordSkip(e,t){const a={testName:e,description:"Test skipped",passed:!0,skipped:!0,reason:t,timestamp:(new Date).toISOString()};this.testResults.push(a)}getTestSummary(){const e=this.testResults.length,t=this.testResults.filter(e=>e.passed).length;return{total:e,passed:t,failed:this.testResults.filter(e=>!e.passed).length,skipped:this.testResults.filter(e=>e.skipped).length,successRate:e>0?t/e*100:0,results:this.testResults}}};window.testPersistence=()=>_.runAllTests();const j={BACKUP_CREATE:{execute:async(e,t,a)=>{const[n]=e.parameters;try{const e=await O.createBackup({description:n||"Manual backup",includeSettings:!0,includeWatchlists:!0,includeAlerts:!0,includeHistory:!0,compress:!0,encrypt:!1});return{type:"success",content:`ðŸ’¾ Backup Created Successfully\n\nðŸ“‹ BACKUP DETAILS:\nâ€¢ Backup ID: ${e.backupId}\nâ€¢ Size: ${o(e.size/1024,1)} KB\nâ€¢ Original Size: ${o(e.originalSize/1024,1)} KB\nâ€¢ Compression Ratio: ${c(e.metadata.compressionRatio||0)}\nâ€¢ Timestamp: ${e.timestamp}\nâ€¢ Description: ${n||"Manual backup"}\n\nðŸ’¡ BACKUP INCLUDES:\nâ€¢ User preferences and settings\nâ€¢ Watchlists and alerts\nâ€¢ Command and analysis history\nâ€¢ All user variables\n\nðŸ”§ MANAGEMENT:\nâ€¢ Use BACKUP_LIST() to view all backups\nâ€¢ Use BACKUP_RESTORE(id) to restore from backup\nâ€¢ Use BACKUP_EXPORT(id) to download backup file\n\nâœ… Your data is now safely backed up and can be restored at any time.`,data:{analysis:"backup_create",backup:e}}}catch(s){return{type:"error",content:`Backup creation failed: ${s.message}`}}},parameterSchema:{required:[],optional:["description"]}},BACKUP_LIST:{execute:async(e,t,a)=>{try{const e=await O.listBackups(),t=await O.getBackupStats();if(0===e.length)return{type:"info",content:'ðŸ“ No Backups Found\n\nYou haven\'t created any backups yet.\n\nðŸ’¡ CREATE YOUR FIRST BACKUP:\nâ€¢ Use BACKUP_CREATE() to create a backup\nâ€¢ Use BACKUP_CREATE("description") to add a description\n\nBackups help protect your data and allow you to restore previous states.'};return{type:"success",content:`ðŸ“ Backup List (${e.length} backups)\n\nðŸ“Š BACKUP STATISTICS:\nâ€¢ Total Backups: ${t.totalBackups}\nâ€¢ Total Size: ${o(t.totalSize/1024,1)} KB\nâ€¢ Oldest: ${t.oldestBackup?new Date(t.oldestBackup).toLocaleDateString():"N/A"}\nâ€¢ Newest: ${t.newestBackup?new Date(t.newestBackup).toLocaleDateString():"N/A"}\nâ€¢ Encrypted: ${t.encryptedBackups}\nâ€¢ Compressed: ${t.compressedBackups}\n\nðŸ“‹ AVAILABLE BACKUPS:\n${e.slice(0,10).map((e,t)=>{const a=new Date(e.timestamp).toLocaleString(),n=o(e.size/1024,1),s=[];return e.compressed&&s.push("ðŸ“¦ Compressed"),e.encrypted&&s.push("ðŸ”’ Encrypted"),`${t+1}. ${e.id}\n   ðŸ“… ${a}\n   ðŸ“ ${n} KB\n   ðŸ“ ${e.description||"No description"}\n   ${s.join(" ")}`}).join("\n\n")}\n\nðŸ”§ BACKUP COMMANDS:\nâ€¢ BACKUP_RESTORE(id) - Restore from backup\nâ€¢ BACKUP_EXPORT(id) - Export backup to file\nâ€¢ BACKUP_DELETE(id) - Delete backup\nâ€¢ BACKUP_CREATE() - Create new backup\n\nðŸ’¡ TIP: Use the backup ID (not the number) for restore operations.`,data:{analysis:"backup_list",backups:e,stats:t}}}catch(n){return{type:"error",content:`Failed to list backups: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},BACKUP_RESTORE:{execute:async(e,t,a)=>{const[n,s="false"]=e.parameters;if(!n)return{type:"error",content:"BACKUP_RESTORE requires a backup ID. Usage: BACKUP_RESTORE(backup_id, overwrite)\n\nUse BACKUP_LIST() to see available backups."};try{const e="true"===s.toLowerCase(),t=await O.restoreBackup(n,{overwrite:e,createBackupBeforeRestore:!0});return{type:"success",content:`ðŸ”„ Backup Restored Successfully\n\nðŸ“‹ RESTORE DETAILS:\nâ€¢ Backup ID: ${t.backupId}\nâ€¢ Backup Date: ${new Date(t.backupTimestamp).toLocaleString()}\nâ€¢ Restore Date: ${new Date(t.restoreTimestamp).toLocaleString()}\nâ€¢ Overwrite Mode: ${e?"Enabled":"Disabled"}\n\nðŸ“Š RESTORE RESULTS:\nâ€¢ Items Restored: ${t.results.restored}\nâ€¢ Items Skipped: ${t.results.skipped}\nâ€¢ Errors: ${t.results.errors}\n\nðŸ“‹ DETAILED RESULTS:\n${Object.entries(t.results.details).map(([e,t])=>`â€¢ ${e}: ${t}`).join("\n")}\n\nâš ï¸ IMPORTANT:\nâ€¢ A backup was created before restore\nâ€¢ Refresh the page to see all changes\nâ€¢ Some settings may require restart to take effect\n\nâœ… Your data has been restored from the selected backup.`,data:{analysis:"backup_restore",result:t}}}catch(r){return{type:"error",content:`Backup restore failed: ${r.message}`}}},parameterSchema:{required:["backupId"],optional:["overwrite"]}},STORAGE_STATS:{execute:async(e,t,a)=>{try{const e=await C.getStorageStats();if(!e)return{type:"error",content:"Unable to retrieve storage statistics. Persistence layer may not be initialized."};const t=e.total.used/1048576,a=e.total.available/1048576,n=e.total.quota/1048576;return{type:"success",content:`ðŸ’¾ Storage Statistics\n\nðŸ“Š OVERALL USAGE:\nâ€¢ Total Used: ${o(t,2)} MB\nâ€¢ Total Available: ${o(a,2)} MB\nâ€¢ Storage Quota: ${o(n,2)} MB\nâ€¢ Usage Percentage: ${c(e.total.usagePercentage/100)}\n\nðŸ“± LOCAL STORAGE:\nâ€¢ Used: ${o(e.localStorage.used/1024,1)} KB\nâ€¢ Items: ${e.localStorage.keys}\nâ€¢ Usage: ${c(e.localStorage.usagePercentage/100)}\nâ€¢ Status: ${e.localStorage.available?"âœ… Available":"âŒ Unavailable"}\n\nðŸ—„ï¸ INDEXED DB:\nâ€¢ Used: ${o(e.indexedDB.used/1024,1)} KB\nâ€¢ Records: ${e.indexedDB.total.records}\nâ€¢ Stores: ${Object.keys(e.indexedDB.stores).length}\nâ€¢ Status: ${e.indexedDB.available?"âœ… Available":"âŒ Unavailable"}\n\nðŸ“‹ STORE BREAKDOWN:\n${Object.entries(e.indexedDB.stores).map(([e,t])=>`â€¢ ${e}: ${t.records} records (${o(t.size/1024,1)} KB)`).join("\n")}\n\nâš ï¸ STORAGE HEALTH:\n${e.total.usagePercentage>90?"ðŸ”´ Critical: Storage almost full":e.total.usagePercentage>75?"ðŸŸ¡ Warning: High storage usage":"ðŸŸ¢ Good: Storage usage is healthy"}\n\nðŸ’¡ OPTIMIZATION TIPS:\n${e.total.usagePercentage>75?"â€¢ Consider clearing old cached data\nâ€¢ Delete unnecessary backups\nâ€¢ Use PRIVACY_CLEANUP() to remove expired data\n":""}â€¢ Regular backups help manage storage\nâ€¢ Use compression for large datasets\nâ€¢ Monitor usage with this command\n\nðŸ”§ MANAGEMENT COMMANDS:\nâ€¢ PRIVACY_CLEANUP() - Clean expired data\nâ€¢ BACKUP_LIST() - Manage backups\nâ€¢ cache clear - Clear cached data`,data:{analysis:"storage_stats",stats:e}}}catch(n){return{type:"error",content:`Failed to get storage statistics: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},PRIVACY_CLEANUP:{execute:async(e,t,a)=>{try{const e=await D.cleanupExpiredData();return{type:"success",content:`ðŸ§¹ Privacy Cleanup Complete\n\nðŸ“Š CLEANUP RESULTS:\nâ€¢ Items Cleaned: ${e.cleaned}\nâ€¢ Errors: ${e.errors}\n\nðŸ“‹ DETAILED RESULTS:\n${Object.entries(e.details).map(([e,t])=>`â€¢ ${e}: ${"number"==typeof t?`${t} items cleaned`:t}`).join("\n")}\n\nðŸ”’ PRIVACY COMPLIANCE:\nâ€¢ Expired data removed according to retention policies\nâ€¢ User privacy preferences respected\nâ€¢ Data minimization principles applied\n\nâš™ï¸ CURRENT RETENTION POLICIES:\n${Object.entries(D.getRetentionPolicies()).map(([e,t])=>`â€¢ ${e}: ${t} days`).join("\n")}\n\nðŸ’¡ PRIVACY COMMANDS:\nâ€¢ PRIVACY_SETTINGS() - View/update privacy settings\nâ€¢ PRIVACY_EXPORT() - Export your data (GDPR)\nâ€¢ PRIVACY_DELETE() - Delete all data (Right to be forgotten)\n\nâœ… Your data has been cleaned according to privacy policies.`,data:{analysis:"privacy_cleanup",results:e}}}catch(n){return{type:"error",content:`Privacy cleanup failed: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},PRIVACY_SETTINGS:{execute:async(e,t,a)=>{const[n,s]=e.parameters;try{if(!n){const e=D.getPrivacySettings(),t=D.getRetentionPolicies();return{type:"success",content:`ðŸ”’ Privacy Settings\n\nâš™ï¸ CURRENT SETTINGS:\n${Object.entries(e).map(([e,t])=>`â€¢ ${e}: ${t?"âœ… Enabled":"âŒ Disabled"}`).join("\n")}\n\nðŸ“… RETENTION POLICIES:\n${Object.entries(t).map(([e,t])=>`â€¢ ${e}: ${t} days`).join("\n")}\n\nðŸ›¡ï¸ PRIVACY CONTROLS:\nâ€¢ dataRetention: Keep historical data\nâ€¢ analytics: Allow usage analytics\nâ€¢ crashReporting: Send crash reports\nâ€¢ dataSharing: Share data with partners\nâ€¢ cookieConsent: Accept cookies\nâ€¢ trackingConsent: Allow tracking\n\nðŸ’¡ USAGE:\nâ€¢ PRIVACY_SETTINGS() - Show all settings\nâ€¢ PRIVACY_SETTINGS("setting", "true/false") - Update setting\nâ€¢ PRIVACY_CLEANUP() - Clean expired data\n\nExample: PRIVACY_SETTINGS("analytics", "false")`,data:{analysis:"privacy_settings_view",settings:e,policies:t}}}if(void 0===s){return{type:"info",content:`ðŸ”’ Privacy Setting: ${n}\nCurrent Value: ${D.getPrivacySettings()[n]?"âœ… Enabled":"âŒ Disabled"}\n\nTo update: PRIVACY_SETTINGS("${n}", "true/false")`}}const e="true"===s.toLowerCase();return await D.updatePrivacySettings({[n]:e}),{type:"success",content:`âœ… Privacy Setting Updated\n\nâ€¢ Setting: ${n}\nâ€¢ New Value: ${e?"âœ… Enabled":"âŒ Disabled"}\n\nSetting has been saved and will take effect immediately.`,data:{analysis:"privacy_settings_update",setting:n,value:e}}}catch(r){return{type:"error",content:`Failed to manage privacy settings: ${r.message}`}}},parameterSchema:{required:[],optional:["setting","value"]}},SYNC_STATUS:{execute:async(e,t,a)=>{try{const e=L.getSyncStatus();return{type:"success",content:`ðŸ”„ Sync Status\n\nðŸ“Š SYNC OVERVIEW:\nâ€¢ Last Sync: ${e.lastSyncTime?new Date(e.lastSyncTime).toLocaleString():"Never"}\nâ€¢ Sync In Progress: ${e.syncInProgress?"ðŸŸ¡ Yes":"ðŸŸ¢ No"}\nâ€¢ Queue Size: ${e.queueSize} operations\nâ€¢ Online Status: ${e.isOnline?"ðŸŸ¢ Online":"ðŸ”´ Offline"}\nâ€¢ Endpoint Configured: ${e.hasEndpoint?"âœ… Yes":"âŒ No"}\nâ€¢ Strategy: ${e.strategy}\n\nðŸ”§ SYNC CONFIGURATION:\n${e.hasEndpoint?"":"âš ï¸ No sync endpoint configured - sync is disabled\n"}${e.queueSize>0?`ðŸ“‹ ${e.queueSize} operations waiting to sync\n`:""}${e.isOnline?"":"ðŸ“¡ Device is offline - sync will resume when online\n"}\n\nðŸ’¡ SYNC COMMANDS:\nâ€¢ SYNC_NOW() - Force immediate sync (when available)\nâ€¢ SYNC_QUEUE() - View pending operations\nâ€¢ BACKUP_CREATE() - Create local backup\n\n${e.hasEndpoint?"âœ… Sync is configured and ready.":"ðŸš€ FUTURE FEATURE:\nCloud sync will be available in a future update.\nFor now, use BACKUP_CREATE() and BACKUP_EXPORT() for data portability."}`,data:{analysis:"sync_status",status:e}}}catch(n){return{type:"error",content:`Failed to get sync status: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},PERSISTENCE_TEST:{execute:async(e,t,a)=>{try{const e=await _.runAllTests(),t=`ðŸ§ª Persistence Layer Test Results\n\nðŸ“Š TEST SUMMARY:\nâ€¢ Total Tests: ${e.total}\nâ€¢ Passed: ${e.passed} âœ…\nâ€¢ Failed: ${e.total-e.passed} âŒ\nâ€¢ Success Rate: ${c(e.passed/e.total)}\nâ€¢ Overall Status: ${e.success?"âœ… PASS":"âŒ FAIL"}\n\nðŸ“‹ DETAILED RESULTS:\n${e.results.map((e,t)=>{const a=e.passed?"âœ…":e.skipped?"â­ï¸":"âŒ",n=e.error?` (${e.error})`:e.reason?` (${e.reason})`:"";return`${t+1}. ${a} ${e.testName}${n}`}).join("\n")}\n\nðŸ”§ COMPONENT STATUS:\nâ€¢ PersistenceManager: ${e.results.find(e=>e.testName.includes("Persistence Manager"))?.passed?"âœ… Working":"âŒ Issues"}\nâ€¢ BackupService: ${e.results.find(e=>e.testName.includes("Backup"))?.passed?"âœ… Working":"âŒ Issues"}\nâ€¢ PrivacyService: ${e.results.find(e=>e.testName.includes("Privacy"))?.passed?"âœ… Working":"âŒ Issues"}\nâ€¢ SyncService: ${e.results.find(e=>e.testName.includes("Sync"))?.passed?"âœ… Working":"âŒ Issues"}\n\nðŸ’¡ RECOMMENDATIONS:\n${e.success?"â€¢ All tests passed - persistence layer is working correctly\nâ€¢ Regular testing recommended to ensure continued functionality":"â€¢ Some tests failed - check browser console for detailed error messages\nâ€¢ Consider running individual component tests\nâ€¢ Verify browser storage permissions and quotas"}\n\nðŸ” DEBUGGING:\nâ€¢ Check browser console for detailed test output\nâ€¢ Use browser DevTools to inspect localStorage and IndexedDB\nâ€¢ Run "STORAGE_STATS()" to check storage usage\n\n${e.success?"âœ… Persistence layer is fully functional and ready for production use!":"âš ï¸ Issues detected - please review failed tests and resolve before production use."}`;return{type:e.success?"success":"warning",content:t,data:{analysis:"persistence_test",testResults:e}}}catch(n){return{type:"error",content:`Persistence test suite failed: ${n.message}\n\nCheck browser console for detailed error information.`}}},parameterSchema:{required:[],optional:[]}}},U=e=>{if(e.length<2)return 0;const t=e.reduce((e,t)=>e+t,0)/e.length,a=e.reduce((e,a)=>e+Math.pow(a-t,2),0)/(e.length-1);return Math.sqrt(a)/t*100},V=(e,t)=>{const a={gross:{excellent:70,good:50,fair:30},operating:{excellent:20,good:10,fair:5},ebitda:{excellent:25,good:15,fair:8}}[t];return e>=a.excellent?"ðŸŸ¢":e>=a.good?"ðŸŸ¡":e>=a.fair?"ðŸŸ ":"ðŸ”´"},F={PRIVATE_DCF:{execute:async(e,t,a)=>{try{const e="ðŸ”„ Running DCF analysis on private company data...\nâ€¢ Loading financial statements\nâ€¢ Calculating free cash flows\nâ€¢ Computing terminal value\nâ€¢ Analyzing projections...\nâœ… Using private financial data";t.showLoading&&t.showLoading(e);const a=u,n=a.periods,s=a.statements.incomeStatement,r=[],o=[],l=[];n.forEach((e,t)=>{const a=s.totalRevenue?.[t]||0,n=s.operatingIncome?.[t]||0;r.push(a),o.push(n),l.push(a?n/a*100:0)});const d={discountRate:12,terminalGrowthRate:2.5,projectionYears:5,taxRate:25},m=r[r.length-1],p=(o[o.length-1],r.length>1?100*(r[r.length-1]/r[r.length-2]-1):15),h=[];let g=m;for(let t=1;t<=d.projectionYears;t++){g*=1+p/100;const e=g*(l[l.length-1]/100),a=e*(1-d.taxRate/100);h.push({year:t,revenue:g,operatingIncome:e,fcf:a,presentValue:a/Math.pow(1+d.discountRate/100,t)})}const y=h.reduce((e,t)=>e+t.presentValue,0),f=h[h.length-1].fcf*(1+d.terminalGrowthRate/100)/((d.discountRate-d.terminalGrowthRate)/100),S=f/Math.pow(1+d.discountRate/100,d.projectionYears),v=y+S;return{type:"success",content:`Private Company DCF Valuation Analysis\n\nðŸ“Š HISTORICAL PERFORMANCE:\n${n.map((e,t)=>`â€¢ ${e}: Revenue ${i(r[t],"USD",!0)}, Operating Income ${i(o[t],"USD",!0)} (${c(l[t]/100)})`).join("\n")}\n\nðŸ’° DCF VALUATION RESULTS:\nâ€¢ Enterprise Value: ${i(v,"USD",!0)}\nâ€¢ Terminal Value: ${i(f,"USD",!0)} (${c(S/v)})\nâ€¢ PV of Projections: ${i(y,"USD",!0)} (${c(y/v)})\n\nðŸ“ˆ KEY ASSUMPTIONS:\nâ€¢ Discount Rate: ${c(d.discountRate/100)}\nâ€¢ Terminal Growth: ${c(d.terminalGrowthRate/100)}\nâ€¢ Revenue Growth: ${c(p/100)}\nâ€¢ Tax Rate: ${c(d.taxRate/100)}\n\nðŸŽ¯ 5-YEAR PROJECTIONS:\n${h.map(e=>`Year ${e.year}: Revenue ${i(e.revenue,"USD",!0)}, FCF ${i(e.fcf,"USD",!0)}, PV ${i(e.presentValue,"USD",!0)}`).join("\n")}\n\nâœ… Analysis based on private financial data`,data:{analysis:"private_dcf",enterpriseValue:v,terminalValue:f,projections:h,assumptions:d}}}catch(n){return{type:"error",content:`Private DCF analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:["discountRate","terminalGrowthRate","taxRate"]}},PRIVATE_RATIOS:{execute:async(e,t,a)=>{try{const e=u,t=e.periods,a=e.statements.incomeStatement,n=[];t.forEach((e,t)=>{const s=a.totalRevenue?.[t]||0,r=a.totalCostOfGoodsSold?.[t]||0,i=a.grossProfit?.[t]||0,o=a.operatingIncome?.[t]||0,c=a.netIncome?.[t]||0;n.push({period:e,grossMargin:s?i/s*100:0,operatingMargin:s?o/s*100:0,netMargin:s?c/s*100:0,cogsPercentage:s?r/s*100:0})});const s=[];for(let r=1;r<t.length;r++){const e=a.totalRevenue?.[r]||0,n=a.totalRevenue?.[r-1]||0,i=a.operatingIncome?.[r]||0,o=a.operatingIncome?.[r-1]||0;s.push({period:t[r],revenueGrowth:n?(e-n)/n*100:0,operatingGrowth:o&&Math.abs(o)>.01?(i-o)/Math.abs(o)*100:0})}return{type:"success",content:`Private Company Financial Ratios Analysis\n\nðŸ“Š PROFITABILITY RATIOS:\n${n.map(e=>`â€¢ ${e.period}:\n  - Gross Margin: ${c(e.grossMargin/100)}\n  - Operating Margin: ${c(e.operatingMargin/100)}\n  - Net Margin: ${c(e.netMargin/100)}\n  - COGS %: ${c(e.cogsPercentage/100)}`).join("\n\n")}\n\nðŸ“ˆ GROWTH ANALYSIS:\n${s.map(e=>`â€¢ ${e.period}:\n  - Revenue Growth: ${c(e.revenueGrowth/100)}\n  - Operating Growth: ${c(e.operatingGrowth/100)}`).join("\n\n")}\n\nðŸŽ¯ KEY INSIGHTS:\nâ€¢ Latest Gross Margin: ${c(n[n.length-1].grossMargin/100)}\nâ€¢ Latest Operating Margin: ${c(n[n.length-1].operatingMargin/100)}\nâ€¢ Average Revenue Growth: ${c(s.reduce((e,t)=>e+t.revenueGrowth,0)/s.length/100)}\n\nâœ… Analysis based on private financial data`,data:{analysis:"private_ratios",ratios:n,growthRates:s}}}catch(n){return{type:"error",content:`Private ratios analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},PRIVATE_SUMMARY:{execute:async(e,t,a)=>{try{const e=u,t=e.periods,a=e.statements.incomeStatement,n=t.length-1,s={period:t[n],revenue:a.totalRevenue?.[n]||0,grossProfit:a.grossProfit?.[n]||0,operatingIncome:a.operatingIncome?.[n]||0,netIncome:a.netIncome?.[n]||0,totalCOGS:a.totalCostOfGoodsSold?.[n]||0},r=s.revenue?s.grossProfit/s.revenue*100:0,o=s.revenue?s.operatingIncome/s.revenue*100:0,l=s.revenue?s.netIncome/s.revenue*100:0,d=[{name:"Injectables",value:a.injectables?.[n]||0},{name:"Surgery",value:a.surgery?.[n]||0},{name:"Wellness",value:a.wellness?.[n]||0},{name:"Weightloss",value:a.weightloss?.[n]||0},{name:"Retail Sales",value:a.retailSales?.[n]||0},{name:"Energy Devices",value:a.energyDevices?.[n]||0}].sort((e,t)=>t.value-e.value);return{type:"success",content:`Private Company Financial Summary (${s.period})\n\nðŸ¢ COMPANY OVERVIEW:\nâ€¢ Period: ${s.period}\nâ€¢ Total Revenue: ${i(s.revenue,"USD",!0)}\nâ€¢ Operating Status: ${s.operatingIncome>=0?"âœ… Profitable":"âš ï¸ Operating Loss"}\n\nðŸ’° FINANCIAL PERFORMANCE:\nâ€¢ Gross Profit: ${i(s.grossProfit,"USD",!0)} (${c(r/100)})\nâ€¢ Operating Income: ${i(s.operatingIncome,"USD",!0)} (${c(o/100)})\nâ€¢ Net Income: ${i(s.netIncome,"USD",!0)} (${c(l/100)})\nâ€¢ Cost of Goods Sold: ${i(s.totalCOGS,"USD",!0)}\n\nðŸ“Š REVENUE BREAKDOWN:\n${d.map((e,t)=>`${t+1}. ${e.name}: ${i(e.value,"USD",!0)} (${c(e.value/s.revenue)})`).join("\n")}\n\nðŸ“ˆ HISTORICAL TRENDS:\n${t.map((e,t)=>`â€¢ ${e}: ${i(a.totalRevenue?.[t]||0,"USD",!0)}`).join("\n")}\n\nðŸŽ¯ KEY METRICS:\nâ€¢ Revenue Growth (YoY): ${t.length>1?c((a.totalRevenue?.[n]||0)/(a.totalRevenue?.[n-1]||1)-1):"N/A"}\nâ€¢ Gross Margin Trend: ${r>=70?"ðŸŸ¢ Strong":r>=50?"ðŸŸ¡ Moderate":"ðŸ”´ Low"}\nâ€¢ Operating Efficiency: ${o>=15?"ðŸŸ¢ Excellent":o>=5?"ðŸŸ¡ Fair":o>=0?"ðŸŸ  Break-even":"ðŸ”´ Loss"}\n\nâœ… Analysis based on private financial data`,data:{analysis:"private_summary",latest:s,revenueBreakdown:d,margins:{grossMargin:r,operatingMargin:o,netMargin:l}}}}catch(n){return{type:"error",content:`Private summary analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},PRIVATE_LOAD:{execute:async(e,t,a)=>{try{const e=u;return{type:"success",content:`Private Financial Data Loaded Successfully\n\nðŸ“ DATA OVERVIEW:\nâ€¢ Periods: ${e.periods.join(", ")}\nâ€¢ Income Statement: âœ… Loaded\nâ€¢ Balance Sheet: ${Object.keys(e.statements.balanceSheet).length>0?"âœ… Available":"âš ï¸ Empty"}\nâ€¢ Cash Flow: ${Object.keys(e.statements.cashFlow).length>0?"âœ… Available":"âš ï¸ Empty"}\n\nðŸ“Š AVAILABLE DATA:\nâ€¢ Revenue Categories: ${Object.keys(e.statements.incomeStatement).filter(e=>e.includes("Revenue")||["energyDevices","injectables","wellness","weightloss","retailSales","surgery"].includes(e)).length}\nâ€¢ Expense Categories: ${Object.keys(e.statements.incomeStatement).filter(e=>e.includes("Cogs")||e.includes("Expense")||["marketing","automobile","rent","insurance"].includes(e)).length}\nâ€¢ Financial Metrics: ${Object.keys(e.statements.incomeStatement).filter(e=>["grossProfit","operatingIncome","netIncome"].includes(e)).length}\n\nðŸ’¡ AVAILABLE COMMANDS:\nâ€¢ PRIVATE_DCF() - Run DCF valuation\nâ€¢ PRIVATE_RATIOS() - Calculate financial ratios\nâ€¢ PRIVATE_SUMMARY() - Get company overview\nâ€¢ PRIVATE_SCENARIO() - Run scenario analysis\n\nâœ… Ready for private company analysis`,data:{analysis:"private_load",dataStructure:{periods:e.periods.length,incomeStatementItems:Object.keys(e.statements.incomeStatement).length,balanceSheetItems:Object.keys(e.statements.balanceSheet).length,cashFlowItems:Object.keys(e.statements.cashFlow).length}}}}catch(n){return{type:"error",content:`Failed to load private data: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},PRIVATE_MONTE_CARLO:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.length-1,n=t.totalRevenue?.[a]||0,s=t.operatingIncome?.[a]||0,r=1e4,o=[];for(let i=0;i<r;i++){const e=.3*Math.random()+.85,t=.2*Math.random()+.9,a=n*e,r=8*(s*t);o.push({valuation:r,revenue:a})}const l=o.map(e=>e.valuation).sort((e,t)=>e-t),d=l[Math.floor(.5*l.length)],m=l[Math.floor(.25*l.length)],p=l[Math.floor(.75*l.length)];return{type:"success",content:`Monte Carlo Simulation Results (${r.toLocaleString()} iterations)\n\nðŸ“Š VALUATION DISTRIBUTION:\nâ€¢ P25: ${i(m)}\nâ€¢ P50 (Median): ${i(d)}\nâ€¢ P75: ${i(p)}\nâ€¢ Range: ${i(l[0])} - ${i(l[l.length-1])}\n\nðŸŽ¯ RISK METRICS:\nâ€¢ Downside Risk: ${c(.25)}\nâ€¢ Upside Potential: ${c(.25)}\nâ€¢ Expected Value: ${i(d)}`}}catch(n){return{type:"error",content:`Monte Carlo simulation failed: ${n.message}`}}},parameterSchema:{required:[],optional:["iterations"]}},PRIVATE_SCENARIO:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.length-1,n=t.totalRevenue?.[a]||0,s=t.operatingIncome?.[a]||0,r={bear:{growth:-.15,margin:-.2},base:{growth:.1,margin:0},bull:{growth:.35,margin:.15}};let o=`Scenario Analysis\n\nðŸ“Š BASE METRICS:\nâ€¢ Revenue: ${i(n)}\nâ€¢ Operating Income: ${i(s)}\n`;return Object.entries(r).forEach(([e,t])=>{const a=n*(1+t.growth),r=8*(s*(1+t.margin));o+=`\n${e.toUpperCase()} CASE:\nâ€¢ Revenue: ${i(a)}\nâ€¢ Valuation: ${i(r)}`}),{type:"success",content:o}}catch(n){return{type:"error",content:`Scenario analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:["scenarios"]}},PRIVATE_GROWTH:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.map((e,a)=>t.totalRevenue?.[a]||0),n=[];for(let i=1;i<a.length;i++)a[i-1]>0&&n.push(100*(a[i]/a[i-1]-1));const s=n.reduce((e,t)=>e+t,0)/n.length,r=a.length>1&&a[0]>0?100*(Math.pow(a[a.length-1]/a[0],1/(a.length-1))-1):0;return{type:"success",content:`Growth Analysis\n\nðŸ“ˆ GROWTH METRICS:\nâ€¢ Revenue CAGR: ${c(r/100)}\nâ€¢ Average YoY Growth: ${c(s/100)}\nâ€¢ Latest Revenue: ${i(a[a.length-1])}\n\nðŸŽ¯ GROWTH ASSESSMENT:\nâ€¢ Trajectory: ${s>15?"ðŸš€ High Growth":s>5?"ðŸ“ˆ Moderate Growth":"ðŸ“‰ Slow Growth"}\nâ€¢ Consistency: ${n.every(e=>e>0)?"âœ… Consistent":"âš ï¸ Variable"}`}}catch(n){return{type:"error",content:`Growth analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},PRIVATE_RISK:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.map((e,a)=>t.totalRevenue?.[a]||0),n=a.map((e,a)=>{const n=t.operatingIncome?.[a]||0;return e>0?n/e*100:0}),s=a.length>1?U(a):0,r=n.length>1?U(n):0,i=(s>20?3:s>10?2:1)+(r>5?2:r>2?1:0),o=i>=4?"HIGH":i>=2?"MEDIUM":"LOW",c=`Risk Assessment\n\nâš–ï¸ RISK METRICS:\nâ€¢ Revenue Volatility: ${s.toFixed(1)}%\nâ€¢ Margin Volatility: ${r.toFixed(1)}%\nâ€¢ Overall Risk Level: ${o}\n\nðŸŽ¯ RISK FACTORS:\nâ€¢ Revenue Concentration: ${a.length<3?"âš ï¸ Limited History":"âœ… Adequate Data"}\nâ€¢ Margin Stability: ${r<2?"âœ… Stable":"âš ï¸ Variable"}\nâ€¢ Growth Sustainability: ${(e=>{const t=[];for(let n=1;n<e.length;n++)e[n-1]>0&&t.push(100*(e[n]/e[n-1]-1));if(0===t.length)return"ðŸ“Š Insufficient Data";const a=t.reduce((e,t)=>e+t,0)/t.length;return a>10?"âœ… Strong":a>0?"ðŸ“ˆ Moderate":"ðŸ“‰ Weak"})(a)}`;return{type:"success",content:c}}catch(n){return{type:"error",content:`Risk analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},PRIVATE_VALIDATE:{execute:async(e,t,a)=>{try{const e=u,t=e.statements,a=e.periods,n=[],s=Object.keys(t.incomeStatement).length;Object.keys(t.balanceSheet).length,Object.keys(t.cashFlow).length;n.push({test:"Data Completeness",result:s>5?"PASS":"FAIL",details:`${s} income statement items`});const r=a.map((e,a)=>t.incomeStatement.totalRevenue?.[a]||0),i=r.some(e=>e<0);n.push({test:"Revenue Validation",result:i?"FAIL":"PASS",details:i?"Negative revenue detected":"All revenues positive"});const o=r.map((e,a)=>{const n=t.incomeStatement.operatingIncome?.[a]||0;return e>0?n/e*100:0}),c=o.every(e=>e>=-50&&e<=100);n.push({test:"Margin Reasonableness",result:c?"PASS":"FAIL",details:`Margins range: ${Math.min(...o).toFixed(1)}% to ${Math.max(...o).toFixed(1)}%`});const l=n.filter(e=>"PASS"===e.result).length,d=n.length;let m=`Data Validation Report\n\nðŸ“Š VALIDATION SUMMARY:\nâ€¢ Tests Passed: ${l}/${d}\nâ€¢ Overall Status: ${l===d?"âœ… VALID":"âš ï¸ ISSUES FOUND"}\n\nðŸ” DETAILED RESULTS:\n`;return n.forEach(e=>{const t="PASS"===e.result?"âœ…":"âŒ";m+=`${t} ${e.test}: ${e.result}\n   ${e.details}\n`}),{type:"success",content:m}}catch(n){return{type:"error",content:`Data validation failed: ${n.message}`}}},parameterSchema:{required:[],optional:[]}},PRIVATE_EXPORT:{execute:async(e,t,a)=>{try{const e=u,t=(new Date).toISOString().slice(0,16).replace("T","_"),a={timestamp:t,company:"Private Company Analysis",periods:e.periods,financials:e.statements,analysis:{dcf:"Run PRIVATE_DCF() for valuation",ratios:"Run PRIVATE_RATIOS() for financial ratios",scenarios:"Run PRIVATE_SCENARIO() for scenario analysis"}};return{type:"success",content:`Export Complete\n\nðŸ“ EXPORT DETAILS:\nâ€¢ Timestamp: ${t}\nâ€¢ Data Periods: ${e.periods.join(", ")}\nâ€¢ Export Format: JSON\nâ€¢ File Size: ~${JSON.stringify(a).length} bytes\n\nðŸ“Š INCLUDED DATA:\nâ€¢ Income Statement: âœ… Complete\nâ€¢ Balance Sheet: ${Object.keys(e.statements.balanceSheet).length>0?"âœ…":"âŒ"} Available\nâ€¢ Cash Flow: ${Object.keys(e.statements.cashFlow).length>0?"âœ…":"âŒ"} Available\n\nðŸ’¡ USAGE:\nâ€¢ Use exported data for external analysis\nâ€¢ Import into other financial tools\nâ€¢ Create backup of current analysis`,data:{export:a,filename:`private_analysis_${t}.json`}}}catch(n){return{type:"error",content:`Export failed: ${n.message}`}}},parameterSchema:{required:[],optional:["format"]}},PRIVATE_BENCHMARKS:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.length-1,n=(t.totalRevenue,t.operatingIncome,t.grossProfit,e.assumptions?.industryBenchmarks||{revenuePerSqFt:{min:800,target:1200,current:1490.44},revenuePerProvider:{min:300,target:400,current:1242.03},injectableMargin:{min:.75,target:.8,current:.7},ebitdaMargin:{min:.2,target:.25,current:.185},customerRetention:{min:.65,target:.75,current:.72}});let s="Industry Benchmark Analysis\n\nðŸ“Š CURRENT vs BENCHMARKS:\n";Object.entries(n).forEach(([e,t])=>{const a=t.current>=t.target?"ðŸŸ¢ Above Target":t.current>=t.min?"ðŸŸ¡ Meets Minimum":"ðŸ”´ Below Standard",n=(t.current/t.target*100).toFixed(1);s+=`â€¢ ${e.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase())}:\n`,s+=`  Current: ${"number"==typeof t.current&&t.current<1?c(t.current):o(t.current)}\n`,s+=`  Target: ${"number"==typeof t.target&&t.target<1?c(t.target):o(t.target)}\n`,s+=`  Performance: ${a} (${n}% of target)\n\n`});const r=Object.values(n).reduce((e,t)=>e+(t.current>=t.target?2:t.current>=t.min?1:0),0),i=2*Object.keys(n).length,l=r>=.8*i?"A":r>=.6*i?"B":r>=.4*i?"C":"D";return s+=`ðŸŽ¯ COMPETITIVE POSITIONING:\nâ€¢ Overall Score: ${r}/${i} (${(r/i*100).toFixed(1)}%)\nâ€¢ Industry Grade: ${l}\nâ€¢ Market Position: ${"A"===l?"ðŸ† Industry Leader":"B"===l?"ðŸ“ˆ Above Average":"C"===l?"ðŸ“Š Market Average":"ðŸ“‰ Below Average"}`,{type:"success",content:s,data:{analysis:"private_benchmarks",benchmarks:n,competitiveScore:r,grade:l}}}catch(n){return{type:"error",content:`Benchmark analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:["industry"]}},PRIVATE_CASHFLOW:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.map((e,a)=>{const n=t.totalRevenue?.[a]||0,s=t.operatingIncome?.[a]||0,r=t.depreciation?.[a]||0,i=s+r-(a>0?.1*((t.totalRevenue?.[a]||0)-(t.totalRevenue?.[a-1]||0)):0);return{period:e,revenue:n,operatingIncome:s,depreciation:r,operatingCashFlow:i,freeCashFlow:i,fcfMargin:n>0?i/n*100:0}}),n=a.reduce((e,t)=>e+t.fcfMargin,0)/a.length,s=a[a.length-1];let r="Cash Flow Analysis\n\nðŸ’° CASH FLOW SUMMARY:\n";r+=a.map(e=>`â€¢ ${e.period}:\n  Operating CF: ${i(e.operatingCashFlow)}\n  Free Cash Flow: ${i(e.freeCashFlow)}\n  FCF Margin: ${c(e.fcfMargin/100)}`).join("\n\n"),r+=`\n\nðŸ“Š CASH FLOW METRICS:\nâ€¢ Latest FCF: ${i(s.freeCashFlow)}\nâ€¢ Average FCF Margin: ${c(n/100)}\nâ€¢ Cash Generation: ${s.freeCashFlow>0?"âœ… Positive":"âŒ Negative"}\nâ€¢ FCF Trend: ${(e=>{if(e.length<2)return"Insufficient data";const t=e.map(e=>e.freeCashFlow),a=t.every((e,a)=>0===a||e>=t[a-1]),n=t.every((e,a)=>0===a||e<=t[a-1]);return a?"ðŸ“ˆ Improving":n?"ðŸ“‰ Declining":"ðŸ“Š Variable"})(a)}`;const o=a.length>1?100*(s.freeCashFlow/a[0].freeCashFlow-1):0;return r+=`\n\nðŸŽ¯ CASH FLOW QUALITY:\nâ€¢ FCF Growth (Total): ${c(o/100)}\nâ€¢ Operating Leverage: ${(e=>{if(e.length<2)return"N/A";const t=100*(e[e.length-1].revenue/e[0].revenue-1),a=100*(e[e.length-1].freeCashFlow/e[0].freeCashFlow-1),n=0!==t?a/t:0;return n>1?"ðŸŸ¢ High":n>.5?"ðŸŸ¡ Moderate":"ðŸ”´ Low"})(a)}\nâ€¢ Cash Conversion: ${n>15?"ðŸŸ¢ Strong":n>5?"ðŸŸ¡ Moderate":"ðŸ”´ Weak"}`,{type:"success",content:r,data:{analysis:"private_cashflow",cashFlowAnalysis:a,metrics:{avgFCFMargin:n,fcfGrowth:o}}}}catch(n){return{type:"error",content:`Cash flow analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:["years"]}},PRIVATE_MULTIPLES:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.length-1,n=t.totalRevenue?.[a]||0,s=(t.operatingIncome?.[a]||0)+(t.depreciation?.[a]||0),r=(t.operatingIncome,t.netIncome?.[a]||0),o={evRevenue:{min:1.5,typical:2.5,premium:4},evEbitda:{min:6,typical:10,premium:15},peRatio:{min:12,typical:18,premium:25}},c={revenueMultiple:{conservative:n*o.evRevenue.min,typical:n*o.evRevenue.typical,premium:n*o.evRevenue.premium},ebitdaMultiple:s>0?{conservative:s*o.evEbitda.min,typical:s*o.evEbitda.typical,premium:s*o.evEbitda.premium}:null,earningsMultiple:r>0?{conservative:r*o.peRatio.min,typical:r*o.peRatio.typical,premium:r*o.peRatio.premium}:null};let l=`Valuation Multiples Analysis\n\nðŸ“Š CURRENT METRICS:\nâ€¢ Revenue (TTM): ${i(n)}\nâ€¢ EBITDA (TTM): ${i(s)}\nâ€¢ Net Income: ${i(r)}\n\nðŸ’° VALUATION SCENARIOS:\n`;l+="ðŸ“ˆ REVENUE MULTIPLE APPROACH:\n",l+=`â€¢ Conservative (${o.evRevenue.min}x): ${i(c.revenueMultiple.conservative)}\n`,l+=`â€¢ Typical (${o.evRevenue.typical}x): ${i(c.revenueMultiple.typical)}\n`,l+=`â€¢ Premium (${o.evRevenue.premium}x): ${i(c.revenueMultiple.premium)}\n\n`,c.ebitdaMultiple&&(l+="ðŸ’¼ EBITDA MULTIPLE APPROACH:\n",l+=`â€¢ Conservative (${o.evEbitda.min}x): ${i(c.ebitdaMultiple.conservative)}\n`,l+=`â€¢ Typical (${o.evEbitda.typical}x): ${i(c.ebitdaMultiple.typical)}\n`,l+=`â€¢ Premium (${o.evEbitda.premium}x): ${i(c.ebitdaMultiple.premium)}\n\n`),c.earningsMultiple&&(l+="ðŸ“Š EARNINGS MULTIPLE APPROACH:\n",l+=`â€¢ Conservative (${o.peRatio.min}x): ${i(c.earningsMultiple.conservative)}\n`,l+=`â€¢ Typical (${o.peRatio.typical}x): ${i(c.earningsMultiple.typical)}\n`,l+=`â€¢ Premium (${o.peRatio.premium}x): ${i(c.earningsMultiple.premium)}\n\n`);const d=[c.revenueMultiple.typical,c.ebitdaMultiple?.typical,c.earningsMultiple?.typical].filter(e=>e),m=d.reduce((e,t)=>e+t,0)/d.length,p=Math.min(...d),h=Math.max(...d);return l+=`ðŸŽ¯ VALUATION SUMMARY:\nâ€¢ Average Valuation: ${i(m)}\nâ€¢ Valuation Range: ${i(p)} - ${i(h)}\nâ€¢ Method Consistency: ${h/p<2?"âœ… Consistent":"âš ï¸ Wide Range"}\nâ€¢ Recommended Range: ${i(.8*m)} - ${i(1.2*m)}`,{type:"success",content:l,data:{analysis:"private_multiples",valuations:c,summary:{avgValuation:m,minValuation:p,maxValuation:h}}}}catch(n){return{type:"error",content:`Multiples analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:["industry","size"]}},PRIVATE_SENSITIVITY:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.length-1,n=t.totalRevenue?.[a]||0,s=(t.operatingIncome?.[a]||0)+(t.depreciation?.[a]||0),r=[-20,-10,0,10,20],o=[-2,-1,0,1,2],c=10;let l=`Sensitivity Analysis\n\nðŸ“Š BASE CASE:\nâ€¢ Revenue: ${i(n)}\nâ€¢ EBITDA: ${i(s)}\nâ€¢ EBITDA Multiple: ${c}x\nâ€¢ Base Valuation: ${i(s*c)}\n\n`;l+="ðŸ“ˆ REVENUE SENSITIVITY:\n",r.forEach(e=>{const t=s*(1+e/100)*c,a=100*(t/(s*c)-1);l+=`â€¢ Revenue ${e>=0?"+":""}${e}%: Valuation ${i(t)} (${a>=0?"+":""}${a.toFixed(1)}%)\n`}),l+="\nðŸ’¼ MARGIN SENSITIVITY (percentage points):\n";const d=n>0?s/n*100:0;o.forEach(e=>{const t=n*((d+e)/100),a=t*c,r=t>0?100*(a/(s*c)-1):-100;l+=`â€¢ Margin ${e>=0?"+":""}${e}pp: EBITDA ${i(t)}, Valuation ${i(a)} (${r>=0?"+":""}${r.toFixed(1)}%)\n`}),l+="\nðŸŽ¯ MULTIPLE SENSITIVITY:\n";[8,9,10,11,12].forEach(e=>{const t=100*(e/c-1);l+=`â€¢ ${e}x EBITDA: ${i(s*e)} (${t>=0?"+":""}${t.toFixed(1)}%)\n`});const m=1,p=n*c/(s*c);return l+=`\nðŸ” SENSITIVITY INSIGHTS:\nâ€¢ Revenue Elasticity: ${m.toFixed(2)}x (1% revenue change â†’ ${m.toFixed(1)}% valuation change)\nâ€¢ Margin Impact: 1pp margin change â†’ ${(100*(p-1)).toFixed(1)}% valuation change\nâ€¢ Key Driver: ${p>m?"Margin optimization":"Revenue growth"} has higher impact`,{type:"success",content:l,data:{analysis:"private_sensitivity",baseCase:{revenue:n,ebitda:s,valuation:s*c},sensitivities:{revenueElasticity:m,marginElasticity:p}}}}catch(n){return{type:"error",content:`Sensitivity analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:["variables","ranges"]}},PRIVATE_WATERFALL:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.length-1,n=t.totalRevenue?.[a]||0,s=t.operatingIncome?.[a]||0,r=.25,o=.12,l=.025,d=[{step:"Base Revenue",value:n,cumulative:n},{step:"Operating Leverage",value:s-.15*n,cumulative:s},{step:"Tax Shield",value:-s*r,cumulative:s*(1-r)},{step:"Working Capital",value:.02*-n,cumulative:s*(1-r)-.02*n},{step:"CapEx",value:.03*-n,cumulative:s*(1-r)-.05*n},{step:"Free Cash Flow",value:0,cumulative:s*(1-r)-.05*n}],m=d[d.length-1].cumulative,p=m*(1+l)/(o-l),h=4.5*m,g=p/Math.pow(1+o,5),y=h+g;let f="DCF Waterfall Analysis\n\nðŸ’§ CASH FLOW WATERFALL:\n";return d.forEach((e,t)=>{const a=0===t?"":e.value>=0?" â†— ":" â†˜ ";f+=`${t+1}. ${e.step}: ${i(e.value)} ${a}${i(e.cumulative)}\n`}),f+=`\nðŸ—ï¸ VALUATION BUILD-UP:\nâ€¢ PV of 5-Year FCF: ${i(h)}\nâ€¢ PV of Terminal Value: ${i(g)}\nâ€¢ Enterprise Value: ${i(y)}\nâ€¢ Terminal Multiple: ${(p/m).toFixed(1)}x FCF\nâ€¢ Implied FCF Yield: ${c(m/y)}`,{type:"success",content:f,data:{analysis:"private_waterfall",waterfallSteps:d,valuation:{pv5Years:h,pvTerminal:g,enterpriseValue:y}}}}catch(n){return{type:"error",content:`Waterfall analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:["discountRate","terminalGrowthRate"]}},PRIVATE_COMPS:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.length-1,n=t.totalRevenue?.[a]||0,s=(t.operatingIncome?.[a]||0)+(t.depreciation?.[a]||0),r=[{name:"Lifestyle Communities",evRevenue:2.1,evEbitda:12.5,margin:18.2},{name:"European Wax Center",evRevenue:3.2,evEbitda:15.8,margin:22.1},{name:"Planet Fitness",evRevenue:4.5,evEbitda:18.2,margin:28.5},{name:"Xponential Fitness",evRevenue:2.8,evEbitda:14.1,margin:19.8},{name:"Hand & Stone",evRevenue:2.5,evEbitda:11.2,margin:21.4}],o=n>0?s/n*100:0,l=r.reduce((e,t)=>e+t.evRevenue,0)/r.length,d=r.reduce((e,t)=>e+t.evEbitda,0)/r.length,m=r.reduce((e,t)=>e+t.margin,0)/r.length,p=n*l,h=s*d,g=(p+h)/2;let y="Comparable Company Analysis\n\nðŸ¢ PEER GROUP ANALYSIS:\n";return y+=`Trading Multiple Averages:\nâ€¢ EV/Revenue: ${l.toFixed(1)}x\nâ€¢ EV/EBITDA: ${d.toFixed(1)}x\nâ€¢ EBITDA Margin: ${m.toFixed(1)}%\n\n`,y+="ðŸ“Š DETAILED COMPARABLES:\n",r.forEach((e,t)=>{y+=`${t+1}. ${e.name}:\n   EV/Rev: ${e.evRevenue}x, EV/EBITDA: ${e.evEbitda}x, Margin: ${e.margin}%\n`}),y+=`\nðŸ’° IMPLIED VALUATION:\nâ€¢ Revenue Multiple: ${i(p)} (${l.toFixed(1)}x)\nâ€¢ EBITDA Multiple: ${i(h)} (${d.toFixed(1)}x)\nâ€¢ Average Trading Value: ${i(g)}\nâ€¢ Current EBITDA Margin: ${c(o/100)}\nâ€¢ Peer Margin Delta: ${(o-m).toFixed(1)}pp`,y+=`\nðŸŽ¯ RELATIVE POSITIONING:\nâ€¢ Multiple Premium/Discount: ${100*(g/(2.5*n+12*s)-1)>0?"+":""}${(100*(g/(2.5*n+12*s)-1)).toFixed(1)}%\nâ€¢ Margin Competitiveness: ${o>=m?"ðŸŸ¢ Above Peers":"ðŸŸ¡ Below Peers"}\nâ€¢ Size Adjustment: ${n<5e7?"Small-cap discount may apply":"Mid-cap positioning"}`,{type:"success",content:y,data:{analysis:"private_comps",comparables:r,peerAverages:{avgEvRevenue:l,avgEvEbitda:d,avgMargin:m},impliedValuation:{tradingValuationRevenue:p,tradingValuationEbitda:h,avgTradingValuation:g}}}}catch(n){return{type:"error",content:`Comparable analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:["sector","size"]}},PRIVATE_LBO:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.length-1,n=(t.totalRevenue,(t.operatingIncome?.[a]||0)+(t.depreciation?.[a]||0)),s=10*n,r=.3*s,o=.7*s,l=.08,d=12,m=5,p=.08,h=[];for(let i=1;i<=m;i++)h.push(n*Math.pow(1+p,i));let g=o;const y=[];h.forEach((e,t)=>{const a=.6*e,n=g*l,s=Math.min(.5*(a-n),.2*g);g=Math.max(0,g-s),y.push({year:t+1,ebitda:e,debt:g,reduction:s})});const f=h[m-1],S=f*d,v=S-g,A=v/r,x=Math.pow(A,1/m)-1,E=A;let T=`Leveraged Buyout Analysis\n\nðŸ’¼ TRANSACTION STRUCTURE:\nâ€¢ Purchase Price: ${i(s)} (${(s/n).toFixed(1)}x EBITDA)\nâ€¢ Equity Investment: ${i(r)} (${c(r/s)})\nâ€¢ Debt Financing: ${i(o)} (${c(o/s)})\nâ€¢ Interest Rate: ${c(l)}\n\n`;return T+="ðŸ“ˆ EBITDA PROJECTIONS:\n",h.forEach((e,t)=>{T+=`Year ${t+1}: ${i(e)} (${c(p)} growth)\n`}),T+="\nðŸ¦ DEBT PAYDOWN SCHEDULE:\n",y.forEach(e=>{T+=`Year ${e.year}: Debt ${i(e.debt)}, Paydown ${i(e.reduction)}\n`}),T+=`\nðŸŽ¯ EXIT ANALYSIS (Year ${m}):\nâ€¢ Exit EBITDA: ${i(f)}\nâ€¢ Exit Multiple: ${d}x\nâ€¢ Exit Value: ${i(S)}\nâ€¢ Remaining Debt: ${i(g)}\nâ€¢ Net Proceeds: ${i(v)}\n\nðŸ’° INVESTOR RETURNS:\nâ€¢ Total Return: ${i(v)} (${A.toFixed(1)}x)\nâ€¢ Money-on-Money: ${E.toFixed(1)}x\nâ€¢ IRR: ${c(x)}\nâ€¢ Return Quality: ${x>.2?"ðŸŸ¢ Excellent":x>.15?"ðŸŸ¡ Good":"ðŸ”´ Poor"}`,{type:"success",content:T,data:{analysis:"private_lbo",transaction:{purchasePrice:s,equityContribution:r,debtFinancing:o},projections:h,returns:{totalReturn:A,moic:E,irr:x}}}}catch(n){return{type:"error",content:`LBO analysis failed: ${n.message}`}}},parameterSchema:{required:[],optional:["leverage","holdPeriod","exitMultiple"]}},PRIVATE_QUALITY:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods,s=[],r=a.map((e,a)=>t.totalRevenue?.[a]||0),i=(e=>{if(e.length<3)return 50;const t=[];for(let s=1;s<e.length;s++)e[s-1]>0&&t.push(100*(e[s]/e[s-1]-1));const a=t.reduce((e,t)=>e+t,0)/t.length,n=Math.sqrt(t.reduce((e,t)=>e+Math.pow(t-a,2),0)/(t.length-1));return Math.max(0,Math.min(100,80-2*n))})(r),o=((e,t)=>{const a=e.injectables?.[t]||0,n=e.wellness?.[t]||0,s=e.totalRevenue?.[t]||0,r=s>0?(a+n)/s:0;return Math.min(100,100*r+20)})(t,a.length-1);s.push({metric:"Revenue Quality",score:.6*i+.4*o,weight:25});const c=r.map((e,a)=>{const n=t.operatingIncome?.[a]||0;return e>0?n/e*100:0}),l=(e=>{if(e.length<2)return 50;const t=e.reduce((e,t)=>e+t,0)/e.length,a=Math.sqrt(e.reduce((e,a)=>e+Math.pow(a-t,2),0)/(e.length-1));return Math.max(0,Math.min(100,90-5*a))})(c),d=(e=>{if(e.length<2)return 50;const t=(e[e.length-1]-e[0])/e.length;return Math.max(0,Math.min(100,60+10*t))})(c);s.push({metric:"Profitability Quality",score:.7*l+.3*d,weight:30});const m=85,p=90;s.push({metric:"Cash Generation",score:(m+p)/2,weight:20});const h=75,g=(e=>{const t=e.length>1?100*(e[e.length-1]/e[0]-1)/(e.length-1):0;return Math.min(100,Math.max(0,50+2*t))})(r);s.push({metric:"Competitive Position",score:.6*h+.4*g,weight:15});const y=75,f=80;s.push({metric:"Financial Strength",score:(y+f)/2,weight:10});const S=s.reduce((e,t)=>e+t.score*t.weight/100,0),v=S>=80?"A":S>=70?"B":S>=60?"C":S>=50?"D":"F";let A=`Business Quality Assessment\n\nðŸ† OVERALL QUALITY SCORE: ${S.toFixed(1)}/100 (Grade: ${v})\n\nðŸ“Š QUALITY BREAKDOWN:\n`;return s.forEach(e=>{const t=e.score>=80?"A":e.score>=70?"B":e.score>=60?"C":"D";A+=`â€¢ ${e.metric}: ${e.score.toFixed(1)}/100 (${t}) - Weight: ${e.weight}%\n`}),A+=`\nðŸŽ¯ QUALITY ANALYSIS:\nâ€¢ Investment Grade: ${"A"===v?"ðŸŸ¢ High Quality":"B"===v?"ðŸŸ¡ Good Quality":"C"===v?"ðŸŸ  Average Quality":"ðŸ”´ Below Average"}\nâ€¢ Risk Profile: ${S>=75?"Low-Medium Risk":S>=60?"Medium Risk":"Medium-High Risk"}\nâ€¢ Valuation Multiple Premium: ${S>=80?"10-15%":S>=70?"5-10%":S>=60?"0-5%":"Discount warranted"}\n\nðŸ’¡ KEY STRENGTHS:\n${n=s,n.filter(e=>e.score>=80).map(e=>`â€¢ ${e.metric}: Strong performance`).join("\n")||"â€¢ Need to improve overall performance"}\n\nâš ï¸ AREAS FOR IMPROVEMENT:\n${(e=>e.filter(e=>e.score<70).map(e=>`â€¢ ${e.metric}: Below target performance`).join("\n")||"â€¢ No major weaknesses identified")(s)}`,{type:"success",content:A,data:{analysis:"private_quality",overallScore:S,qualityGrade:v,metrics:s}}}catch(s){return{type:"error",content:`Quality assessment failed: ${s.message}`}}var n},parameterSchema:{required:[],optional:["weights"]}},PRIVATE_WORKFLOW:{execute:async(e,t,a)=>{try{const e=u,t=(e.statements.incomeStatement,e.periods,[{step:"Data Quality",completed:!0,score:85,next:"PRIVATE_VALIDATE()"},{step:"Company Overview",completed:!1,score:0,next:"PRIVATE_SUMMARY()"},{step:"Financial Analysis",completed:!1,score:0,next:"PRIVATE_RATIOS()"},{step:"Valuation Models",completed:!1,score:0,next:"PRIVATE_DCF() & PRIVATE_MULTIPLES()"},{step:"Risk Assessment",completed:!1,score:0,next:"PRIVATE_RISK() & PRIVATE_SCENARIO()"},{step:"Benchmarking",completed:!1,score:0,next:"PRIVATE_BENCHMARKS() & PRIVATE_COMPS()"},{step:"Advanced Models",completed:!1,score:0,next:"PRIVATE_LBO() & PRIVATE_MONTE_CARLO()"},{step:"Final Report",completed:!1,score:0,next:"PRIVATE_EXPORT()"}]),a=t.filter(e=>e.completed).length/t.length*100,s=t.find(e=>!e.completed);let r=`Private Analysis Workflow\n\nðŸ“‹ WORKFLOW PROGRESS: ${a.toFixed(0)}% Complete\n\nðŸ”„ ANALYSIS STEPS:\n`;return t.forEach((e,a)=>{const n=e.completed?"âœ…":a===t.findIndex(e=>!e.completed)?"ðŸ”„":"â³";r+=`${a+1}. ${n} ${e.step} ${e.completed?`(${e.score}%)`:""}\n   Next: ${e.next}\n\n`}),r+=`ðŸŽ¯ RECOMMENDED NEXT STEPS:\nâ€¢ ${s?s.next:"All steps completed!"}\nâ€¢ Focus on ${s?s.step.toLowerCase():"final review"}\nâ€¢ Estimated time: ${n=s?.step,{"Data Quality":"2-3 minutes","Company Overview":"3-5 minutes","Financial Analysis":"5-8 minutes","Valuation Models":"8-12 minutes","Risk Assessment":"5-7 minutes",Benchmarking:"4-6 minutes","Advanced Models":"10-15 minutes","Final Report":"2-3 minutes"}[n]||"5 minutes"}\n\nðŸ“Š WORKFLOW INSIGHTS:\nâ€¢ Data completeness: ${(e=>{const t=Object.keys(e.statements.incomeStatement).length+Object.keys(e.statements.balanceSheet).length+Object.keys(e.statements.cashFlow).length;return Math.min(100,t/50*100)})(e)}%\nâ€¢ Analysis depth: ${(e=>{const t=e.filter(e=>e.completed).length;return t>=6?"Comprehensive":t>=4?"Detailed":t>=2?"Basic":"Initial"})(t)}\nâ€¢ Report readiness: ${a>=80?"ðŸŸ¢ Ready":a>=50?"ðŸŸ¡ Partial":"ðŸ”´ Incomplete"}`,{type:"success",content:r,data:{analysis:"private_workflow",workflowSteps:t,progress:a,nextStep:s?.step}}}catch(s){return{type:"error",content:`Workflow analysis failed: ${s.message}`}}var n},parameterSchema:{required:[],optional:[]}},PRIVATE_DASHBOARD:{execute:async(e,t,a)=>{try{const e=u,t=e.statements.incomeStatement,a=e.periods.length-1,r=t.totalRevenue?.[a]||0,o=t.grossProfit?.[a]||0,c=t.operatingIncome?.[a]||0,l=c+(t.depreciation?.[a]||.02*r),d=a>0&&t.totalRevenue?.[a-1]>0?100*(r/t.totalRevenue[a-1]-1):0,m=r>0?o/r*100:0,p=r>0?c/r*100:0,h=r>0?l/r*100:0,g=(r*2.5+l*10)/2,y=(e=>{let t=0;return t+=Math.min(25,Math.max(0,15+e.revenueGrowth)),t+=Math.min(25,.5*e.grossMargin),t+=Math.min(30,2*e.operatingMargin),t+=Math.min(20,1.2*e.ebitdaMargin),Math.round(t)})({revenueGrowth:d,grossMargin:m,operatingMargin:p,ebitdaMargin:h});let f=`ðŸ“Š EXECUTIVE DASHBOARD\n\nðŸ’° FINANCIAL SNAPSHOT (${e.periods[a]}):\n`;return f+="â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n",f+=`â”‚ Revenue:        ${i(r).padEnd(20)} â”‚\n`,f+=`â”‚ EBITDA:         ${i(l).padEnd(20)} â”‚\n`,f+=`â”‚ Operating Inc:  ${i(c).padEnd(20)} â”‚\n`,f+=`â”‚ Est. Valuation: ${i(g).padEnd(20)} â”‚\n`,f+="â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n",f+="ðŸ“ˆ KEY PERFORMANCE INDICATORS:\n",f+=`â€¢ Revenue Growth:    ${d>=0?"+":""}${d.toFixed(1)}% ${s=d,s>=15?"ðŸš€":s>=5?"ðŸ“ˆ":s>=0?"âž¡ï¸":"ðŸ“‰"}\n`,f+=`â€¢ Gross Margin:      ${m.toFixed(1)}% ${V(m,"gross")}\n`,f+=`â€¢ Operating Margin:  ${p.toFixed(1)}% ${V(p,"operating")}\n`,f+=`â€¢ EBITDA Margin:     ${h.toFixed(1)}% ${V(h,"ebitda")}\n\n`,f+=`ðŸŽ¯ PERFORMANCE SCORE: ${y}/100\n`,f+=`Rating: ${n=y,n>=80?"ðŸ† Excellent":n>=70?"ðŸ¥‡ Very Good":n>=60?"ðŸ¥ˆ Good":n>=50?"ðŸ¥‰ Fair":"ðŸ“Š Needs Improvement"}\n\n`,f+="ðŸ” QUICK ACTIONS:\nâ€¢ Run PRIVATE_DCF() for detailed valuation\nâ€¢ Execute PRIVATE_BENCHMARKS() for peer comparison\nâ€¢ Use PRIVATE_SCENARIO() for risk modeling\nâ€¢ Try PRIVATE_QUALITY() for investment grade analysis",{type:"success",content:f,data:{analysis:"private_dashboard",metrics:{revenue:r,ebitda:l,operatingIncome:c,impliedValuation:g},kpis:{revenueGrowth:d,grossMargin:m,operatingMargin:p,ebitdaMargin:h},performanceScore:y}}}catch(r){return{type:"error",content:`Dashboard generation failed: ${r.message}`}}var n,s},parameterSchema:{required:[],optional:["period"]}},PRIVATE:{execute:async(e,t,a)=>{const n=[{cmd:"PRIVATE_LOAD()",desc:"Load and validate private financial data",cat:"ðŸ“Š CORE ANALYSIS"},{cmd:"PRIVATE_SUMMARY()",desc:"Generate executive summary of company performance",cat:"ðŸ“Š CORE ANALYSIS"},{cmd:"PRIVATE_DCF()",desc:"Run discounted cash flow valuation analysis",cat:"ðŸ“Š CORE ANALYSIS"},{cmd:"PRIVATE_RATIOS()",desc:"Calculate comprehensive financial ratios",cat:"ðŸ“Š CORE ANALYSIS"},{cmd:"PRIVATE_WATERFALL()",desc:"DCF waterfall and value bridge analysis",cat:"ðŸ’° VALUATION"},{cmd:"PRIVATE_COMPS()",desc:"Comparable company trading multiples analysis",cat:"ðŸ’° VALUATION"},{cmd:"PRIVATE_LBO()",desc:"Leveraged buyout model and returns analysis",cat:"ðŸ’° VALUATION"},{cmd:"PRIVATE_MULTIPLES()",desc:"Valuation using industry multiples approach",cat:"ðŸ’° VALUATION"},{cmd:"PRIVATE_QUALITY()",desc:"Business quality and investment grade assessment",cat:"ðŸ“ˆ ANALYTICS"},{cmd:"PRIVATE_BENCHMARKS()",desc:"Compare metrics against industry benchmarks",cat:"ðŸ“ˆ ANALYTICS"},{cmd:"PRIVATE_CASHFLOW()",desc:"Analyze cash flow generation and quality",cat:"ðŸ“ˆ ANALYTICS"},{cmd:"PRIVATE_GROWTH()",desc:"Assess revenue growth trends and sustainability",cat:"ðŸ“ˆ ANALYTICS"},{cmd:"PRIVATE_RISK()",desc:"Evaluate business risk factors and volatility",cat:"ðŸ“ˆ ANALYTICS"},{cmd:"PRIVATE_MONTE_CARLO()",desc:"Monte Carlo simulation for valuation ranges",cat:"ðŸ“ˆ ANALYTICS"},{cmd:"PRIVATE_SCENARIO()",desc:"Run bull/base/bear case scenario analysis",cat:"ðŸ“ˆ ANALYTICS"},{cmd:"PRIVATE_SENSITIVITY()",desc:"Sensitivity analysis on key variables",cat:"ðŸ“ˆ ANALYTICS"},{cmd:"PRIVATE_WORKFLOW()",desc:"Interactive analysis workflow with recommendations",cat:"ðŸ¤– AUTOMATION"},{cmd:"PRIVATE_DASHBOARD()",desc:"Executive dashboard with key metrics summary",cat:"ðŸ“‹ REPORTING"},{cmd:"PRIVATE_VALIDATE()",desc:"Validate data quality and completeness",cat:"ðŸ’¾ DATA MANAGEMENT"},{cmd:"PRIVATE_EXPORT()",desc:"Export analysis data and results",cat:"ðŸ’¾ DATA MANAGEMENT"},{cmd:"PRIVATE_HELP()",desc:"Show all available private analysis commands",cat:"ðŸ› ï¸ UTILITY"}];let s=`ðŸš€ **Private Analysis CLI Commands (${n.length} Total)**\n\n`;return[...new Set(n.map(e=>e.cat))].forEach(e=>{const t=n.filter(t=>t.cat===e);s+=`### **${e}**\n`,t.forEach(e=>{s+=`- **${e.cmd}** - ${e.desc}\n`}),s+="\n"}),s+="### **ðŸ’¡ USAGE EXAMPLES:**\n",s+="```\n",s+="PRIVATE_LOAD()           # Start with data validation\n",s+="PRIVATE_SUMMARY()        # Get company overview\n",s+="PRIVATE_DCF()           # Run DCF valuation\n",s+="PRIVATE_COMPS()         # Comparable analysis\n",s+="PRIVATE_LBO()           # LBO modeling\n",s+="PRIVATE_DASHBOARD()     # Executive summary\n",s+="PRIVATE_WORKFLOW()      # Guided analysis\n",s+="```\n\n",s+="**All commands work with the default private financial data and provide professional-grade analysis suitable for investment banking, private equity, and corporate finance workflows.**",{type:"success",content:s,data:{analysis:"private_commands_list",commands:n.map(e=>e.cmd),totalCommands:n.length}}},parameterSchema:{required:[],optional:[]}}};f.register("DCF",w.DCF,{category:"CORE",description:"Discounted Cash Flow valuation with real-time data",usage:"DCF(ticker)",examples:["DCF(AAPL)","DCF(MSFT)"],tags:["valuation","dcf","analysis"],parameterSchema:{required:["ticker"],optional:[]}}),f.register("LBO",w.LBO,{category:"CORE",description:"Leveraged Buyout analysis with return projections",usage:"LBO(ticker)",examples:["LBO(TSLA)","LBO(NVDA)"],tags:["lbo","private-equity","analysis"],parameterSchema:{required:["ticker"],optional:[]}}),f.register("COMP",w.COMP,{category:"CORE",description:"Comparable company analysis with peer multiples",usage:"COMP(ticker)",examples:["COMP(GOOGL)","COMP(META)"],tags:["comparable","multiples","analysis"],parameterSchema:{required:["ticker"],optional:[]}}),f.register("FETCH",w.FETCH,{category:"CORE",description:"Comprehensive company data and financial metrics",usage:"FETCH(ticker)",examples:["FETCH(AMZN)","FETCH(NFLX)"],tags:["data","profile","metrics"],parameterSchema:{required:["ticker"],optional:[]}}),f.register("PRIVATE_DCF",F.PRIVATE_DCF,{category:"CORE",description:"DCF valuation using private company financial data",usage:"PRIVATE_DCF()",examples:["PRIVATE_DCF()"],tags:["private","dcf","valuation","analysis"],parameterSchema:{required:[],optional:["discountRate","terminalGrowthRate","taxRate"]}}),f.register("PRIVATE_RATIOS",F.PRIVATE_RATIOS,{category:"CORE",description:"Financial ratios analysis for private company data",usage:"PRIVATE_RATIOS()",examples:["PRIVATE_RATIOS()"],tags:["private","ratios","analysis","margins"],parameterSchema:{required:[],optional:[]}}),f.register("PRIVATE_SUMMARY",F.PRIVATE_SUMMARY,{category:"CORE",description:"Comprehensive financial summary of private company",usage:"PRIVATE_SUMMARY()",examples:["PRIVATE_SUMMARY()"],tags:["private","summary","overview","financial"],parameterSchema:{required:[],optional:[]}}),f.register("PRIVATE_LOAD",F.PRIVATE_LOAD,{category:"DATA",description:"Load and verify private company financial data",usage:"PRIVATE_LOAD()",examples:["PRIVATE_LOAD()"],tags:["private","data","load","verification"],parameterSchema:{required:[],optional:[]}}),f.register("PRIVATE_MONTE_CARLO",F.PRIVATE_MONTE_CARLO,{category:"ANALYTICS",description:"Monte Carlo simulation for private company valuation",usage:"PRIVATE_MONTE_CARLO()",examples:["PRIVATE_MONTE_CARLO()","PRIVATE_MONTE_CARLO(5000)"],tags:["private","monte-carlo","simulation","risk"],parameterSchema:{required:[],optional:["iterations"]}}),f.register("PRIVATE_SCENARIO",F.PRIVATE_SCENARIO,{category:"ANALYTICS",description:"Scenario analysis for private company valuation",usage:"PRIVATE_SCENARIO()",examples:["PRIVATE_SCENARIO()"],tags:["private","scenario","analysis","valuation"],parameterSchema:{required:[],optional:["scenarios"]}}),f.register("PRIVATE_GROWTH",F.PRIVATE_GROWTH,{category:"ANALYTICS",description:"Growth trend analysis for private company",usage:"PRIVATE_GROWTH()",examples:["PRIVATE_GROWTH()"],tags:["private","growth","trends","cagr"],parameterSchema:{required:[],optional:[]}}),f.register("PRIVATE_RISK",F.PRIVATE_RISK,{category:"ANALYTICS",description:"Risk assessment for private company",usage:"PRIVATE_RISK()",examples:["PRIVATE_RISK()"],tags:["private","risk","volatility","assessment"],parameterSchema:{required:[],optional:[]}}),f.register("PRIVATE_VALIDATE",F.PRIVATE_VALIDATE,{category:"DATA",description:"Validate private company financial data",usage:"PRIVATE_VALIDATE()",examples:["PRIVATE_VALIDATE()"],tags:["private","validation","data-quality","verification"],parameterSchema:{required:[],optional:[]}}),f.register("PRIVATE_EXPORT",F.PRIVATE_EXPORT,{category:"DATA",description:"Export private company analysis results",usage:"PRIVATE_EXPORT()",examples:["PRIVATE_EXPORT()","PRIVATE_EXPORT(csv)"],tags:["private","export","data","backup"],parameterSchema:{required:[],optional:["format"]}}),f.register("PRIVATE_WATERFALL",F.PRIVATE_WATERFALL,{category:"VALUATION",description:"DCF waterfall and value bridge analysis for private companies",usage:"PRIVATE_WATERFALL()",examples:["PRIVATE_WATERFALL()"],tags:["private","dcf","waterfall","analysis"],parameterSchema:{required:[],optional:["discountRate","terminalGrowthRate"]}}),f.register("PRIVATE_COMPS",F.PRIVATE_COMPS,{category:"VALUATION",description:"Comparable company trading multiples analysis",usage:"PRIVATE_COMPS()",examples:["PRIVATE_COMPS()"],tags:["private","comparables","trading-multiples","peer-analysis"],parameterSchema:{required:[],optional:["sector","size"]}}),f.register("PRIVATE_LBO",F.PRIVATE_LBO,{category:"VALUATION",description:"Leveraged buyout model and returns analysis",usage:"PRIVATE_LBO()",examples:["PRIVATE_LBO()"],tags:["private","lbo","leveraged-buyout","pe-analysis"],parameterSchema:{required:[],optional:["leverage","holdPeriod","exitMultiple"]}}),f.register("PRIVATE_QUALITY",F.PRIVATE_QUALITY,{category:"ANALYTICS",description:"Business quality and investment grade assessment",usage:"PRIVATE_QUALITY()",examples:["PRIVATE_QUALITY()"],tags:["private","quality","investment-grade","assessment"],parameterSchema:{required:[],optional:["weights"]}}),f.register("PRIVATE_BENCHMARKS",F.PRIVATE_BENCHMARKS,{category:"ANALYTICS",description:"Compare metrics against industry benchmarks",usage:"PRIVATE_BENCHMARKS()",examples:["PRIVATE_BENCHMARKS()"],tags:["private","benchmarks","industry","comparison"],parameterSchema:{required:[],optional:["industry"]}}),f.register("PRIVATE_CASHFLOW",F.PRIVATE_CASHFLOW,{category:"ANALYTICS",description:"Analyze cash flow generation and quality",usage:"PRIVATE_CASHFLOW()",examples:["PRIVATE_CASHFLOW()"],tags:["private","cashflow","quality","analysis"],parameterSchema:{required:[],optional:["years"]}}),f.register("PRIVATE_MULTIPLES",F.PRIVATE_MULTIPLES,{category:"VALUATION",description:"Valuation using industry multiples approach",usage:"PRIVATE_MULTIPLES()",examples:["PRIVATE_MULTIPLES()"],tags:["private","multiples","valuation","industry"],parameterSchema:{required:[],optional:["industry","size"]}}),f.register("PRIVATE_SENSITIVITY",F.PRIVATE_SENSITIVITY,{category:"ANALYTICS",description:"Sensitivity analysis on key variables",usage:"PRIVATE_SENSITIVITY()",examples:["PRIVATE_SENSITIVITY()"],tags:["private","sensitivity","analysis","variables"],parameterSchema:{required:[],optional:["variables","ranges"]}}),f.register("PRIVATE_WORKFLOW",F.PRIVATE_WORKFLOW,{category:"AUTOMATION",description:"Interactive analysis workflow with recommendations",usage:"PRIVATE_WORKFLOW()",examples:["PRIVATE_WORKFLOW()"],tags:["private","workflow","guidance","automation"],parameterSchema:{required:[],optional:[]}}),f.register("PRIVATE_DASHBOARD",F.PRIVATE_DASHBOARD,{category:"REPORTING",description:"Executive dashboard with key metrics summary",usage:"PRIVATE_DASHBOARD()",examples:["PRIVATE_DASHBOARD()"],tags:["private","dashboard","executive","summary"],parameterSchema:{required:[],optional:["period"]}}),f.register("PRIVATE",F.PRIVATE,{category:"UTILITY",description:"Show all available Private Analysis commands (shortcut)",usage:"PRIVATE()",examples:["PRIVATE()","private"],tags:["private","help","commands","list"],parameterSchema:{required:[],optional:[]}}),f.register("PORTFOLIO",I.PORTFOLIO,{category:"PORTFOLIO",description:"Portfolio analysis with risk and diversification metrics",usage:"PORTFOLIO(tickers, weights)",examples:["PORTFOLIO([AAPL,MSFT,GOOGL], [0.4,0.3,0.3])","PORTFOLIO([SPY,QQQ], [0.6,0.4])"],tags:["portfolio","diversification","allocation"],parameterSchema:{required:["tickers","weights"],optional:[]}}),f.register("RISK_METRICS",I.RISK_METRICS,{category:"PORTFOLIO",description:"Comprehensive risk analysis including VaR, Sharpe ratio, and volatility",usage:"RISK_METRICS(ticker, period)",examples:["RISK_METRICS(AAPL)","RISK_METRICS(TSLA, 252)"],tags:["risk","var","volatility","sharpe"],parameterSchema:{required:["ticker"],optional:["period"]}}),f.register("CORRELATION_MATRIX",I.CORRELATION_MATRIX,{category:"PORTFOLIO",description:"Cross-asset correlation analysis for diversification insights",usage:"CORRELATION_MATRIX(tickers)",examples:["CORRELATION_MATRIX([AAPL,MSFT,GOOGL])","CORRELATION_MATRIX([SPY,QQQ,IWM])"],tags:["correlation","diversification","matrix"],parameterSchema:{required:["tickers"],optional:[]}}),f.register("EFFICIENT_FRONTIER",I.EFFICIENT_FRONTIER,{category:"PORTFOLIO",description:"Modern portfolio theory optimization and efficient frontier analysis",usage:"EFFICIENT_FRONTIER(tickers)",examples:["EFFICIENT_FRONTIER([AAPL,MSFT,GOOGL])","EFFICIENT_FRONTIER([SPY,QQQ,IWM,EFA])"],tags:["optimization","efficient-frontier","mpt"],parameterSchema:{required:["tickers"],optional:[]}}),f.register("DRAWDOWN",I.DRAWDOWN,{category:"PORTFOLIO",description:"Maximum drawdown analysis and recovery time estimation",usage:"DRAWDOWN(ticker, period)",examples:["DRAWDOWN(AAPL)","DRAWDOWN(TSLA, 500)"],tags:["drawdown","risk","recovery"],parameterSchema:{required:["ticker"],optional:["period"]}}),f.register("DDM",R.DDM,{category:"VALUATION",description:"Dividend Discount Model with Gordon Growth and Two-Stage analysis",usage:"DDM(ticker)",examples:["DDM(KO)","DDM(JNJ)"],tags:["dividend","ddm","gordon-growth"],parameterSchema:{required:["ticker"],optional:[]}}),f.register("RESIDUAL_INCOME",R.RESIDUAL_INCOME,{category:"VALUATION",description:"Residual Income Model for economic value analysis",usage:"RESIDUAL_INCOME(ticker)",examples:["RESIDUAL_INCOME(AAPL)","RESIDUAL_INCOME(MSFT)"],tags:["residual-income","economic-value","roe"],parameterSchema:{required:["ticker"],optional:[]}}),f.register("ASSET_BASED",R.ASSET_BASED,{category:"VALUATION",description:"Asset-based valuation with market value adjustments",usage:"ASSET_BASED(ticker)",examples:["ASSET_BASED(BRK.A)","ASSET_BASED(BAC)"],tags:["asset-based","nav","liquidation"],parameterSchema:{required:["ticker"],optional:[]}}),f.register("TECHNICALS",$.TECHNICALS,{category:"TECHNICAL",description:"Comprehensive technical analysis with RSI, MACD, Bollinger Bands",usage:"TECHNICALS(ticker)",examples:["TECHNICALS(AAPL)","TECHNICALS(SPY)"],tags:["technical","rsi","macd","bollinger"],parameterSchema:{required:["ticker"],optional:[]}}),f.register("SUPPORT_RESISTANCE",$.SUPPORT_RESISTANCE,{category:"TECHNICAL",description:"Key price levels and breakout targets analysis",usage:"SUPPORT_RESISTANCE(ticker)",examples:["SUPPORT_RESISTANCE(TSLA)","SUPPORT_RESISTANCE(QQQ)"],tags:["support","resistance","levels","breakout"],parameterSchema:{required:["ticker"],optional:[]}}),f.register("ESG_SCORE",N.ESG_SCORE,{category:"ESG",description:"Environmental, social, governance analysis and scoring",usage:"ESG_SCORE(ticker)",examples:["ESG_SCORE(AAPL)","ESG_SCORE(TSLA)"],tags:["esg","environmental","social","governance"],parameterSchema:{required:["ticker"],optional:[]}}),f.register("SOCIAL_SENTIMENT",N.SOCIAL_SENTIMENT,{category:"ESG",description:"Social media sentiment analysis across platforms",usage:"SOCIAL_SENTIMENT(ticker, days)",examples:["SOCIAL_SENTIMENT(AAPL)","SOCIAL_SENTIMENT(TSLA, 30)"],tags:["sentiment","social-media","twitter","reddit"],parameterSchema:{required:["ticker"],optional:["days"]}}),f.register("NEWS_IMPACT",N.NEWS_IMPACT,{category:"ESG",description:"News sentiment and price impact analysis",usage:"NEWS_IMPACT(ticker, days)",examples:["NEWS_IMPACT(AAPL)","NEWS_IMPACT(MSFT, 14)"],tags:["news","sentiment","impact","catalyst"],parameterSchema:{required:["ticker"],optional:["days"]}}),f.register("WATCHLIST",P.WATCHLIST,{category:"AUTOMATION",description:"Create and manage stock watchlists with analysis",usage:"WATCHLIST(action, name, tickers)",examples:["WATCHLIST(list)",'WATCHLIST(create, "Tech", [AAPL,MSFT])','WATCHLIST(analyze, "Tech")'],tags:["watchlist","portfolio","tracking"],parameterSchema:{required:["action"],optional:["name","tickers"]}}),f.register("ALERT",P.ALERT,{category:"AUTOMATION",description:"Set price and metric alerts for stocks",usage:"ALERT(ticker, condition, value)",examples:['ALERT(AAPL, "price_above", 150)',"ALERT(list)","ALERT(clear)"],tags:["alerts","monitoring","notifications"],parameterSchema:{required:["ticker","condition","value"],optional:[]}}),f.register("BATCH_ANALYSIS",P.BATCH_ANALYSIS,{category:"AUTOMATION",description:"Analyze multiple stocks simultaneously with ranking",usage:"BATCH_ANALYSIS(tickers, type)",examples:["BATCH_ANALYSIS([AAPL,MSFT,GOOGL])",'BATCH_ANALYSIS([SPY,QQQ,IWM], "detailed")'],tags:["batch","screening","ranking"],parameterSchema:{required:["tickers"],optional:["type"]}}),f.register("WATCHLIST",P.WATCHLIST,{category:"AUTOMATION",description:"Create and manage stock watchlists with analysis",usage:"WATCHLIST(action, name, tickers)",examples:["WATCHLIST(list)",'WATCHLIST(create, "Tech", [AAPL,MSFT])','WATCHLIST(analyze, "Tech")'],tags:["watchlist","portfolio","tracking"],parameterSchema:{required:["action"],optional:["name","tickers"]}}),f.register("ALERT",P.ALERT,{category:"AUTOMATION",description:"Set price and metric alerts for stocks",usage:"ALERT(ticker, condition, value)",examples:['ALERT(AAPL, "price_above", 150)',"ALERT(list)","ALERT(clear)"],tags:["alerts","monitoring","notifications"],parameterSchema:{required:["ticker","condition","value"],optional:[]}}),f.register("BATCH_ANALYSIS",P.BATCH_ANALYSIS,{category:"AUTOMATION",description:"Analyze multiple stocks simultaneously with ranking",usage:"BATCH_ANALYSIS(tickers, type)",examples:["BATCH_ANALYSIS([AAPL,MSFT,GOOGL])",'BATCH_ANALYSIS([SPY,QQQ,IWM], "detailed")'],tags:["batch","screening","ranking"],parameterSchema:{required:["tickers"],optional:["type"]}}),f.register("EXPORT_JSON",k.EXPORT_JSON,{category:"DATA",description:"Export data to JSON format for backup and sharing",usage:"EXPORT_JSON(dataType, filename)",examples:['EXPORT_JSON("watchlists")','EXPORT_JSON("all", "backup.json")'],tags:["export","backup","json"],parameterSchema:{required:["dataType"],optional:["filename"]}}),f.register("CACHE_STATS",k.CACHE_STATS,{category:"DATA",description:"View cache performance and memory usage statistics",usage:"CACHE_STATS()",examples:["CACHE_STATS()"],tags:["cache","performance","memory"],parameterSchema:{required:[],optional:[]}}),f.register("DATA_QUALITY",k.DATA_QUALITY,{category:"DATA",description:"Analyze data completeness and quality for a stock",usage:"DATA_QUALITY(ticker)",examples:["DATA_QUALITY(AAPL)","DATA_QUALITY(TSLA)"],tags:["quality","validation","completeness"],parameterSchema:{required:["ticker"],optional:[]}}),f.register("BENCHMARK",k.BENCHMARK,{category:"DATA",description:"Compare stock performance against benchmark index",usage:"BENCHMARK(ticker, benchmark)",examples:["BENCHMARK(AAPL, SPY)","BENCHMARK(TSLA, QQQ)"],tags:["benchmark","comparison","performance"],parameterSchema:{required:["ticker"],optional:["benchmark"]}}),f.register("PERFORMANCE_TEST",M.PERFORMANCE_TEST,{category:"SYSTEM",description:"Run comprehensive system performance benchmarks",usage:"PERFORMANCE_TEST()",examples:["PERFORMANCE_TEST()"],tags:["performance","benchmark","system"],parameterSchema:{required:[],optional:[]}}),f.register("API_USAGE",M.API_USAGE,{category:"SYSTEM",description:"Monitor API usage, rate limits, and costs",usage:"API_USAGE()",examples:["API_USAGE()"],tags:["api","usage","limits","cost"],parameterSchema:{required:[],optional:[]}}),f.register("CONFIG",M.CONFIG,{category:"SYSTEM",description:"View and update system configuration settings",usage:"CONFIG(setting, value)",examples:["CONFIG()",'CONFIG("currency", "EUR")','CONFIG("precision", 3)'],tags:["config","settings","preferences"],parameterSchema:{required:[],optional:["setting","value"]}}),f.register("BACKUP_CREATE",j.BACKUP_CREATE,{category:"PERSISTENCE",description:"Create a backup of all user data",usage:"BACKUP_CREATE(description)",examples:["BACKUP_CREATE()",'BACKUP_CREATE("Before major changes")'],tags:["backup","data","export"],parameterSchema:{required:[],optional:["description"]}}),f.register("BACKUP_LIST",j.BACKUP_LIST,{category:"PERSISTENCE",description:"List all available backups",usage:"BACKUP_LIST()",examples:["BACKUP_LIST()"],tags:["backup","list","management"],parameterSchema:{required:[],optional:[]}}),f.register("BACKUP_RESTORE",j.BACKUP_RESTORE,{category:"PERSISTENCE",description:"Restore data from a backup",usage:"BACKUP_RESTORE(backupId, overwrite)",examples:['BACKUP_RESTORE("backup_123")','BACKUP_RESTORE("backup_123", "true")'],tags:["backup","restore","recovery"],parameterSchema:{required:["backupId"],optional:["overwrite"]}}),f.register("STORAGE_STATS",j.STORAGE_STATS,{category:"PERSISTENCE",description:"View storage usage and statistics",usage:"STORAGE_STATS()",examples:["STORAGE_STATS()"],tags:["storage","statistics","usage"],parameterSchema:{required:[],optional:[]}}),f.register("PRIVACY_CLEANUP",j.PRIVACY_CLEANUP,{category:"PERSISTENCE",description:"Clean up expired data according to privacy policies",usage:"PRIVACY_CLEANUP()",examples:["PRIVACY_CLEANUP()"],tags:["privacy","cleanup","gdpr"],parameterSchema:{required:[],optional:[]}}),f.register("PRIVACY_SETTINGS",j.PRIVACY_SETTINGS,{category:"PERSISTENCE",description:"View and update privacy settings",usage:"PRIVACY_SETTINGS(setting, value)",examples:["PRIVACY_SETTINGS()",'PRIVACY_SETTINGS("analytics", "false")'],tags:["privacy","settings","gdpr"],parameterSchema:{required:[],optional:["setting","value"]}}),f.register("SYNC_STATUS",j.SYNC_STATUS,{category:"PERSISTENCE",description:"View data synchronization status",usage:"SYNC_STATUS()",examples:["SYNC_STATUS()"],tags:["sync","cloud","status"],parameterSchema:{required:[],optional:[]}}),f.register("PERSISTENCE_TEST",j.PERSISTENCE_TEST,{category:"PERSISTENCE",description:"Run comprehensive persistence layer tests",usage:"PERSISTENCE_TEST()",examples:["PERSISTENCE_TEST()"],tags:["test","debug","validation"],parameterSchema:{required:[],optional:[]}}),f.register("HELP",{execute:async(e,t,a)=>{const[n]=e.parameters;if(n&&"all"===n.toLowerCase()){const e=f.getAllCommands(),t=f.getAllCategories();let a="ðŸ“š COMPREHENSIVE COMMAND REFERENCE\n";return a+="FinanceAnalyst Pro Terminal v2.4.0 - Complete Command Suite\n",a+="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n",t.forEach(e=>{const t=f.getCommandsByCategory(e.key);t.length>0&&(a+=`${e.icon} ${e.name.toUpperCase()} COMMANDS (${t.length})\n`,a+=`${e.description}\n`,a+="â”€".repeat(50)+"\n",t.forEach(e=>{a+=`\nâ€¢ ${e.usage}\n`,a+=`  ${e.description}\n`,e.examples&&e.examples.length>0&&(a+=`  Examples: ${e.examples.join(", ")}\n`),e.tags&&e.tags.length>0&&(a+=`  Tags: ${e.tags.join(", ")}\n`)}),a+="\n")}),a+=`\nðŸ“Š SUMMARY: ${e.length} total commands across ${t.length} categories\n`,a+="\nðŸ’¡ TIP: Use HELP(category) for specific category details\n",a+="ðŸ’¡ TIP: Use HELP() for quick overview and featured commands",{type:"system",content:a}}if(n){const e=f.getCommandsByCategory(n.toUpperCase());if(0===e.length)return{type:"error",content:`Unknown category: ${n}. Use HELP() to see all categories or HELP(ALL) for complete command list.`};let t=`ðŸ“‹ ${n.toUpperCase()} COMMANDS (${e.length})\n`;return t+="â•".repeat(40)+"\n\n",e.forEach(e=>{t+=`â€¢ ${e.usage}\n`,t+=`  ${e.description}\n`,e.examples&&e.examples.length>0&&(t+=`  Examples: ${e.examples.join(", ")}\n`),t+="\n"}),t+="Use HELP() for overview or HELP(ALL) for all commands.",{type:"system",content:t}}const s=f.getAllCategories(),r=f.getCommandStats(),i=Object.values(r).reduce((e,t)=>e+t.count,0);return{type:"system",content:`ðŸš€ FinanceAnalyst Pro Terminal v2.4.0 - Enhanced Command Suite\n\nðŸ“Š COMMAND CATEGORIES:\n${s.map(e=>`${e.icon} ${e.name} (${r[e.key]?.count||0} commands)\n   ${e.description}`).join("\n\n")}\n\nâ­ FEATURED COMMANDS:\nâ€¢ DCF(AAPL) - Discounted Cash Flow with live data\nâ€¢ LBO(TSLA) - Leveraged Buyout analysis\nâ€¢ PORTFOLIO([AAPL,MSFT], [0.5,0.5]) - Portfolio analysis\nâ€¢ RISK_METRICS(GOOGL) - Comprehensive risk analysis\nâ€¢ CORRELATION_MATRIX([AAPL,MSFT,GOOGL]) - Cross-asset correlations\nâ€¢ PRIVATE_DCF() - Private company DCF valuation\nâ€¢ PRIVATE_RATIOS() - Private company financial ratios\nâ€¢ PRIVATE_SUMMARY() - Private company analysis summary\n\nðŸ”§ PRIVATE ANALYSIS COMMANDS:\nâ€¢ PRIVATE_LOAD() - Load private company data\nâ€¢ PRIVATE_DCF() - DCF valuation for private companies\nâ€¢ PRIVATE_RATIOS() - Calculate private company ratios\nâ€¢ PRIVATE_SUMMARY() - Generate private company summary\n\nðŸ’¡ HELP COMMANDS:\nâ€¢ HELP() - Show this overview (current)\nâ€¢ HELP(category) - Show commands for specific category\nâ€¢ HELP(ALL) - Show complete list of ALL ${i} commands\n\nðŸ“‹ AVAILABLE CATEGORIES:\n${s.map(e=>`â€¢ ${e.key}`).join(" â€¢ ")}\n\nðŸš€ ENHANCED FEATURES:\nâ€¢ Watchlists: Create and track custom stock lists\nâ€¢ Alerts: Set price and metric notifications\nâ€¢ Batch Analysis: Analyze multiple stocks simultaneously\nâ€¢ ESG Scoring: Environmental, social, governance analysis\nâ€¢ Technical Analysis: RSI, MACD, support/resistance\nâ€¢ Advanced Valuation: DDM, residual income, asset-based models\nâ€¢ Private Company Analysis: Full financial modeling suite\n\nðŸ“Š ${s.length} categories â€¢ ${i} total commands available\n\nðŸ’¡ Pro Tip: Use HELP(ALL) to see every single command with examples!`}},parameterSchema:{required:[],optional:["category"]}},{category:"UTILITY",description:"Show available commands and usage information",usage:"HELP(category)",examples:["HELP()","HELP(PORTFOLIO)","HELP(CORE)","HELP(ALL)"],tags:["help","documentation","commands"]}),f.register("CLEAR",{execute:async(e,t,a)=>({type:"system",content:"clear_terminal",action:"clear"})},{category:"UTILITY",description:"Clear the terminal screen",usage:"CLEAR()",examples:["CLEAR()"],tags:["utility","clear","terminal"]}),f.register("STATUS",{execute:async(e,t,a)=>{const n=a.getAllSettings(),s=a.getAllVariables(),r=a.getHistory(5);return{type:"system",content:`System Status Report\n\nðŸ”§ SYSTEM CONFIGURATION:\nâ€¢ Currency: ${n.currency}\nâ€¢ Precision: ${n.precision} decimal places\nâ€¢ Date Format: ${n.dateFormat}\nâ€¢ Demo Mode: ${t.demoMode?"Enabled":"Disabled"}\n\nðŸ“Š SESSION STATISTICS:\nâ€¢ Commands Executed: ${r.length}\nâ€¢ Variables Stored: ${Object.keys(s).length}\nâ€¢ Last Command: ${r[r.length-1]?.input||"None"}\n\nðŸŒ API STATUS:\nâ€¢ Data Sources: ${t.demoMode?"Demo Data":"Live Market Data"}\nâ€¢ Rate Limits: Normal\nâ€¢ Cache Status: Active\n\nðŸ’¾ MEMORY USAGE:\nâ€¢ Command History: ${r.length} entries\nâ€¢ Variable Storage: ${Object.keys(s).length} variables\nâ€¢ Cache Size: Optimal\n\nâœ… All systems operational`}}},{category:"UTILITY",description:"Show system status and configuration",usage:"STATUS()",examples:["STATUS()"],tags:["status","system","configuration"]});const B=({onCommandExecute:n,calculationResults:s})=>{const[i,o]=a.useState([{id:1,type:"system",content:"FinanceAnalyst Pro Terminal v2.4.0 - Enhanced Command Suite Ready",timestamp:new Date},{id:2,type:"system",content:'Type "HELP()" for available commands or start with DCF(AAPL), PORTFOLIO([AAPL,MSFT], [0.5,0.5])',timestamp:new Date}]),[c,l]=a.useState(""),[d,m]=a.useState([]),[u,p]=a.useState(!1),[h,g]=a.useState(0),[y,S]=a.useState(!1),v=a.useRef(null),A=a.useRef(null),x=a.useRef(b);a.useEffect(()=>{v.current&&(v.current.scrollTop=v.current.scrollHeight)},[i]),a.useEffect(()=>{A.current&&A.current.focus();(async()=>{try{await C.initialize()}catch(e){}})()},[]);const E=async()=>{if(!c.trim())return;const e={id:i.length+1,type:"user",content:c,timestamp:new Date};o(t=>[...t,e]),S(!0),l(""),p(!1);try{const e={demoMode:r.demoMode,showLoading:e=>{const t={id:i.length+2,type:"info",content:e,timestamp:new Date};o(e=>[...e,t])}},t=await x.current.processCommand(c,e);if("clear"===t.action)return void o([{id:1,type:"system",content:"Terminal cleared",timestamp:new Date}]);const a={id:i.length+2,type:t.type,content:t.content,timestamp:new Date,data:t.data};o(e=>[...e,a]),n&&n(c,t)}catch(t){const e={id:i.length+2,type:"error",content:`Error: ${t.message}`,timestamp:new Date};o(t=>[...t,e])}finally{S(!1)}};return e.jsxs("div",{className:"flex flex-col h-full bg-gray-900 text-green-400 font-mono text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-800 border-b border-gray-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(t,{name:"Terminal",size:16,className:"text-green-400"}),e.jsx("span",{className:"text-green-400 font-medium",children:"Financial Terminal"}),e.jsx("span",{className:"text-xs text-blue-400",children:"â€¢ Enhanced Command Suite"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full "+(y?"bg-yellow-400 animate-pulse":"bg-green-400")}),e.jsx("span",{className:"text-xs text-gray-400",children:y?"Processing...":"Connected"})]})]}),e.jsxs("div",{ref:v,className:"flex-1 overflow-y-auto p-4 space-y-2",onClick:()=>A.current?.focus(),children:[i.map(a=>e.jsx("div",{className:"space-y-1",children:e.jsxs("div",{className:"flex items-start space-x-2",children:["user"===a.type&&e.jsx("span",{className:"text-blue-400 shrink-0",children:"analyst@finpro:~$"}),"system"===a.type&&e.jsx(t,{name:"Info",size:14,className:"text-yellow-400 mt-0.5 shrink-0"}),"success"===a.type&&e.jsx(t,{name:"CheckCircle",size:14,className:"text-green-400 mt-0.5 shrink-0"}),"error"===a.type&&e.jsx(t,{name:"XCircle",size:14,className:"text-red-400 mt-0.5 shrink-0"}),"warning"===a.type&&e.jsx(t,{name:"AlertTriangle",size:14,className:"text-yellow-400 mt-0.5 shrink-0"}),"info"===a.type&&e.jsx(t,{name:"Info",size:14,className:"text-blue-400 mt-0.5 shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("pre",{className:"whitespace-pre-wrap break-words",children:a.content}),a.data&&e.jsx("div",{className:"mt-2 p-2 bg-gray-800 rounded border border-gray-700",children:e.jsxs("div",{className:"text-xs text-gray-400",children:["Real-time calculation data available â€¢ Analysis:"," ",a.data.analysis||"financial"]})})]})]})},a.id)),y&&e.jsxs("div",{className:"flex items-center space-x-2 text-yellow-400",children:[e.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-yellow-400 border-t-transparent rounded-full"}),e.jsx("span",{children:"Processing command..."})]}),e.jsxs("div",{className:"flex items-center space-x-2 relative",children:[e.jsx("span",{className:"text-blue-400 shrink-0",children:"analyst@finpro:~$"}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("input",{ref:A,type:"text",value:c,onChange:e=>{const t=e.target.value;if(l(t),t.length>0){const e=f.getAllCommands().map(e=>{const t=f.getCommandInfo(e);return t?t.usage:e}),a=f.getSuggestions(t).map(e=>e.usage),n=e.filter(e=>e.toLowerCase().includes(t.toLowerCase())&&!a.includes(e)),s=[...a,...n];m(s.slice(0,8)),p(s.length>0),g(0)}else p(!1)},onKeyDown:e=>{"Enter"===e.key?(e.preventDefault(),E()):"ArrowUp"===e.key&&u?(e.preventDefault(),g(e=>Math.max(0,e-1))):"ArrowDown"===e.key&&u?(e.preventDefault(),g(e=>Math.min(d.length-1,e+1))):"Tab"===e.key&&u?(e.preventDefault(),l(d[h]),p(!1)):"Escape"===e.key&&p(!1)},className:"w-full bg-transparent text-green-400 outline-none border-none",placeholder:"Enter command (e.g., DCF(AAPL), PORTFOLIO([AAPL,MSFT], [0.5,0.5]))...",autoComplete:"off",disabled:y}),u&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-gray-800 border border-gray-600 rounded-md shadow-lg z-10 max-h-48 overflow-y-auto",children:d.map((t,a)=>e.jsx("div",{className:"px-3 py-2 cursor-pointer text-sm "+(a===h?"bg-gray-700 text-green-400":"text-gray-300 hover:bg-gray-700"),onClick:()=>(e=>{l(e),p(!1),A.current?.focus()})(t),children:t},a))})]})]})]})]})},Y=({onVariableChange:s,onBulkEdit:r})=>{const[i,o]=a.useState("assumptions"),[c,l]=a.useState(!1),[d,m]=a.useState(""),[u,p]=a.useState({assumptions:{revenue_growth:{value:.052,unit:"%",description:"Annual revenue growth rate",category:"Growth"},ebitda_margin:{value:.235,unit:"%",description:"EBITDA as % of revenue",category:"Profitability"},tax_rate:{value:.25,unit:"%",description:"Corporate tax rate",category:"Tax"},capex_revenue:{value:.035,unit:"%",description:"CapEx as % of revenue",category:"Investment"},working_capital_revenue:{value:.02,unit:"%",description:"Working capital as % of revenue",category:"Working Capital"},terminal_growth:{value:.025,unit:"%",description:"Long-term growth rate",category:"Terminal"}},cost_of_capital:{risk_free_rate:{value:.032,unit:"%",description:"Risk-free rate (10Y Treasury)",category:"Market"},market_premium:{value:.065,unit:"%",description:"Equity risk premium",category:"Market"},beta:{value:1.15,unit:"x",description:"Asset beta coefficient",category:"Risk"},cost_of_debt:{value:.045,unit:"%",description:"Pre-tax cost of debt",category:"Debt"},debt_equity_ratio:{value:.4,unit:"x",description:"Target debt-to-equity ratio",category:"Capital Structure"}},market_data:{current_share_price:{value:125.5,unit:"$",description:"Current trading price",category:"Market"},shares_outstanding:{value:20,unit:"M",description:"Shares outstanding",category:"Equity"},market_cap:{value:2510,unit:"$M",description:"Current market capitalization",category:"Valuation"},enterprise_value:{value:2810,unit:"$M",description:"Current enterprise value",category:"Valuation"},net_debt:{value:300,unit:"$M",description:"Net debt position",category:"Debt"}}}),h=(e,t)=>"%"===t?(100*e).toFixed(1):"$"===t||"$M"===t?e.toFixed(2):e.toFixed(3),g=e=>{if(!d)return e;const t={};return Object.entries(e).forEach(([e,a])=>{(e.toLowerCase().includes(d.toLowerCase())||a.description.toLowerCase().includes(d.toLowerCase()))&&(t[e]=a)}),t};return e.jsxs("div",{className:"flex flex-col h-full bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(t,{name:"Sliders",size:20,className:"text-primary"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Variable Inputs"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(n,{variant:"outline",size:"sm",iconName:c?"Check":"Edit",onClick:()=>l(!c),children:c?"Done":"Edit"}),e.jsx(n,{variant:"outline",size:"sm",iconName:"Download",onClick:()=>{const e=JSON.stringify(u,null,2),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download="model_variables.json",n.click(),URL.revokeObjectURL(a)},children:"Export"})]})]}),e.jsx("div",{className:"p-4 border-b border-border",children:e.jsxs("div",{className:"relative",children:[e.jsx(t,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground"}),e.jsx("input",{type:"text",value:d,onChange:e=>m(e.target.value),placeholder:"Search variables...",className:"w-full pl-10 pr-4 py-2 bg-input border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"})]})}),e.jsx("div",{className:"flex border-b border-border overflow-x-auto",children:[{id:"assumptions",label:"Key Assumptions",icon:"Settings"},{id:"cost_of_capital",label:"Cost of Capital",icon:"Percent"},{id:"market_data",label:"Market Data",icon:"TrendingUp"}].map(a=>e.jsxs("button",{onClick:()=>o(a.id),className:"flex items-center space-x-2 px-4 py-3 text-sm font-medium whitespace-nowrap transition-smooth "+(i===a.id?"bg-primary text-primary-foreground border-b-2 border-primary":"text-muted-foreground hover:text-foreground hover:bg-muted"),children:[e.jsx(t,{name:a.icon,size:16}),e.jsx("span",{children:a.label})]},a.id))}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[Object.entries((e=>{const t={};return Object.entries(e).forEach(([e,a])=>{const n=a.category||"Other";t[n]||(t[n]=[]),t[n].push({key:e,...a})}),t})(g(u[i]))).map(([a,n])=>e.jsxs("div",{className:"mb-6",children:[e.jsxs("h4",{className:"text-sm font-medium text-foreground mb-3 flex items-center space-x-2",children:[e.jsx(t,{name:"Folder",size:16}),e.jsx("span",{children:a})]}),e.jsx("div",{className:"space-y-3",children:n.map(a=>e.jsxs("div",{className:"p-3 bg-background border border-border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-sm font-medium text-foreground capitalize",children:a.key.replace(/_/g," ")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a.description})]}),e.jsx("div",{className:"flex items-center space-x-2 ml-4",children:c?e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("input",{type:"number",value:h(a.value,a.unit),onChange:e=>((e,t,a)=>{const n={...u,[e]:{...u[e],[t]:{...u[e][t],value:parseFloat(a)||0}}};p(n),s&&s(e,t,a)})(i,a.key,e.target.value),step:"%"===a.unit?"0.1":"0.01",className:"w-20 px-2 py-1 text-sm bg-input border border-border rounded text-foreground focus:outline-none focus:ring-1 focus:ring-ring"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:a.unit})]}):e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-lg font-semibold text-foreground",children:h(a.value,a.unit)}),e.jsx("span",{className:"text-sm text-muted-foreground ml-1",children:a.unit})]})})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-2 h-2 bg-success rounded-full"}),e.jsx("span",{className:"text-muted-foreground",children:"Within range"})]}),e.jsxs("div",{className:"flex items-center space-x-1 text-muted-foreground",children:[e.jsx(t,{name:"TrendingUp",size:12}),e.jsx("span",{children:"High impact"})]})]})]},a.key))})]},a)),0===Object.keys(g(u[i])).length&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(t,{name:"Search",size:48,className:"text-muted-foreground mx-auto mb-4"}),e.jsx("h4",{className:"text-lg font-medium text-foreground mb-2",children:"No variables found"}),e.jsx("p",{className:"text-muted-foreground",children:"Try adjusting your search terms"})]})]}),e.jsx("div",{className:"p-4 border-t border-border bg-muted/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-xs text-muted-foreground",children:[e.jsx(t,{name:"Info",size:12}),e.jsx("span",{children:"Changes auto-save every 30 seconds"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(n,{variant:"outline",size:"sm",iconName:"RotateCcw",onClick:()=>{const e={...u};p(e)},children:"Reset"}),e.jsx(n,{variant:"outline",size:"sm",iconName:"Grid",onClick:()=>r&&r(),children:"Bulk Edit"})]})]})})]})},q=()=>{const[r,i]=a.useState("dual-pane"),[o,c]=a.useState("terminal"),[l,d]=a.useState("results"),[m,u]=a.useState(!1),[f,S]=a.useState({name:"DCF_Analysis_v2.3",saved:!0,calculating:!1,lastSaved:new Date}),[v,A]=a.useState(null),x=(e,t)=>{A(t)};return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white",children:[e.jsx(s,{}),e.jsxs("div",{className:"flex flex-col h-screen pt-16",children:[e.jsxs("div",{className:"bg-gray-800 border-b border-gray-700 px-4 py-2 flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center space-x-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(t,{name:"FileText",className:"w-5 h-5 text-blue-400"}),e.jsx("span",{className:"font-medium",children:f.name}),e.jsx("span",{className:"text-xs px-2 py-1 rounded "+(f.saved?"bg-green-900 text-green-300":"bg-yellow-900 text-yellow-300"),children:f.saved?"Saved":"Unsaved"})]})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex items-center space-x-1 bg-gray-700 rounded-lg p-1",children:[e.jsx(n,{variant:"single-pane"===r?"primary":"ghost",size:"sm",onClick:()=>i("single-pane"),"aria-label":"Single-pane layout",children:e.jsx(t,{name:"Square",className:"w-4 h-4"})}),e.jsx(n,{variant:"dual-pane"===r?"primary":"ghost",size:"sm",onClick:()=>i("dual-pane"),"aria-label":"Dual-pane layout",children:e.jsx(t,{name:"Columns",className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsxs("select",{value:o,onChange:e=>c(e.target.value),className:"bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm","aria-label":"Select left panel content",children:[e.jsx("option",{value:"terminal",children:"Terminal"}),e.jsx("option",{value:"variables",children:"Variables"}),e.jsx("option",{value:"formulas",children:"Formulas"}),e.jsx("option",{value:"templates",children:"Templates"})]}),"dual-pane"===r&&e.jsxs("select",{value:l,onChange:e=>d(e.target.value),className:"bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm","aria-label":"Select right panel content",children:[e.jsx("option",{value:"results",children:"Results"}),e.jsx("option",{value:"audit",children:"Audit Trail"})]})]})]})]}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:("dual-pane"===r?"w-1/2":"w-full")+" border-r border-gray-700 overflow-hidden",children:(()=>{switch(o){case"terminal":default:return e.jsx(B,{onCommandExecute:x,calculationResults:v});case"variables":return e.jsx(Y,{});case"formulas":return e.jsx(g,{});case"templates":return e.jsx(y,{})}})()}),"dual-pane"===r&&e.jsx("div",{className:"w-1/2 overflow-hidden",children:(()=>{switch(l){case"results":default:return e.jsx(h,{results:v});case"audit":return e.jsx(p,{})}})()})]})]})]})};export{q as default};
//# sourceMappingURL=index-tmG1enbM.js.map
